import{_ as Te,f as F,c as q,d as O,O as $e,g as Y,X as pe,au as Vi,e as ue,w as ne,n as he,a1 as je,b as W,t as J,F as Re,r as mt,u as N,ax as $i,l as G,a0 as Hn,y as qe,U as Ce,a2 as gn,bv as Bi,bw as Hi,a9 as Pe,K as Ve,a7 as Wn,$ as Wi,A as Ot,a5 as qn,Y as Lt,i as H,z as ke,aC as Gn,bx as zn,L as dt,M as ft,C as Jn,B as ie,S as qi,T as Gi,a3 as Ne,aa as $t,o as zi,aw as Ie,a4 as Bt,G as Ae,V as Pt,W as Qn,N as pt,ay as Kn,a as Xn,ag as Ji,af as Qi,ab as Ki}from"./index-69690053.js";import{u as ze,D as jt,a as He,k as Xi,l as Zi,j as Yi,C as er,_ as yn,x as tr}from"./index-d7cc16ab.js";import{g as nr,_ as Zn}from"./settings-582196d0.js";import{i as Ge,s as ir,m as rr,_ as or,t as xt,g as bn,e as Xe,E as Yn}from"./DragVerticalIcon-fa78fa9d.js";import{j as at,g as wn,u as ei,c as Ue,q as Ht,s as Ze,a as ar,h as Ye}from"./modals-062b592e.js";import{g as Wt}from"./global-9f2067e0.js";import{N as ti,_ as sr}from"./NoteModal-cfd9dde1.js";import{P as we}from"./PhoneIcon-414bed0f.js";import{A as cr}from"./ArrowUpRightIcon-5c6e5302.js";import{A as At}from"./AvatarIcon-2b83cd19.js";import{T as lr}from"./TaskIcon-684f3614.js";import{_ as ur}from"./Link-f750ab7e.js";import{u as dr}from"./helpCenter-6956e896.js";import{F as qt,_ as fr,s as et,a as pr,b as hr,d as vr}from"./FieldLayout-75a1161d.js";const _r={},mr={width:"300",height:"300",viewBox:"0 0 300 300",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function gr(t,n){return F(),q("svg",mr,[...n[0]||(n[0]=[O("path",{d:"M214.286 0H85.7143C38.3756 0 0 38.3756 0 85.7143V214.286C0 261.624 38.3756 300 85.7143 300H214.286C261.624 300 300 261.624 300 214.286V85.7143C300 38.3756 261.624 0 214.286 0Z",fill:"#EF0BF5"},null,-1),O("path",{d:"M64.2141 90.301V111.862H214.339V140.214L160.187 193.146V208.993L139.705 208.885V193.146L85.6605 140.214H64.2141V149.269L118.259 202.202V230.23L181.634 230.769V202.202L235.786 149.269V90.301H64.2141Z",fill:"white"},null,-1)])])}const ni=Te(_r,[["render",gr]]),yr={key:0},br=["src"],wr={__name:"BrandLogo",props:{modelValue:{},modelModifiers:{}},emits:["update:modelValue"],setup(t){const n=$e(t,"modelValue");return(e,i)=>{var r;return(r=n.value)!=null&&r.logo?(F(),q("div",yr,[O("img",{src:n.value.logo,class:"h-full w-full object-cover"},null,8,br)])):(F(),Y(ni,{key:1,class:"size-8 shrink-0 rounded"}))}}},Sr={},Cr={width:"32",height:"32",viewBox:"0 0 32 32",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function kr(t,n){return F(),q("svg",Cr,[...n[0]||(n[0]=[O("rect",{x:"0.75",y:"0.75",width:"30.5",height:"30.5",rx:"6.25",stroke:"currentColor","stroke-width":"1.5"},null,-1),O("path",{d:"M24.5011 14.1124C23.3954 12.4873 21.532 11.5477 19.594 11.6747C18.7616 10.1384 17.2211 9.12267 15.4198 9.0084C14.1651 8.93222 12.8979 9.3766 11.9165 10.24C11.2456 10.8367 10.7611 11.5223 10.463 12.2968C10.289 12.7539 9.89151 13.0459 9.46912 13.0459H6.5V15.5852H9.46912C10.9226 15.5852 12.2271 14.6584 12.7737 13.2237C12.9227 12.8301 13.1712 12.4873 13.5439 12.1571C14.0284 11.7255 14.662 11.4969 15.2583 11.535C16.1528 11.5985 16.7863 12.0175 17.1839 12.538C17.6063 13.0205 17.8423 13.7696 17.979 14.5187C18.774 14.2902 19.6437 14.0997 20.476 14.2394C21.1593 14.3536 21.7929 14.7218 22.2525 15.2678C22.327 15.3567 22.4016 15.4456 22.4637 15.5471C23.06 16.4232 23.1718 17.5024 22.7743 18.5689C22.414 19.5592 21.0847 20.4607 19.9791 20.4607H11.3326C10.1524 20.4607 9.18339 19.5592 9.03432 18.4038H6.54969C6.71119 20.9686 8.78585 23 11.3326 23H19.9915C22.1283 23 24.3769 21.451 25.1098 19.4704C25.7931 17.6167 25.5695 15.6614 24.5135 14.0997L24.5011 14.1124Z",fill:"currentColor"},null,-1)])])}const Tr=Te(Sr,[["render",kr]]),Er={},Ir={fill:"none",height:"16",viewBox:"0 0 16 16",width:"16",xmlns:"http://www.w3.org/2000/svg"};function Pr(t,n){return F(),q("svg",Ir,[...n[0]||(n[0]=[O("path",{class:"","clip-rule":"evenodd",d:"M13.8496 4.69692L12.0062 6.54029C11.8109 6.73555 11.4944 6.73555 11.2991 6.54028L9.45572 4.69692C9.26046 4.50166 9.26046 4.18508 9.45572 3.98981L11.2991 2.14645C11.4944 1.95118 11.8109 1.95118 12.0062 2.14645L13.8496 3.98981C14.0448 4.18507 14.0448 4.50166 13.8496 4.69692ZM14.5567 3.28271C15.1425 3.86849 15.1425 4.81824 14.5567 5.40403L12.7133 7.24739C12.1275 7.83318 11.1778 7.83318 10.592 7.24739L8.74862 5.40402C8.16283 4.81824 8.16283 3.86849 8.74862 3.28271L10.592 1.43934C11.1778 0.853553 12.1275 0.853554 12.7133 1.43934L14.5567 3.28271ZM5.60691 4.34338C5.60691 5.3394 4.79948 6.14683 3.80346 6.14683C2.80743 6.14683 2 5.3394 2 4.34338C2 3.34736 2.80743 2.53992 3.80346 2.53992C4.79948 2.53992 5.60691 3.34736 5.60691 4.34338ZM6.60691 4.34338C6.60691 5.89168 5.35176 7.14683 3.80346 7.14683C2.25515 7.14683 1 5.89168 1 4.34338C1 2.79507 2.25515 1.53992 3.80346 1.53992C5.35176 1.53992 6.60691 2.79507 6.60691 4.34338ZM12.9565 10.3897H10.3495C10.0734 10.3897 9.84954 10.6136 9.84954 10.8897V13.4966C9.84954 13.7728 10.0734 13.9966 10.3495 13.9966H12.9565C13.2326 13.9966 13.4565 13.7728 13.4565 13.4966V10.8897C13.4565 10.6136 13.2326 10.3897 12.9565 10.3897ZM10.3495 9.38971C9.52112 9.38971 8.84954 10.0613 8.84954 10.8897V13.4966C8.84954 14.325 9.52111 14.9966 10.3495 14.9966H12.9565C13.7849 14.9966 14.4565 14.325 14.4565 13.4966V10.8897C14.4565 10.0613 13.7849 9.38971 12.9565 9.38971H10.3495ZM2.5 10.3897H5.10691C5.38305 10.3897 5.60691 10.6136 5.60691 10.8897V13.4966C5.60691 13.7728 5.38306 13.9966 5.10691 13.9966H2.5C2.22386 13.9966 2 13.7728 2 13.4966V10.8897C2 10.6136 2.22386 10.3897 2.5 10.3897ZM1 10.8897C1 10.0613 1.67157 9.38971 2.5 9.38971H5.10691C5.93534 9.38971 6.60691 10.0613 6.60691 10.8897V13.4966C6.60691 14.325 5.93534 14.9966 5.10691 14.9966H2.5C1.67157 14.9966 1 14.325 1 13.4966V10.8897Z",fill:"currentColor","fill-rule":"evenodd"},null,-1)])])}const xr=Te(Er,[["render",Pr]]),Ar=["onClick"],Rr={class:"flex gap-2"},Dr={class:"whitespace-nowrap"},Mr={class:"flex w-fit mx-2 min-w-32 max-w-48 flex-col rounded-lg border border-outline-gray-2 bg-surface-white p-1.5 text-sm text-ink-gray-8 shadow-xl auto-fill-[100px]"},Or=["href"],Lr=["src"],jr={class:"max-w-18 w-full truncate"},Ur={__name:"Apps",props:{active:Boolean},setup(t){const n=pe({url:"frappe.apps.get_apps",cache:"apps",auto:!0,transform:e=>{let i=[{name:"frappe",logo:"/assets/frappe/images/framework.png",title:__("Desk"),route:"/app"}];return e.map(r=>{r.name!=="crm"&&i.push({name:r.name,logo:r.logo,title:__(r.title),route:r.route})}),i}});return Vi(()=>{}),(e,i)=>{const r=ue("FeatherIcon");return F(),Y(N($i),{placement:"right-start",trigger:"hover",hoverDelay:.1,leaveDelay:.1},{target:ne(({togglePopover:o})=>[O("button",{class:he([t.active?"bg-surface-gray-3":"text-ink-gray-6","group w-full flex h-7 items-center justify-between rounded px-2 text-base hover:bg-surface-gray-2"]),onClick:je(c=>o(),["prevent"])},[O("div",Rr,[W(xr,{class:"size-4"}),O("span",Dr,J(e.__("Apps")),1)]),W(r,{name:"chevron-right",class:"size-4 text-ink-gray-5"})],10,Ar)]),body:ne(()=>[O("div",Mr,[(F(!0),q(Re,null,mt(N(n).data,o=>(F(),q("a",{href:o.route,key:"name",class:"flex items-center gap-2 rounded p-1.5 hover:bg-surface-gray-2"},[O("img",{class:"size-6",src:o.logo},null,8,Lr),O("span",jr,J(o.title),1)],8,Or))),128))])]),_:1})}}},ii=G("https://frappecloud.com"),ri=G(""),Nr=pe({url:"frappe.integrations.frappe_providers.frappecloud_billing.current_site_info",cache:"currentSiteInfo",onSuccess:t=>{ii.value=t.base_url,ri.value=t.site_name}}),Fr=()=>{Nr.fetch();const{$dialog:t}=Wt();t({title:__("Login to Frappe Cloud?"),message:__("Are you sure you want to login to your Frappe Cloud dashboard?"),actions:[{label:__("Confirm"),variant:"solid",onClick(n){Vr(),n()}}]})},Vr=()=>{window.open(`${ii.value}/dashboard/sites/${ri.value}`,"_blank")},$r={class:"text-base font-medium leading-none text-ink-gray-9 truncate"},Br={class:"mt-1 text-sm leading-none text-ink-gray-7 truncate"},Vl={__name:"UserDropdown",props:{isCollapsed:{type:Boolean,default:!1}},setup(t){const{settings:n,brand:e}=nr(),{logout:i}=Hn(),{getUser:r}=ze(),o=qe(()=>r()||{}),c=qe(()=>{var v;if(!((v=n.value)!=null&&v.dropdown_items))return[];let I=n.value.dropdown_items,D=[{group:"Dropdown Items",hideLabel:!0,items:[]}];return I.forEach(p=>{p.hidden||(p.type!=="Separator"?D[D.length-1].items.push(y(p)):D.push({group:"",hideLabel:!0,items:[]}))}),D});function y(I){let D=JSON.parse(JSON.stringify(I)),v=D.icon||"external-link";return typeof v=="string"&&v.startsWith("<svg")&&(v=Ce(gn("div",{innerHTML:v}))),D.icon=v,D.is_standard?P(D):{icon:D.icon,label:__(D.label),onClick:()=>window.open(D.route,D.open_in_new_window?"_blank":"")}}function P(I){switch(I.name1){case"app_selector":return{component:Ce(Ur)};case"toggle_theme":return{icon:Bi.value==="dark"?"sun":I.icon,label:__(I.label),onClick:Hi};case"settings":return{icon:I.icon,label:__(I.label),onClick:()=>ir.value=!0,condition:()=>!Ge.value};case"login_to_fc":return{icon:gn(Tr),label:__(I.label),onClick:()=>Fr(),condition:()=>!Ge.value&&window.is_fc_site};case"about":return{icon:I.icon,label:__(I.label),onClick:()=>at.value=!0};case"logout":return{icon:I.icon,label:__(I.label),onClick:()=>i.submit()}}}return(I,D)=>{const v=ue("FeatherIcon");return F(),Y(N(jt),Ve({options:c.value},I.$attrs),{default:ne(({open:p})=>[O("button",{class:he(["flex h-12 items-center rounded-md py-2 duration-300 ease-in-out",t.isCollapsed?"w-auto px-0":p?"w-52 bg-surface-white px-2 shadow-sm":"w-52 px-2 hover:bg-surface-gray-3"])},[W(wr,{modelValue:N(e),"onUpdate:modelValue":D[0]||(D[0]=m=>Pe(e)?e.value=m:null),class:"h-8 max-w-16 flex-shrink-0"},null,8,["modelValue"]),O("div",{class:he(["flex flex-1 flex-col text-left duration-300 ease-in-out truncate",t.isCollapsed?"ml-0 w-0 overflow-hidden opacity-0":"ml-2 w-auto opacity-100"])},[O("div",$r,J(I.__(N(e).name||"CRM")),1),O("div",Br,J(o.value.full_name),1)],2),O("div",{class:he(["duration-300 ease-in-out",t.isCollapsed?"ml-0 w-0 overflow-hidden opacity-0":"ml-2 w-auto opacity-100"])},[W(v,{name:"chevron-down",class:"size-4 text-ink-gray-5","aria-hidden":"true"})],2)],2)]),_:1},16,["options"])}}},Hr={class:"flex items-center truncate"},Wr={class:"grid flex-shrink-0 place-items-center"},$l={__name:"SidebarLink",props:{icon:{type:[Object,String,Function]},label:{type:String,default:""},to:{type:[Object,String],default:""},isCollapsed:{type:Boolean,default:!1}},setup(t){const n=Wn(),e=Wi(),i=t;function r(){i.to&&(typeof i.to=="object"?n.push(i.to):n.push({name:i.to}),Ge.value&&(rr.value=!1))}let o=qe(()=>{var c,y;return e.query.view?e.query.view==((y=(c=i.to)==null?void 0:c.query)==null?void 0:y.view):e.name===i.to});return(c,y)=>{const P=ue("FeatherIcon");return F(),q("button",{class:he(["flex h-7 cursor-pointer items-center rounded text-ink-gray-7 duration-300 ease-in-out focus:outline-none focus:transition-none focus-visible:rounded focus-visible:ring-2 focus-visible:ring-outline-gray-3",N(o)?"bg-surface-selected shadow-sm":"hover:bg-surface-gray-2"]),onClick:r},[O("div",{class:he(["flex w-full items-center justify-between duration-300 ease-in-out",t.isCollapsed?"ml-[3px] p-1":"px-2 py-1"])},[O("div",Hr,[W(N(Lt),{text:t.label,placement:"right",disabled:!t.isCollapsed},{default:ne(()=>[Ot(c.$slots,"icon",{},()=>[O("span",Wr,[typeof t.icon=="string"?(F(),Y(P,{key:0,name:t.icon,class:"size-4 text-ink-gray-7"},null,8,["name"])):(F(),Y(qn(t.icon),{key:1,class:"size-4 text-ink-gray-7"}))])])]),_:3},8,["text","disabled"]),W(N(Lt),{text:t.label,placement:"right",disabled:t.isCollapsed,hoverDelay:1.5},{default:ne(()=>[O("span",{class:he(["flex-1 flex-shrink-0 truncate text-sm duration-300 ease-in-out",t.isCollapsed?"ml-0 w-0 overflow-hidden opacity-0":"ml-2 w-auto opacity-100"])},J(t.label),3)]),_:1},8,["text","disabled"])]),Ot(c.$slots,"right")],2)],2)}}},qr={},Gr={xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round",class:"feather feather-minimize-2"};function zr(t,n){return F(),q("svg",Gr,[...n[0]||(n[0]=[O("polyline",{points:"4 14 10 14 10 20"},null,-1),O("polyline",{points:"20 10 14 10 14 4"},null,-1),O("line",{x1:"14",y1:"10",x2:"21",y2:"3"},null,-1),O("line",{x1:"3",y1:"21",x2:"10",y2:"14"},null,-1)])])}const oi=Te(qr,[["render",zr]]),ai={__name:"CountUpTimer",setup(t,{expose:n}){const e=G(0),i=G(0),r=G(0),o=G(null),c=G("0:00");function y(){c.value=D()}function P(){o.value=setInterval(()=>y(),1e3)}function I(){clearInterval(o.value);let v=c.value;return e.value=0,i.value=0,r.value=0,c.value="0:00",v}function D(v=0){v&&(typeof v=="string"&&(v=parseInt(v)),r.value=v,r.value>=60?(i.value=Math.floor(r.value/60),r.value=r.value%60):i.value=0,i.value>=60?(e.value=Math.floor(i.value/60),i.value=i.value%60):e.value=0),r.value===59&&(r.value=0,i.value=i.value+1,r.value--),i.value===60&&(i.value=0,e.value=e.value+1),r.value++;let p=i.value,m=r.value<10?"0"+r.value:r.value,s=e.value>0?e.value+":":"";return s&&(p=p<10?"0"+p:p,m=m<10?"0"+m:m,p===0&&(p="00")),s+p+":"+m}return n({start:P,stop:I,getTime:D,updatedTime:c}),(v,p)=>Ot(v.$slots,"default")}};var si={},tt={},Gt={exports:{}},Fe=typeof Reflect=="object"?Reflect:null,Sn=Fe&&typeof Fe.apply=="function"?Fe.apply:function(n,e,i){return Function.prototype.apply.call(n,e,i)},st;Fe&&typeof Fe.ownKeys=="function"?st=Fe.ownKeys:Object.getOwnPropertySymbols?st=function(n){return Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n))}:st=function(n){return Object.getOwnPropertyNames(n)};function Jr(t){console&&console.warn&&console.warn(t)}var ci=Number.isNaN||function(n){return n!==n};function te(){te.init.call(this)}Gt.exports=te;Gt.exports.once=Zr;te.EventEmitter=te;te.prototype._events=void 0;te.prototype._eventsCount=0;te.prototype._maxListeners=void 0;var Cn=10;function gt(t){if(typeof t!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}Object.defineProperty(te,"defaultMaxListeners",{enumerable:!0,get:function(){return Cn},set:function(t){if(typeof t!="number"||t<0||ci(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");Cn=t}});te.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};te.prototype.setMaxListeners=function(n){if(typeof n!="number"||n<0||ci(n))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+n+".");return this._maxListeners=n,this};function li(t){return t._maxListeners===void 0?te.defaultMaxListeners:t._maxListeners}te.prototype.getMaxListeners=function(){return li(this)};te.prototype.emit=function(n){for(var e=[],i=1;i<arguments.length;i++)e.push(arguments[i]);var r=n==="error",o=this._events;if(o!==void 0)r=r&&o.error===void 0;else if(!r)return!1;if(r){var c;if(e.length>0&&(c=e[0]),c instanceof Error)throw c;var y=new Error("Unhandled error."+(c?" ("+c.message+")":""));throw y.context=c,y}var P=o[n];if(P===void 0)return!1;if(typeof P=="function")Sn(P,this,e);else for(var I=P.length,D=hi(P,I),i=0;i<I;++i)Sn(D[i],this,e);return!0};function ui(t,n,e,i){var r,o,c;if(gt(e),o=t._events,o===void 0?(o=t._events=Object.create(null),t._eventsCount=0):(o.newListener!==void 0&&(t.emit("newListener",n,e.listener?e.listener:e),o=t._events),c=o[n]),c===void 0)c=o[n]=e,++t._eventsCount;else if(typeof c=="function"?c=o[n]=i?[e,c]:[c,e]:i?c.unshift(e):c.push(e),r=li(t),r>0&&c.length>r&&!c.warned){c.warned=!0;var y=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+String(n)+" listeners added. Use emitter.setMaxListeners() to increase limit");y.name="MaxListenersExceededWarning",y.emitter=t,y.type=n,y.count=c.length,Jr(y)}return t}te.prototype.addListener=function(n,e){return ui(this,n,e,!1)};te.prototype.on=te.prototype.addListener;te.prototype.prependListener=function(n,e){return ui(this,n,e,!0)};function Qr(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function di(t,n,e){var i={fired:!1,wrapFn:void 0,target:t,type:n,listener:e},r=Qr.bind(i);return r.listener=e,i.wrapFn=r,r}te.prototype.once=function(n,e){return gt(e),this.on(n,di(this,n,e)),this};te.prototype.prependOnceListener=function(n,e){return gt(e),this.prependListener(n,di(this,n,e)),this};te.prototype.removeListener=function(n,e){var i,r,o,c,y;if(gt(e),r=this._events,r===void 0)return this;if(i=r[n],i===void 0)return this;if(i===e||i.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete r[n],r.removeListener&&this.emit("removeListener",n,i.listener||e));else if(typeof i!="function"){for(o=-1,c=i.length-1;c>=0;c--)if(i[c]===e||i[c].listener===e){y=i[c].listener,o=c;break}if(o<0)return this;o===0?i.shift():Kr(i,o),i.length===1&&(r[n]=i[0]),r.removeListener!==void 0&&this.emit("removeListener",n,y||e)}return this};te.prototype.off=te.prototype.removeListener;te.prototype.removeAllListeners=function(n){var e,i,r;if(i=this._events,i===void 0)return this;if(i.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):i[n]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete i[n]),this;if(arguments.length===0){var o=Object.keys(i),c;for(r=0;r<o.length;++r)c=o[r],c!=="removeListener"&&this.removeAllListeners(c);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=i[n],typeof e=="function")this.removeListener(n,e);else if(e!==void 0)for(r=e.length-1;r>=0;r--)this.removeListener(n,e[r]);return this};function fi(t,n,e){var i=t._events;if(i===void 0)return[];var r=i[n];return r===void 0?[]:typeof r=="function"?e?[r.listener||r]:[r]:e?Xr(r):hi(r,r.length)}te.prototype.listeners=function(n){return fi(this,n,!0)};te.prototype.rawListeners=function(n){return fi(this,n,!1)};te.listenerCount=function(t,n){return typeof t.listenerCount=="function"?t.listenerCount(n):pi.call(t,n)};te.prototype.listenerCount=pi;function pi(t){var n=this._events;if(n!==void 0){var e=n[t];if(typeof e=="function")return 1;if(e!==void 0)return e.length}return 0}te.prototype.eventNames=function(){return this._eventsCount>0?st(this._events):[]};function hi(t,n){for(var e=new Array(n),i=0;i<n;++i)e[i]=t[i];return e}function Kr(t,n){for(;n+1<t.length;n++)t[n]=t[n+1];t.pop()}function Xr(t){for(var n=new Array(t.length),e=0;e<n.length;++e)n[e]=t[e].listener||t[e];return n}function Zr(t,n){return new Promise(function(e,i){function r(c){t.removeListener(n,o),i(c)}function o(){typeof t.removeListener=="function"&&t.removeListener("error",r),e([].slice.call(arguments))}vi(t,n,o,{once:!0}),n!=="error"&&Yr(t,r,{once:!0})})}function Yr(t,n,e){typeof t.on=="function"&&vi(t,"error",n,e)}function vi(t,n,e,i){if(typeof t.on=="function")i.once?t.once(n,e):t.on(n,e);else if(typeof t.addEventListener=="function")t.addEventListener(n,function r(o){i.once&&t.removeEventListener(n,r),e(o)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t)}var me=Gt.exports,yt={},eo=H&&H.__extends||function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,r){i.__proto__=r}||function(i,r){for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(i[o]=r[o])},t(n,e)};return function(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");t(n,e);function i(){this.constructor=n}n.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}();Object.defineProperty(yt,"__esModule",{value:!0});var to=me,no=function(t){eo(n,t);function n(e){var i=t.call(this)||this;return Object.defineProperties(i,{_attempts:{value:0,writable:!0},_duration:{enumerable:!1,get:function(){var r=this._min*Math.pow(this._factor,this._attempts);if(this._jitter){var o=Math.random(),c=Math.floor(o*this._jitter*r);r=Math.floor(o*10)&1?r+c:r-c}return Math.min(r,this._max)|0}},_factor:{value:e.factor||2},_jitter:{value:e.jitter>0&&e.jitter<=1?e.jitter:0},_max:{value:e.max||1e4},_min:{value:e.min||100},_timeoutID:{value:null,writable:!0}}),i}return n.prototype.backoff=function(){var e=this,i=this._duration;this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=null),this.emit("backoff",this._attempts,i),this._timeoutID=setTimeout(function(){e.emit("ready",e._attempts,i),e._attempts++},i)},n.prototype.reset=function(){this._attempts=0,this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=null)},n}(to.EventEmitter);yt.default=no;var nt={},_i={exports:{}};(function(t){(function(n,e){t.exports?t.exports=e():n.log=e()})(H,function(){var n=function(){},e="undefined",i=typeof window!==e&&typeof window.navigator!==e&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function o(g,_){var d=g[_];if(typeof d.bind=="function")return d.bind(g);try{return Function.prototype.bind.call(d,g)}catch{return function(){return Function.prototype.apply.apply(d,[g,arguments])}}}function c(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function y(g){return g==="debug"&&(g="log"),typeof console===e?!1:g==="trace"&&i?c:console[g]!==void 0?o(console,g):console.log!==void 0?o(console,"log"):n}function P(g,_){for(var d=0;d<r.length;d++){var u=r[d];this[u]=d<g?n:this.methodFactory(u,g,_)}this.log=this.debug}function I(g,_,d){return function(){typeof console!==e&&(P.call(this,_,d),this[g].apply(this,arguments))}}function D(g,_,d){return y(g)||I.apply(this,arguments)}function v(g,_,d){var u=this,R,b="loglevel";g&&(b+=":"+g);function h(l){var $=(r[l]||"silent").toUpperCase();if(typeof window!==e){try{window.localStorage[b]=$;return}catch{}try{window.document.cookie=encodeURIComponent(b)+"="+$+";"}catch{}}}function w(){var l;if(typeof window!==e){try{l=window.localStorage[b]}catch{}if(typeof l===e)try{var $=window.document.cookie,T=$.indexOf(encodeURIComponent(b)+"=");T!==-1&&(l=/^([^;]+)/.exec($.slice(T))[1])}catch{}return u.levels[l]===void 0&&(l=void 0),l}}u.name=g,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=d||D,u.getLevel=function(){return R},u.setLevel=function(l,$){if(typeof l=="string"&&u.levels[l.toUpperCase()]!==void 0&&(l=u.levels[l.toUpperCase()]),typeof l=="number"&&l>=0&&l<=u.levels.SILENT){if(R=l,$!==!1&&h(l),P.call(u,l,g),typeof console===e&&l<u.levels.SILENT)return"No console available for logging"}else throw"log.setLevel() called with invalid level: "+l},u.setDefaultLevel=function(l){w()||u.setLevel(l,!1)},u.enableAll=function(l){u.setLevel(u.levels.TRACE,l)},u.disableAll=function(l){u.setLevel(u.levels.SILENT,l)};var L=w();L==null&&(L=_??"WARN"),u.setLevel(L,!1)}var p=new v,m={};p.getLogger=function(_){if(typeof _!="string"||_==="")throw new TypeError("You must supply a name when creating a logger.");var d=m[_];return d||(d=m[_]=new v(_,p.getLevel(),p.methodFactory)),d};var s=typeof window!==e?window.log:void 0;return p.noConflict=function(){return typeof window!==e&&window.log===p&&(window.log=s),p},p.getLoggers=function(){return m},p})})(_i);var mi=_i.exports,it={},ce={},gi={},zt={},io=H&&H.__extends||function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,r){i.__proto__=r}||function(i,r){for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(i[o]=r[o])},t(n,e)};return function(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");t(n,e);function i(){this.constructor=n}n.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}();Object.defineProperty(zt,"__esModule",{value:!0});var ro=function(t){io(n,t);function n(e,i){var r=t.call(this)||this;Object.setPrototypeOf(r,n.prototype);var o=typeof e=="string"?e:r.explanation,c=typeof e=="object"?e:i;return r.message="".concat(r.name," (").concat(r.code,"): ").concat(o),r.originalError=c,r}return n}(Error);zt.default=ro;(function(t){var n=H&&H.__extends||function(){var p=function(m,s){return p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,_){g.__proto__=_}||function(g,_){for(var d in _)Object.prototype.hasOwnProperty.call(_,d)&&(g[d]=_[d])},p(m,s)};return function(m,s){if(typeof s!="function"&&s!==null)throw new TypeError("Class extends value "+String(s)+" is not a constructor or null");p(m,s);function g(){this.constructor=m}m.prototype=s===null?Object.create(s):(g.prototype=s.prototype,new g)}}();Object.defineProperty(t,"__esModule",{value:!0}),t.errorsByCode=t.MediaErrors=t.SignalingErrors=t.UserMediaErrors=t.MalformedRequestErrors=t.GeneralErrors=t.SIPServerErrors=t.ClientErrors=t.SignatureValidationErrors=t.AuthorizationErrors=t.TwilioError=void 0;var e=zt;t.TwilioError=e.default;var i;(function(p){var m=function(_){n(d,_);function d(u,R){var b=_.call(this,u,R)||this;b.causes=[],b.code=20101,b.description="Invalid access token",b.explanation="Twilio was unable to validate your Access Token",b.name="AccessTokenInvalid",b.solutions=[],Object.setPrototypeOf(b,p.AccessTokenInvalid.prototype);var h=typeof u=="string"?u:b.explanation,w=typeof u=="object"?u:R;return b.message="".concat(b.name," (").concat(b.code,"): ").concat(h),b.originalError=w,b}return d}(e.default);p.AccessTokenInvalid=m;var s=function(_){n(d,_);function d(u,R){var b=_.call(this,u,R)||this;b.causes=[],b.code=20104,b.description="Access token expired or expiration date invalid",b.explanation="The Access Token provided to the Twilio API has expired, the expiration time specified in the token was invalid, or the expiration time specified was too far in the future",b.name="AccessTokenExpired",b.solutions=[],Object.setPrototypeOf(b,p.AccessTokenExpired.prototype);var h=typeof u=="string"?u:b.explanation,w=typeof u=="object"?u:R;return b.message="".concat(b.name," (").concat(b.code,"): ").concat(h),b.originalError=w,b}return d}(e.default);p.AccessTokenExpired=s;var g=function(_){n(d,_);function d(u,R){var b=_.call(this,u,R)||this;b.causes=[],b.code=20151,b.description="Authentication Failed",b.explanation="The Authentication with the provided JWT failed",b.name="AuthenticationFailed",b.solutions=[],Object.setPrototypeOf(b,p.AuthenticationFailed.prototype);var h=typeof u=="string"?u:b.explanation,w=typeof u=="object"?u:R;return b.message="".concat(b.name," (").concat(b.code,"): ").concat(h),b.originalError=w,b}return d}(e.default);p.AuthenticationFailed=g})(i||(t.AuthorizationErrors=i={}));var r;(function(p){var m=function(s){n(g,s);function g(_,d){var u=s.call(this,_,d)||this;u.causes=["The access token has an invalid Account SID, API Key, or API Key Secret."],u.code=31202,u.description="Signature validation failed.",u.explanation="The provided access token failed signature validation.",u.name="AccessTokenSignatureValidationFailed",u.solutions=["Ensure the Account SID, API Key, and API Key Secret are valid when generating your access token."],Object.setPrototypeOf(u,p.AccessTokenSignatureValidationFailed.prototype);var R=typeof _=="string"?_:u.explanation,b=typeof _=="object"?_:d;return u.message="".concat(u.name," (").concat(u.code,"): ").concat(R),u.originalError=b,u}return g}(e.default);p.AccessTokenSignatureValidationFailed=m})(r||(t.SignatureValidationErrors=r={}));var o;(function(p){var m=function(d){n(u,d);function u(R,b){var h=d.call(this,R,b)||this;h.causes=[],h.code=31400,h.description="Bad Request (HTTP/SIP)",h.explanation="The request could not be understood due to malformed syntax.",h.name="BadRequest",h.solutions=[],Object.setPrototypeOf(h,p.BadRequest.prototype);var w=typeof R=="string"?R:h.explanation,L=typeof R=="object"?R:b;return h.message="".concat(h.name," (").concat(h.code,"): ").concat(w),h.originalError=L,h}return u}(e.default);p.BadRequest=m;var s=function(d){n(u,d);function u(R,b){var h=d.call(this,R,b)||this;h.causes=["The outbound call was made to an invalid phone number.","The TwiML application sid is missing a Voice URL."],h.code=31404,h.description="Not Found (HTTP/SIP)",h.explanation="The server has not found anything matching the request.",h.name="NotFound",h.solutions=["Ensure the phone number dialed is valid.","Ensure the TwiML application is configured correctly with a Voice URL link."],Object.setPrototypeOf(h,p.NotFound.prototype);var w=typeof R=="string"?R:h.explanation,L=typeof R=="object"?R:b;return h.message="".concat(h.name," (").concat(h.code,"): ").concat(w),h.originalError=L,h}return u}(e.default);p.NotFound=s;var g=function(d){n(u,d);function u(R,b){var h=d.call(this,R,b)||this;h.causes=[],h.code=31480,h.description="Temporarily Unavailable (SIP)",h.explanation="The callee is currently unavailable.",h.name="TemporarilyUnavailable",h.solutions=[],Object.setPrototypeOf(h,p.TemporarilyUnavailable.prototype);var w=typeof R=="string"?R:h.explanation,L=typeof R=="object"?R:b;return h.message="".concat(h.name," (").concat(h.code,"): ").concat(w),h.originalError=L,h}return u}(e.default);p.TemporarilyUnavailable=g;var _=function(d){n(u,d);function u(R,b){var h=d.call(this,R,b)||this;h.causes=[],h.code=31486,h.description="Busy Here (SIP)",h.explanation="The callee is busy.",h.name="BusyHere",h.solutions=[],Object.setPrototypeOf(h,p.BusyHere.prototype);var w=typeof R=="string"?R:h.explanation,L=typeof R=="object"?R:b;return h.message="".concat(h.name," (").concat(h.code,"): ").concat(w),h.originalError=L,h}return u}(e.default);p.BusyHere=_})(o||(t.ClientErrors=o={}));var c;(function(p){var m=function(s){n(g,s);function g(_,d){var u=s.call(this,_,d)||this;u.causes=[],u.code=31603,u.description="Decline (SIP)",u.explanation="The callee does not wish to participate in the call.",u.name="Decline",u.solutions=[],Object.setPrototypeOf(u,p.Decline.prototype);var R=typeof _=="string"?_:u.explanation,b=typeof _=="object"?_:d;return u.message="".concat(u.name," (").concat(u.code,"): ").concat(R),u.originalError=b,u}return g}(e.default);p.Decline=m})(c||(t.SIPServerErrors=c={}));var y;(function(p){var m=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=[],l.code=31e3,l.description="Unknown Error",l.explanation="An unknown error has occurred. See error details for more information.",l.name="UnknownError",l.solutions=[],Object.setPrototypeOf(l,p.UnknownError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.UnknownError=m;var s=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=[],l.code=31001,l.description="Application Not Found",l.explanation="",l.name="ApplicationNotFoundError",l.solutions=[],Object.setPrototypeOf(l,p.ApplicationNotFoundError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.ApplicationNotFoundError=s;var g=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=[],l.code=31002,l.description="Connection Declined",l.explanation="",l.name="ConnectionDeclinedError",l.solutions=[],Object.setPrototypeOf(l,p.ConnectionDeclinedError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.ConnectionDeclinedError=g;var _=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=[],l.code=31003,l.description="Connection Timeout",l.explanation="The server could not produce a response within a suitable amount of time.",l.name="ConnectionTimeoutError",l.solutions=[],Object.setPrototypeOf(l,p.ConnectionTimeoutError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.ConnectionTimeoutError=_;var d=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=[],l.code=31005,l.description="Connection error",l.explanation="A connection error occurred during the call",l.name="ConnectionError",l.solutions=[],Object.setPrototypeOf(l,p.ConnectionError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.ConnectionError=d;var u=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=["The incoming call was cancelled because it was not answered in time or it was accepted/rejected by another application instance registered with the same identity."],l.code=31008,l.description="Call cancelled",l.explanation="Unable to answer because the call has ended",l.name="CallCancelledError",l.solutions=[],Object.setPrototypeOf(l,p.CallCancelledError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.CallCancelledError=u;var R=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=[],l.code=31009,l.description="Transport error",l.explanation="No transport available to send or receive messages",l.name="TransportError",l.solutions=[],Object.setPrototypeOf(l,p.TransportError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.TransportError=R})(y||(t.GeneralErrors=y={}));var P;(function(p){var m=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=["Invalid content or MessageType passed to sendMessage method."],l.code=31100,l.description="The request had malformed syntax.",l.explanation="The request could not be understood due to malformed syntax.",l.name="MalformedRequestError",l.solutions=["Ensure content and MessageType passed to sendMessage method are valid."],Object.setPrototypeOf(l,p.MalformedRequestError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.MalformedRequestError=m;var s=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=[],l.code=31101,l.description="Missing parameter array in request",l.explanation="",l.name="MissingParameterArrayError",l.solutions=[],Object.setPrototypeOf(l,p.MissingParameterArrayError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.MissingParameterArrayError=s;var g=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=[],l.code=31102,l.description="Authorization token missing in request.",l.explanation="",l.name="AuthorizationTokenMissingError",l.solutions=[],Object.setPrototypeOf(l,p.AuthorizationTokenMissingError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.AuthorizationTokenMissingError=g;var _=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=[],l.code=31103,l.description="Maximum parameter length has been exceeded.",l.explanation="Length of parameters cannot exceed MAX_PARAM_LENGTH.",l.name="MaxParameterLengthExceededError",l.solutions=[],Object.setPrototypeOf(l,p.MaxParameterLengthExceededError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.MaxParameterLengthExceededError=_;var d=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=[],l.code=31104,l.description="Invalid bridge token",l.explanation="",l.name="InvalidBridgeTokenError",l.solutions=[],Object.setPrototypeOf(l,p.InvalidBridgeTokenError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.InvalidBridgeTokenError=d;var u=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=["Client name contains invalid characters."],l.code=31105,l.description="Invalid client name",l.explanation="Client name should not contain control, space, delims, or unwise characters.",l.name="InvalidClientNameError",l.solutions=["Make sure that client name does not contain any of the invalid characters."],Object.setPrototypeOf(l,p.InvalidClientNameError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.InvalidClientNameError=u;var R=function(b){n(h,b);function h(w,L){var l=b.call(this,w,L)||this;l.causes=[],l.code=31107,l.description="The reconnect parameter is invalid",l.explanation="",l.name="ReconnectParameterInvalidError",l.solutions=[],Object.setPrototypeOf(l,p.ReconnectParameterInvalidError.prototype);var $=typeof w=="string"?w:l.explanation,T=typeof w=="object"?w:L;return l.message="".concat(l.name," (").concat(l.code,"): ").concat($),l.originalError=T,l}return h}(e.default);p.ReconnectParameterInvalidError=R})(P||(t.MalformedRequestErrors=P={})),function(p){var m=function(w){n(L,w);function L(l,$){var T=w.call(this,l,$)||this;T.causes=[],T.code=31201,T.description="Authorization error",T.explanation="The request requires user authentication. The server understood the request, but is refusing to fulfill it.",T.name="AuthorizationError",T.solutions=[],Object.setPrototypeOf(T,p.AuthorizationError.prototype);var E=typeof l=="string"?l:T.explanation,f=typeof l=="object"?l:$;return T.message="".concat(T.name," (").concat(T.code,"): ").concat(E),T.originalError=f,T}return L}(e.default);p.AuthorizationError=m;var s=function(w){n(L,w);function L(l,$){var T=w.call(this,l,$)||this;T.causes=[],T.code=31203,T.description="No valid account",T.explanation="",T.name="NoValidAccountError",T.solutions=[],Object.setPrototypeOf(T,p.NoValidAccountError.prototype);var E=typeof l=="string"?l:T.explanation,f=typeof l=="object"?l:$;return T.message="".concat(T.name," (").concat(T.code,"): ").concat(E),T.originalError=f,T}return L}(e.default);p.NoValidAccountError=s;var g=function(w){n(L,w);function L(l,$){var T=w.call(this,l,$)||this;T.causes=[],T.code=31204,T.description="Invalid JWT token",T.explanation="",T.name="InvalidJWTTokenError",T.solutions=[],Object.setPrototypeOf(T,p.InvalidJWTTokenError.prototype);var E=typeof l=="string"?l:T.explanation,f=typeof l=="object"?l:$;return T.message="".concat(T.name," (").concat(T.code,"): ").concat(E),T.originalError=f,T}return L}(e.default);p.InvalidJWTTokenError=g;var _=function(w){n(L,w);function L(l,$){var T=w.call(this,l,$)||this;T.causes=[],T.code=31205,T.description="JWT token expired",T.explanation="",T.name="JWTTokenExpiredError",T.solutions=[],Object.setPrototypeOf(T,p.JWTTokenExpiredError.prototype);var E=typeof l=="string"?l:T.explanation,f=typeof l=="object"?l:$;return T.message="".concat(T.name," (").concat(T.code,"): ").concat(E),T.originalError=f,T}return L}(e.default);p.JWTTokenExpiredError=_;var d=function(w){n(L,w);function L(l,$){var T=w.call(this,l,$)||this;T.causes=["Rate limit exceeded."],T.code=31206,T.description="Rate exceeded authorized limit.",T.explanation="The request performed exceeds the authorized limit.",T.name="RateExceededError",T.solutions=["Ensure message send rate does not exceed authorized limits."],Object.setPrototypeOf(T,p.RateExceededError.prototype);var E=typeof l=="string"?l:T.explanation,f=typeof l=="object"?l:$;return T.message="".concat(T.name," (").concat(T.code,"): ").concat(E),T.originalError=f,T}return L}(e.default);p.RateExceededError=d;var u=function(w){n(L,w);function L(l,$){var T=w.call(this,l,$)||this;T.causes=[],T.code=31207,T.description="JWT token expiration too long",T.explanation="",T.name="JWTTokenExpirationTooLongError",T.solutions=[],Object.setPrototypeOf(T,p.JWTTokenExpirationTooLongError.prototype);var E=typeof l=="string"?l:T.explanation,f=typeof l=="object"?l:$;return T.message="".concat(T.name," (").concat(T.code,"): ").concat(E),T.originalError=f,T}return L}(e.default);p.JWTTokenExpirationTooLongError=u;var R=function(w){n(L,w);function L(l,$){var T=w.call(this,l,$)||this;T.causes=[],T.code=31209,T.description="Reconnect attempt is not authorized.",T.explanation="",T.name="ReconnectAttemptError",T.solutions=[],Object.setPrototypeOf(T,p.ReconnectAttemptError.prototype);var E=typeof l=="string"?l:T.explanation,f=typeof l=="object"?l:$;return T.message="".concat(T.name," (").concat(T.code,"): ").concat(E),T.originalError=f,T}return L}(e.default);p.ReconnectAttemptError=R;var b=function(w){n(L,w);function L(l,$){var T=w.call(this,l,$)||this;T.causes=["The Call Message Event Type is invalid and is not understood by Twilio Voice."],T.code=31210,T.description="Call Message Event Type is invalid.",T.explanation="The Call Message Event Type is invalid and is not understood by Twilio Voice.",T.name="CallMessageEventTypeInvalidError",T.solutions=["Ensure the Call Message Event Type is Valid and understood by Twilio Voice and try again."],Object.setPrototypeOf(T,p.CallMessageEventTypeInvalidError.prototype);var E=typeof l=="string"?l:T.explanation,f=typeof l=="object"?l:$;return T.message="".concat(T.name," (").concat(T.code,"): ").concat(E),T.originalError=f,T}return L}(e.default);p.CallMessageEventTypeInvalidError=b;var h=function(w){n(L,w);function L(l,$){var T=w.call(this,l,$)||this;T.causes=["The payload size of Call Message Event exceeds the authorized limit."],T.code=31212,T.description="Call Message Event Payload size exceeded authorized limit.",T.explanation="The request performed to send a Call Message Event exceeds the payload size authorized limit",T.name="PayloadSizeExceededError",T.solutions=["Reduce payload size of Call Message Event to be within the authorized limit and try again."],Object.setPrototypeOf(T,p.PayloadSizeExceededError.prototype);var E=typeof l=="string"?l:T.explanation,f=typeof l=="object"?l:$;return T.message="".concat(T.name," (").concat(T.code,"): ").concat(E),T.originalError=f,T}return L}(e.default);p.PayloadSizeExceededError=h}(i||(t.AuthorizationErrors=i={}));var I;(function(p){var m=function(g){n(_,g);function _(d,u){var R=g.call(this,d,u)||this;R.causes=["The user denied the getUserMedia request.","The browser denied the getUserMedia request."],R.code=31401,R.description="UserMedia Permission Denied Error",R.explanation="The browser or end-user denied permissions to user media. Therefore we were unable to acquire input audio.",R.name="PermissionDeniedError",R.solutions=["The user should accept the request next time prompted. If the browser saved the deny, the user should change that permission in their browser.","The user should to verify that the browser has permission to access the microphone at this address."],Object.setPrototypeOf(R,p.PermissionDeniedError.prototype);var b=typeof d=="string"?d:R.explanation,h=typeof d=="object"?d:u;return R.message="".concat(R.name," (").concat(R.code,"): ").concat(b),R.originalError=h,R}return _}(e.default);p.PermissionDeniedError=m;var s=function(g){n(_,g);function _(d,u){var R=g.call(this,d,u)||this;R.causes=["NotFoundError - The deviceID specified was not found.","The getUserMedia constraints were overconstrained and no devices matched."],R.code=31402,R.description="UserMedia Acquisition Failed Error",R.explanation="The browser and end-user allowed permissions, however getting the media failed. Usually this is due to bad constraints, but can sometimes fail due to browser, OS or hardware issues.",R.name="AcquisitionFailedError",R.solutions=["Ensure the deviceID being specified exists.","Try acquiring media with fewer constraints."],Object.setPrototypeOf(R,p.AcquisitionFailedError.prototype);var b=typeof d=="string"?d:R.explanation,h=typeof d=="object"?d:u;return R.message="".concat(R.name," (").concat(R.code,"): ").concat(b),R.originalError=h,R}return _}(e.default);p.AcquisitionFailedError=s})(I||(t.UserMediaErrors=I={}));var D;(function(p){var m=function(g){n(_,g);function _(d,u){var R=g.call(this,d,u)||this;R.causes=[],R.code=53e3,R.description="Signaling connection error",R.explanation="Raised whenever a signaling connection error occurs that is not covered by a more specific error code.",R.name="ConnectionError",R.solutions=[],Object.setPrototypeOf(R,p.ConnectionError.prototype);var b=typeof d=="string"?d:R.explanation,h=typeof d=="object"?d:u;return R.message="".concat(R.name," (").concat(R.code,"): ").concat(b),R.originalError=h,R}return _}(e.default);p.ConnectionError=m;var s=function(g){n(_,g);function _(d,u){var R=g.call(this,d,u)||this;R.causes=["The device running your application lost its Internet connection."],R.code=53001,R.description="Signaling connection disconnected",R.explanation="Raised whenever the signaling connection is unexpectedly disconnected.",R.name="ConnectionDisconnected",R.solutions=["Ensure the device running your application has access to a stable Internet connection."],Object.setPrototypeOf(R,p.ConnectionDisconnected.prototype);var b=typeof d=="string"?d:R.explanation,h=typeof d=="object"?d:u;return R.message="".concat(R.name," (").concat(R.code,"): ").concat(b),R.originalError=h,R}return _}(e.default);p.ConnectionDisconnected=s})(D||(t.SignalingErrors=D={}));var v;(function(p){var m=function(_){n(d,_);function d(u,R){var b=_.call(this,u,R)||this;b.causes=["The Client may not be using a supported WebRTC implementation.","The Client may not have the necessary resources to create or apply a new media description."],b.code=53400,b.description="Client is unable to create or apply a local media description",b.explanation="Raised whenever a Client is unable to create or apply a local media description.",b.name="ClientLocalDescFailed",b.solutions=["If you are experiencing this error using the JavaScript SDK, ensure you are running it with a supported WebRTC implementation."],Object.setPrototypeOf(b,p.ClientLocalDescFailed.prototype);var h=typeof u=="string"?u:b.explanation,w=typeof u=="object"?u:R;return b.message="".concat(b.name," (").concat(b.code,"): ").concat(h),b.originalError=w,b}return d}(e.default);p.ClientLocalDescFailed=m;var s=function(_){n(d,_);function d(u,R){var b=_.call(this,u,R)||this;b.causes=["The Client may not be using a supported WebRTC implementation.","The Client may be connecting peer-to-peer with another Participant that is not using a supported WebRTC implementation.","The Client may not have the necessary resources to apply a new media description."],b.code=53402,b.description="Client is unable to apply a remote media description",b.explanation="Raised whenever the Client receives a remote media description but is unable to apply it.",b.name="ClientRemoteDescFailed",b.solutions=["If you are experiencing this error using the JavaScript SDK, ensure you are running it with a supported WebRTC implementation."],Object.setPrototypeOf(b,p.ClientRemoteDescFailed.prototype);var h=typeof u=="string"?u:b.explanation,w=typeof u=="object"?u:R;return b.message="".concat(b.name," (").concat(b.code,"): ").concat(h),b.originalError=w,b}return d}(e.default);p.ClientRemoteDescFailed=s;var g=function(_){n(d,_);function d(u,R){var b=_.call(this,u,R)||this;b.causes=["The Client was unable to establish a media connection.","A media connection which was active failed liveliness checks."],b.code=53405,b.description="Media connection failed",b.explanation="Raised by the Client or Server whenever a media connection fails.",b.name="ConnectionError",b.solutions=["If the problem persists, try connecting to another region.","Check your Client's network connectivity.","If you've provided custom ICE Servers then ensure that the URLs and credentials are valid."],Object.setPrototypeOf(b,p.ConnectionError.prototype);var h=typeof u=="string"?u:b.explanation,w=typeof u=="object"?u:R;return b.message="".concat(b.name," (").concat(b.code,"): ").concat(h),b.originalError=w,b}return d}(e.default);p.ConnectionError=g})(v||(t.MediaErrors=v={})),t.errorsByCode=new Map([[20101,i.AccessTokenInvalid],[20104,i.AccessTokenExpired],[20151,i.AuthenticationFailed],[31202,r.AccessTokenSignatureValidationFailed],[31400,o.BadRequest],[31404,o.NotFound],[31480,o.TemporarilyUnavailable],[31486,o.BusyHere],[31603,c.Decline],[31e3,y.UnknownError],[31001,y.ApplicationNotFoundError],[31002,y.ConnectionDeclinedError],[31003,y.ConnectionTimeoutError],[31005,y.ConnectionError],[31008,y.CallCancelledError],[31009,y.TransportError],[31100,P.MalformedRequestError],[31101,P.MissingParameterArrayError],[31102,P.AuthorizationTokenMissingError],[31103,P.MaxParameterLengthExceededError],[31104,P.InvalidBridgeTokenError],[31105,P.InvalidClientNameError],[31107,P.ReconnectParameterInvalidError],[31201,i.AuthorizationError],[31203,i.NoValidAccountError],[31204,i.InvalidJWTTokenError],[31205,i.JWTTokenExpiredError],[31206,i.RateExceededError],[31207,i.JWTTokenExpirationTooLongError],[31209,i.ReconnectAttemptError],[31210,i.CallMessageEventTypeInvalidError],[31212,i.PayloadSizeExceededError],[31401,I.PermissionDeniedError],[31402,I.AcquisitionFailedError],[53e3,D.ConnectionError],[53001,D.ConnectionDisconnected],[53400,v.ClientLocalDescFailed],[53402,v.ClientRemoteDescFailed],[53405,v.ConnectionError]]),Object.freeze(t.errorsByCode)})(gi);(function(t){var n=H&&H.__extends||function(){var D=function(v,p){return D=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(m,s){m.__proto__=s}||function(m,s){for(var g in s)Object.prototype.hasOwnProperty.call(s,g)&&(m[g]=s[g])},D(v,p)};return function(v,p){if(typeof p!="function"&&p!==null)throw new TypeError("Class extends value "+String(p)+" is not a constructor or null");D(v,p);function m(){this.constructor=v}v.prototype=p===null?Object.create(p):(m.prototype=p.prototype,new m)}}();Object.defineProperty(t,"__esModule",{value:!0}),t.UserMediaErrors=t.TwilioError=t.SIPServerErrors=t.SignatureValidationErrors=t.SignalingErrors=t.MediaErrors=t.MalformedRequestErrors=t.GeneralErrors=t.ClientErrors=t.AuthorizationErrors=t.NotSupportedError=t.InvalidStateError=t.InvalidArgumentError=void 0,t.getPreciseSignalingErrorByCode=r,t.getErrorByCode=P,t.hasErrorByCode=I;var e=gi;Object.defineProperty(t,"AuthorizationErrors",{enumerable:!0,get:function(){return e.AuthorizationErrors}}),Object.defineProperty(t,"ClientErrors",{enumerable:!0,get:function(){return e.ClientErrors}}),Object.defineProperty(t,"GeneralErrors",{enumerable:!0,get:function(){return e.GeneralErrors}}),Object.defineProperty(t,"MalformedRequestErrors",{enumerable:!0,get:function(){return e.MalformedRequestErrors}}),Object.defineProperty(t,"MediaErrors",{enumerable:!0,get:function(){return e.MediaErrors}}),Object.defineProperty(t,"SignalingErrors",{enumerable:!0,get:function(){return e.SignalingErrors}}),Object.defineProperty(t,"SignatureValidationErrors",{enumerable:!0,get:function(){return e.SignatureValidationErrors}}),Object.defineProperty(t,"SIPServerErrors",{enumerable:!0,get:function(){return e.SIPServerErrors}}),Object.defineProperty(t,"TwilioError",{enumerable:!0,get:function(){return e.TwilioError}}),Object.defineProperty(t,"UserMediaErrors",{enumerable:!0,get:function(){return e.UserMediaErrors}});var i=new Set([31001,31002,31003,31101,31102,31103,31104,31105,31107,31201,31202,31203,31204,31205,31207,31404,31480,31486,31603]);function r(D,v){if(typeof v=="number"&&I(v)){var p=D?!0:!i.has(v);if(p)return P(v)}}var o=function(D){n(v,D);function v(p){var m=D.call(this,p)||this;return m.name="InvalidArgumentError",m}return v}(Error);t.InvalidArgumentError=o;var c=function(D){n(v,D);function v(p){var m=D.call(this,p)||this;return m.name="InvalidStateError",m}return v}(Error);t.InvalidStateError=c;var y=function(D){n(v,D);function v(p){var m=D.call(this,p)||this;return m.name="NotSupportedError",m}return v}(Error);t.NotSupportedError=y;function P(D){var v=e.errorsByCode.get(D);if(!v)throw new o("Error code ".concat(D," not found"));return v}function I(D){return e.errorsByCode.has(D)}})(ce);var le={},se={};Object.defineProperty(se,"__esModule",{value:!0});se.SOUNDS_BASE_URL=se.RELEASE_VERSION=se.PACKAGE_NAME=se.ECHO_TEST_DURATION=se.COWBELL_AUDIO_URL=void 0;var oo="@twilio/voice-sdk";se.PACKAGE_NAME=oo;var yi="2.15.0";se.RELEASE_VERSION=yi;var bi="https://sdk.twilio.com/js/client/sounds/releases/1.0.0";se.SOUNDS_BASE_URL=bi;var ao="".concat(bi,"/cowbell.mp3?cache=").concat(yi);se.COWBELL_AUDIO_URL=ao;var so=2e4;se.ECHO_TEST_DURATION=so;var rt=H&&H.__spreadArray||function(t,n,e){if(e||arguments.length===2)for(var i=0,r=n.length,o;i<r;i++)(o||!(i in n))&&(o||(o=Array.prototype.slice.call(n,0,i)),o[i]=n[i]);return t.concat(o||Array.prototype.slice.call(n))};Object.defineProperty(le,"__esModule",{value:!0});le.Logger=void 0;var kn=mi,co=se,wi=function(){function t(n,e){this._log=t.getLogLevelInstance(e),this._prefix="[TwilioVoice][".concat(n,"]")}return t.getLogLevelInstance=function(n){if(!t.loglevelInstance)try{t.loglevelInstance=(n&&n.LogLevelModule?n.LogLevelModule:kn).getLogger(co.PACKAGE_NAME)}catch{console.warn("Cannot create custom logger"),t.loglevelInstance=console}return t.loglevelInstance},t.prototype.debug=function(){for(var n,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];(n=this._log).debug.apply(n,rt([this._prefix],e,!1))},t.prototype.error=function(){for(var n,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];(n=this._log).error.apply(n,rt([this._prefix],e,!1))},t.prototype.info=function(){for(var n,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];(n=this._log).info.apply(n,rt([this._prefix],e,!1))},t.prototype.setDefaultLevel=function(n){this._log.setDefaultLevel?this._log.setDefaultLevel(n):console.warn("Logger cannot setDefaultLevel")},t.prototype.warn=function(){for(var n,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];(n=this._log).warn.apply(n,rt([this._prefix],e,!1))},t.levels=kn.levels,t}();le.Logger=wi.getLogLevelInstance();le.default=wi;var Jt={};Object.defineProperty(Jt,"__esModule",{value:!0});var lo=se,Be=ce,uo=le,fo="".concat(lo.SOUNDS_BASE_URL,"/outgoing.mp3"),po=function(){function t(n,e,i,r){this._name=n,this._availableDevices=e,this._beforeChange=i,this._isSupported=r,this._activeDevices=new Set,this._log=new uo.default("OutputDeviceCollection")}return t.prototype.delete=function(n){this._log.debug(".delete",n);var e=!!this._activeDevices.delete(n),i=this._availableDevices.get("default")||Array.from(this._availableDevices.values())[0];!this._activeDevices.size&&i&&this._activeDevices.add(i);var r=Array.from(this._activeDevices.values()).map(function(o){return o.deviceId});return this._beforeChange(this._name,r),!!e},t.prototype.get=function(){return this._activeDevices},t.prototype.set=function(n){var e=this;if(this._log.debug(".set",n),!this._isSupported)return Promise.reject(new Be.NotSupportedError("This browser does not support audio output selection"));var i=Array.isArray(n)?n:[n];if(!i.length)return Promise.reject(new Be.InvalidArgumentError("Must specify at least one device to set"));var r=[],o=i.map(function(c){var y=e._availableDevices.get(c);return y||r.push(c),y});return r.length?Promise.reject(new Be.InvalidArgumentError("Devices not found: ".concat(r.join(", ")))):new Promise(function(c){c(e._beforeChange(e._name,i))}).then(function(){e._activeDevices.clear(),o.forEach(e._activeDevices.add,e._activeDevices)})},t.prototype.test=function(n){return n===void 0&&(n=fo),this._isSupported?this._activeDevices.size?Promise.all(Array.from(this._activeDevices).map(function(e){var i;return new Promise(function(r){i=new Audio(n),i.oncanplay=r}).then(function(){return i.setSinkId(e.deviceId).then(function(){return i.play()})})})):Promise.reject(new Be.InvalidStateError("No active output devices to test")):Promise.reject(new Be.NotSupportedError("This browser does not support audio output selection"))},t}();Jt.default=po;var Qt={};Object.defineProperty(Qt,"__esModule",{value:!0});var ho=function(){function t(n){Object.defineProperties(this,{deviceId:{get:function(){return n.deviceId}},groupId:{get:function(){return n.groupId}},kind:{get:function(){return n.kind}},label:{get:function(){return n.label}}})}return t}();Qt.default=ho;var re={};Object.defineProperty(re,"__esModule",{value:!0});re.Exception=void 0;re.average=vo;re.difference=_o;re.isElectron=Si;re.isChrome=Ci;re.isFirefox=ki;re.isLegacyEdge=mo;re.isSafari=Ti;re.isUnifiedPlanDefault=go;re.queryToJson=yo;re.flatMap=bo;re.promisifyEvents=wo;re.sortByMimeTypes=So;function ht(t){if(!(this instanceof ht))return new ht(t);this.message=t}ht.prototype.toString=function(){return"Twilio.Exception: ".concat(this.message)};function vo(t){return t&&t.length?t.reduce(function(n,e){return n+e})/t.length:0}function _o(t,n,e){e=e||function(r){return r};var i=new Set(n.map(e));return t.filter(function(r){return!i.has(e(r))})}function Si(t){return!!t.userAgent.match("Electron")}function Ci(t,n){var e=!!n.userAgent.match("CriOS"),i=!!n.userAgent.match("HeadlessChrome"),r=typeof t.chrome<"u"&&n.vendor==="Google Inc."&&n.userAgent.indexOf("OPR")===-1&&n.userAgent.indexOf("Edge")===-1;return e||Si(n)||r||i}function ki(t){return t=t||(typeof window>"u"?H.navigator:window.navigator),!!t&&typeof t.userAgent=="string"&&/firefox|fxios/i.test(t.userAgent)}function mo(t){return t=t||(typeof window>"u"?H.navigator:window.navigator),!!t&&typeof t.userAgent=="string"&&/edge\/\d+/i.test(t.userAgent)}function Ti(t){return!!t.vendor&&t.vendor.indexOf("Apple")!==-1&&t.userAgent&&t.userAgent.indexOf("CriOS")===-1&&t.userAgent.indexOf("FxiOS")===-1}function go(t,n,e,i){if(typeof t>"u"||typeof n>"u"||typeof e>"u"||typeof i>"u"||typeof e.prototype>"u"||typeof i.prototype>"u")return!1;if(Ci(t,n)&&e.prototype.addTransceiver){var r=new e,o=!0;try{r.addTransceiver("audio")}catch{o=!1}return r.close(),o}else{if(ki(n))return!0;if(Ti(n))return"currentDirection"in i.prototype}return!1}function yo(t){return t?t.split("&").reduce(function(n,e){var i=e.split("="),r=i[0],o=decodeURIComponent((i[1]||"").replace(/\+/g,"%20"));return r&&(n[r]=o),n},{}):""}function bo(t,n){var e=t instanceof Map||t instanceof Set?Array.from(t.values()):t;return n=n||function(i){return i},e.reduce(function(i,r){var o=n(r);return i.concat(o)},[])}function wo(t,n,e){return new Promise(function(i,r){function o(){t.removeListener(e,c),i()}function c(){t.removeListener(n,o),r()}t.once(n,o),t.once(e,c)})}function So(t,n){var e=n.map(function(i){return"audio/"+i.toLowerCase()});return t.sort(function(i,r){var o=e.indexOf(i.mimeType.toLowerCase()),c=e.indexOf(r.mimeType.toLowerCase()),y=o>=0?o:Number.MAX_VALUE,P=c>=0?c:Number.MAX_VALUE;return y-P})}var Co=ht;re.Exception=Co;var Tn;function ko(){if(Tn)return it;Tn=1;var t=H&&H.__extends||function(){var p=function(m,s){return p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,_){g.__proto__=_}||function(g,_){for(var d in _)Object.prototype.hasOwnProperty.call(_,d)&&(g[d]=_[d])},p(m,s)};return function(m,s){if(typeof s!="function"&&s!==null)throw new TypeError("Class extends value "+String(s)+" is not a constructor or null");p(m,s);function g(){this.constructor=m}m.prototype=s===null?Object.create(s):(g.prototype=s.prototype,new g)}}(),n=H&&H.__awaiter||function(p,m,s,g){function _(d){return d instanceof s?d:new s(function(u){u(d)})}return new(s||(s=Promise))(function(d,u){function R(w){try{h(g.next(w))}catch(L){u(L)}}function b(w){try{h(g.throw(w))}catch(L){u(L)}}function h(w){w.done?d(w.value):_(w.value).then(R,b)}h((g=g.apply(p,m||[])).next())})},e=H&&H.__generator||function(p,m){var s={label:0,sent:function(){if(d[0]&1)throw d[1];return d[1]},trys:[],ops:[]},g,_,d,u=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return u.next=R(0),u.throw=R(1),u.return=R(2),typeof Symbol=="function"&&(u[Symbol.iterator]=function(){return this}),u;function R(h){return function(w){return b([h,w])}}function b(h){if(g)throw new TypeError("Generator is already executing.");for(;u&&(u=0,h[0]&&(s=0)),s;)try{if(g=1,_&&(d=h[0]&2?_.return:h[0]?_.throw||((d=_.return)&&d.call(_),0):_.next)&&!(d=d.call(_,h[1])).done)return d;switch(_=0,d&&(h=[h[0]&2,d.value]),h[0]){case 0:case 1:d=h;break;case 4:return s.label++,{value:h[1],done:!1};case 5:s.label++,_=h[1],h=[0];continue;case 7:h=s.ops.pop(),s.trys.pop();continue;default:if(d=s.trys,!(d=d.length>0&&d[d.length-1])&&(h[0]===6||h[0]===2)){s=0;continue}if(h[0]===3&&(!d||h[1]>d[0]&&h[1]<d[3])){s.label=h[1];break}if(h[0]===6&&s.label<d[1]){s.label=d[1],d=h;break}if(d&&s.label<d[2]){s.label=d[2],s.ops.push(h);break}d[2]&&s.ops.pop(),s.trys.pop();continue}h=m.call(p,s)}catch(w){h=[6,w],_=0}finally{g=d=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}};Object.defineProperty(it,"__esModule",{value:!0});var i=me,r=Et(),o=ce,c=le,y=Jt,P=Qt,I=re,D={audioinput:"Audio Input",audiooutput:"Audio Output"},v=function(p){t(m,p);function m(s,g,_){var d,u=p.call(this)||this;u.availableInputDevices=new Map,u.availableOutputDevices=new Map,u._audioConstraints=null,u._defaultInputDeviceStream=null,u._enabledSounds=(d={},d[r.default.SoundName.Disconnect]=!0,d[r.default.SoundName.Incoming]=!0,d[r.default.SoundName.Outgoing]=!0,d),u._inputDevice=null,u._inputDevicePromise=null,u._isPollingInputVolume=!1,u._log=new c.default("AudioHelper"),u._processedStream=null,u._selectedInputDeviceStream=null,u._unknownDeviceIndexes={audioinput:{},audiooutput:{}},u._updateAvailableDevices=function(){return!u._mediaDevices||!u._enumerateDevices?Promise.reject("Enumeration not supported"):u._enumerateDevices().then(function(w){u._updateDevices(w.filter(function(l){return l.kind==="audiooutput"}),u.availableOutputDevices,u._removeLostOutput),u._updateDevices(w.filter(function(l){return l.kind==="audioinput"}),u.availableInputDevices,u._removeLostInput);var L=u.availableOutputDevices.get("default")||Array.from(u.availableOutputDevices.values())[0];[u.speakerDevices,u.ringtoneDevices].forEach(function(l){!l.get().size&&u.availableOutputDevices.size&&u.isOutputSelectionSupported&&l.set(L.deviceId).catch(function($){u._log.warn("Unable to set audio output devices. ".concat($))})})})},u._removeLostInput=function(w){if(!u.inputDevice||u.inputDevice.deviceId!==w.deviceId)return!1;u._destroyProcessedStream(),u._replaceStream(null),u._inputDevice=null,u._maybeStopPollingVolume();var L=u.availableInputDevices.get("default")||Array.from(u.availableInputDevices.values())[0];return L&&u.setInputDevice(L.deviceId),!0},u._removeLostOutput=function(w){var L=u.speakerDevices.delete(w),l=u.ringtoneDevices.delete(w);return L||l},_=Object.assign({AudioContext:typeof AudioContext<"u"&&AudioContext,setSinkId:typeof HTMLAudioElement<"u"&&HTMLAudioElement.prototype.setSinkId},_),u._beforeSetInputDevice=_.beforeSetInputDevice||function(){return Promise.resolve()},u._updateUserOptions(_),u._audioProcessorEventObserver=_.audioProcessorEventObserver,u._mediaDevices=_.mediaDevices||navigator.mediaDevices,u._onActiveInputChanged=g,u._enumerateDevices=typeof _.enumerateDevices=="function"?_.enumerateDevices:u._mediaDevices&&u._mediaDevices.enumerateDevices.bind(u._mediaDevices);var R=!!(_.AudioContext||_.audioContext),b=!!u._enumerateDevices;_.enabledSounds&&(u._enabledSounds=_.enabledSounds);var h=typeof _.setSinkId=="function";return u.isOutputSelectionSupported=b&&h,u.isVolumeSupported=R,u.isVolumeSupported&&(u._audioContext=_.audioContext||_.AudioContext&&new _.AudioContext,u._audioContext&&(u._inputVolumeAnalyser=u._audioContext.createAnalyser(),u._inputVolumeAnalyser.fftSize=32,u._inputVolumeAnalyser.smoothingTimeConstant=.3)),u.ringtoneDevices=new y.default("ringtone",u.availableOutputDevices,s,u.isOutputSelectionSupported),u.speakerDevices=new y.default("speaker",u.availableOutputDevices,s,u.isOutputSelectionSupported),u.addListener("newListener",function(w){w==="inputVolume"&&u._maybeStartPollingVolume()}),u.addListener("removeListener",function(w){w==="inputVolume"&&u._maybeStopPollingVolume()}),u.once("newListener",function(){u.isOutputSelectionSupported||u._log.warn("Warning: This browser does not support audio output selection."),u.isVolumeSupported||u._log.warn("Warning: This browser does not support Twilio's volume indicator feature.")}),b&&u._initializeEnumeration(),navigator&&navigator.permissions&&typeof navigator.permissions.query=="function"?navigator.permissions.query({name:"microphone"}).then(function(w){if(w.state!=="granted"){var L=function(){u._updateAvailableDevices(),u._stopMicrophonePermissionListener()};w.addEventListener("change",L),u._microphonePermissionStatus=w,u._onMicrophonePermissionStatusChanged=L}}).catch(function(w){return u._log.warn("Warning: unable to listen for microphone permission changes. ".concat(w))}):u._log.warn("Warning: current browser does not support permissions API."),u}return Object.defineProperty(m.prototype,"audioConstraints",{get:function(){return this._audioConstraints},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"inputDevice",{get:function(){return this._inputDevice},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"inputStream",{get:function(){return this._processedStream||this._selectedInputDeviceStream},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"processedStream",{get:function(){return this._processedStream},enumerable:!1,configurable:!0}),m.prototype._destroy=function(){this._stopDefaultInputDeviceStream(),this._stopSelectedInputDeviceStream(),this._destroyProcessedStream(),this._maybeStopPollingVolume(),this.removeAllListeners(),this._stopMicrophonePermissionListener(),this._unbind()},m.prototype._getInputDevicePromise=function(){return this._inputDevicePromise},m.prototype._maybeStartPollingVolume=function(){var s=this;if(!(!this.isVolumeSupported||!this.inputStream)&&(this._updateVolumeSource(),!(this._isPollingInputVolume||!this._inputVolumeAnalyser))){var g=this._inputVolumeAnalyser.frequencyBinCount,_=new Uint8Array(g);this._isPollingInputVolume=!0;var d=function(){if(s._isPollingInputVolume){if(s._inputVolumeAnalyser){s._inputVolumeAnalyser.getByteFrequencyData(_);var u=(0,I.average)(_);s.emit("inputVolume",u/255)}requestAnimationFrame(d)}};requestAnimationFrame(d)}},m.prototype._maybeStopPollingVolume=function(){this.isVolumeSupported&&(!this._isPollingInputVolume||this.inputStream&&this.listenerCount("inputVolume")||(this._inputVolumeSource&&(this._inputVolumeSource.disconnect(),delete this._inputVolumeSource),this._isPollingInputVolume=!1))},m.prototype._openDefaultDeviceWithConstraints=function(s){var g=this;return this._log.info("Opening default device with constraints",s),this._getUserMedia(s).then(function(_){return g._log.info("Opened default device. Updating available devices."),g._updateAvailableDevices().catch(function(d){g._log.warn("Unable to updateAvailableDevices after gUM call",d)}),g._defaultInputDeviceStream=_,g._maybeCreateProcessedStream(_)})},m.prototype._stopDefaultInputDeviceStream=function(){this._defaultInputDeviceStream&&(this._log.info("stopping default device stream"),this._defaultInputDeviceStream.getTracks().forEach(function(s){return s.stop()}),this._defaultInputDeviceStream=null,this._destroyProcessedStream())},m.prototype._unbind=function(){var s;!((s=this._mediaDevices)===null||s===void 0)&&s.removeEventListener&&this._mediaDevices.removeEventListener("devicechange",this._updateAvailableDevices)},m.prototype._updateUserOptions=function(s){typeof s.enumerateDevices=="function"&&(this._enumerateDevices=s.enumerateDevices),typeof s.getUserMedia=="function"&&(this._getUserMedia=s.getUserMedia)},m.prototype.addProcessor=function(s){if(this._log.debug(".addProcessor"),this._processor)throw new o.NotSupportedError("Adding multiple AudioProcessors is not supported at this time.");if(typeof s!="object"||s===null)throw new o.InvalidArgumentError("Missing AudioProcessor argument.");if(typeof s.createProcessedStream!="function")throw new o.InvalidArgumentError("Missing createProcessedStream() method.");if(typeof s.destroyProcessedStream!="function")throw new o.InvalidArgumentError("Missing destroyProcessedStream() method.");return this._processor=s,this._audioProcessorEventObserver.emit("add"),this._restartStreams()},m.prototype.disconnect=function(s){return this._log.debug(".disconnect",s),this._maybeEnableSound(r.default.SoundName.Disconnect,s)},m.prototype.incoming=function(s){return this._log.debug(".incoming",s),this._maybeEnableSound(r.default.SoundName.Incoming,s)},m.prototype.outgoing=function(s){return this._log.debug(".outgoing",s),this._maybeEnableSound(r.default.SoundName.Outgoing,s)},m.prototype.removeProcessor=function(s){if(this._log.debug(".removeProcessor"),typeof s!="object"||s===null)throw new o.InvalidArgumentError("Missing AudioProcessor argument.");if(this._processor!==s)throw new o.InvalidArgumentError("Cannot remove an AudioProcessor that has not been previously added.");return this._destroyProcessedStream(),this._processor=null,this._audioProcessorEventObserver.emit("remove"),this._restartStreams()},m.prototype.setAudioConstraints=function(s){return this._log.debug(".setAudioConstraints",s),this._audioConstraints=Object.assign({},s),delete this._audioConstraints.deviceId,this.inputDevice?this._setInputDevice(this.inputDevice.deviceId,!0):Promise.resolve()},m.prototype.setInputDevice=function(s){return this._log.debug(".setInputDevice",s),this._setInputDevice(s,!1)},m.prototype.unsetAudioConstraints=function(){return this._log.debug(".unsetAudioConstraints"),this._audioConstraints=null,this.inputDevice?this._setInputDevice(this.inputDevice.deviceId,!0):Promise.resolve()},m.prototype.unsetInputDevice=function(){var s=this;return this._log.debug(".unsetInputDevice",this.inputDevice),this.inputDevice?(this._destroyProcessedStream(),this._onActiveInputChanged(null).then(function(){s._replaceStream(null),s._inputDevice=null,s._maybeStopPollingVolume()})):Promise.resolve()},m.prototype._destroyProcessedStream=function(){if(this._processor&&this._processedStream){this._log.info("destroying processed stream");var s=this._processedStream;this._processedStream.getTracks().forEach(function(g){return g.stop()}),this._processedStream=null,this._processor.destroyProcessedStream(s),this._audioProcessorEventObserver.emit("destroy")}},m.prototype._getUnknownDeviceIndex=function(s){var g=s.deviceId,_=s.kind,d=this._unknownDeviceIndexes[_][g];return d||(d=Object.keys(this._unknownDeviceIndexes[_]).length+1,this._unknownDeviceIndexes[_][g]=d),d},m.prototype._initializeEnumeration=function(){var s=this;if(!this._mediaDevices||!this._enumerateDevices)throw new o.NotSupportedError("Enumeration is not supported");this._mediaDevices.addEventListener&&this._mediaDevices.addEventListener("devicechange",this._updateAvailableDevices),this._updateAvailableDevices().then(function(){s.isOutputSelectionSupported&&Promise.all([s.speakerDevices.set("default"),s.ringtoneDevices.set("default")]).catch(function(g){s._log.warn("Warning: Unable to set audio output devices. ".concat(g))})})},m.prototype._maybeCreateProcessedStream=function(s){var g=this;return this._processor?(this._log.info("Creating processed stream"),this._processor.createProcessedStream(s).then(function(_){return g._processedStream=_,g._audioProcessorEventObserver.emit("create"),g._processedStream})):Promise.resolve(s)},m.prototype._maybeEnableSound=function(s,g){return typeof g<"u"&&(this._enabledSounds[s]=g),this._enabledSounds[s]},m.prototype._replaceStream=function(s){this._log.info("Replacing with new stream."),this._selectedInputDeviceStream&&(this._log.info("Old stream detected. Stopping tracks."),this._stopSelectedInputDeviceStream()),this._selectedInputDeviceStream=s},m.prototype._restartStreams=function(){if(this.inputDevice&&this._selectedInputDeviceStream)return this._log.info("Restarting selected input device"),this._setInputDevice(this.inputDevice.deviceId,!0);if(this._defaultInputDeviceStream){var s=this.availableInputDevices.get("default")||Array.from(this.availableInputDevices.values())[0];return this._log.info("Restarting default input device, now becoming selected."),this._setInputDevice(s.deviceId,!0)}return Promise.resolve()},m.prototype._setInputDevice=function(s,g){return n(this,void 0,void 0,function(){var _,d=this;return e(this,function(u){return _=function(){return n(d,void 0,void 0,function(){var R,b,h=this;return e(this,function(w){switch(w.label){case 0:return[4,this._beforeSetInputDevice()];case 1:if(w.sent(),typeof s!="string")return[2,Promise.reject(new o.InvalidArgumentError("Must specify the device to set"))];if(R=this.availableInputDevices.get(s),!R)return[2,Promise.reject(new o.InvalidArgumentError("Device not found: ".concat(s)))];if(this._log.info("Setting input device. ID: "+s),this._inputDevice&&this._inputDevice.deviceId===s&&this._selectedInputDeviceStream){if(!g)return[2,Promise.resolve()];this._log.info("Same track detected on setInputDevice, stopping old tracks."),this._stopSelectedInputDeviceStream()}return this._stopDefaultInputDeviceStream(),b={audio:Object.assign({deviceId:{exact:s}},this.audioConstraints)},this._log.info("setInputDevice: getting new tracks."),[2,this._getUserMedia(b).then(function(L){return h._destroyProcessedStream(),h._maybeCreateProcessedStream(L).then(function(l){return h._log.info("setInputDevice: invoking _onActiveInputChanged."),h._onActiveInputChanged(l).then(function(){h._replaceStream(L),h._inputDevice=R,h._maybeStartPollingVolume()})})})]}})})},[2,this._inputDevicePromise=_().finally(function(){d._inputDevicePromise=null})]})})},m.prototype._stopMicrophonePermissionListener=function(){var s;!((s=this._microphonePermissionStatus)===null||s===void 0)&&s.removeEventListener&&this._microphonePermissionStatus.removeEventListener("change",this._onMicrophonePermissionStatusChanged)},m.prototype._stopSelectedInputDeviceStream=function(){this._selectedInputDeviceStream&&(this._log.info("Stopping selected device stream"),this._selectedInputDeviceStream.getTracks().forEach(function(s){return s.stop()}))},m.prototype._updateDevices=function(s,g,_){var d=this,u=s.map(function(T){return T.deviceId}),R=Array.from(g.values()).map(function(T){return T.deviceId}),b=[],h=(0,I.difference)(R,u);h.forEach(function(T){var E=g.get(T);E&&(g.delete(T),_(E)&&b.push(E))});var w=!1;if(s.forEach(function(T){var E=g.get(T.deviceId),f=d._wrapMediaDeviceInfo(T);(!E||E.label!==f.label)&&(g.set(T.deviceId,f),w=!0)}),w||h.length){var L="default",l=this.inputDevice&&this.inputDevice.deviceId===L,$=this._defaultInputDeviceStream&&this.availableInputDevices.get(L);(l||$)&&(this._log.warn("Calling getUserMedia after device change to ensure that the           tracks of the active device (default) have not gone stale."),setTimeout(function(){d._setInputDevice(L,!0)},0)),this._log.debug("#deviceChange",b),this.emit("deviceChange",b)}},m.prototype._updateVolumeSource=function(){if(!(!this.inputStream||!this._audioContext||!this._inputVolumeAnalyser)){this._inputVolumeSource&&this._inputVolumeSource.disconnect();try{this._inputVolumeSource=this._audioContext.createMediaStreamSource(this.inputStream),this._inputVolumeSource.connect(this._inputVolumeAnalyser)}catch(s){this._log.warn("Unable to update volume source",s),delete this._inputVolumeSource}}},m.prototype._wrapMediaDeviceInfo=function(s){var g={deviceId:s.deviceId,groupId:s.groupId,kind:s.kind,label:s.label};if(!g.label)if(g.deviceId==="default")g.label="Default";else{var _=this._getUnknownDeviceIndex(s);g.label="Unknown ".concat(D[g.kind]," Device ").concat(_)}return new P.default(g)},m}(i.EventEmitter);return v||(v={}),it.default=v,it}var bt={},To=H&&H.__extends||function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,r){i.__proto__=r}||function(i,r){for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(i[o]=r[o])},t(n,e)};return function(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");t(n,e);function i(){this.constructor=n}n.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}();Object.defineProperty(bt,"__esModule",{value:!0});bt.AudioProcessorEventObserver=void 0;var Eo=me,Io=le,Po=function(t){To(n,t);function n(){var e=t.call(this)||this;return e._log=new Io.default("AudioProcessorEventObserver"),e._log.info("Creating AudioProcessorEventObserver instance"),e.on("enabled",function(){return e._reEmitEvent("enabled")}),e.on("add",function(){return e._reEmitEvent("add")}),e.on("remove",function(){return e._reEmitEvent("remove")}),e.on("create",function(){return e._reEmitEvent("create-processed-stream")}),e.on("destroy",function(){return e._reEmitEvent("destroy-processed-stream")}),e}return n.prototype.destroy=function(){this.removeAllListeners()},n.prototype._reEmitEvent=function(e){this._log.info("AudioProcessor:".concat(e)),this.emit("event",{name:e,group:"audio-processor"})},n}(Eo.EventEmitter);bt.AudioProcessorEventObserver=Po;var Kt={};Object.defineProperty(Kt,"__esModule",{value:!0});var xo=ce,Ao={dtmf0:[1360,960],dtmf1:[1230,720],dtmf2:[1360,720],dtmf3:[1480,720],dtmf4:[1230,790],dtmf5:[1360,790],dtmf6:[1480,790],dtmf7:[1230,870],dtmf8:[1360,870],dtmf9:[1480,870],dtmfh:[1480,960],dtmfs:[1230,960]},Ro=function(){function t(n){var e=this;this._context=n,this._gainNodes=[],this._gainNodes=[this._context.createGain(),this._context.createGain()],this._gainNodes.forEach(function(i){i.connect(e._context.destination),i.gain.value=.1,e._gainNodes.push(i)})}return t.prototype.cleanup=function(){this._gainNodes.forEach(function(n){n.disconnect()})},t.prototype.play=function(n){var e=this,i=Ao[n];if(!i)throw new xo.InvalidArgumentError("Invalid DTMF sound name");var r=[this._context.createOscillator(),this._context.createOscillator()];r.forEach(function(o,c){o.type="sine",o.frequency.value=i[c],o.connect(e._gainNodes[c]),o.start(),o.stop(e._context.currentTime+.1),o.addEventListener("ended",function(){return o.disconnect()})})},t}();Kt.default=Ro;var Xt={},Zt={};Object.defineProperty(Zt,"__esModule",{value:!0});function Do(t,n,e){var i=JSON.stringify(n.body||{}),r=new Headers;n.headers=n.headers||[],Object.entries(n.headers).forEach(function(o){var c=o[0],y=o[1];return r.append(c,y)}),fetch(n.url,{body:i,headers:r,method:t}).then(function(o){return o.text()},e).then(function(o){return e(null,o)},e)}var Yt=Do;Yt.get=function(n,e){return new this("GET",n,e)};Yt.post=function(n,e){return new this("POST",n,e)};Zt.default=Yt;var Mo=H&&H.__extends||function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,r){i.__proto__=r}||function(i,r){for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(i[o]=r[o])},t(n,e)};return function(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");t(n,e);function i(){this.constructor=n}n.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}();Object.defineProperty(Xt,"__esModule",{value:!0});var Oo=me,Lo=le,jo=Zt,ve=function(t){Mo(n,t);function n(e,i,r){var o=t.call(this)||this;if(!(o instanceof n))return new n(e,i,r);r=Object.assign({defaultPayload:function(){return{}}},r);var c=r.defaultPayload;typeof c!="function"&&(c=function(){return Object.assign({},r.defaultPayload)});var y=!0,P=Object.assign({app_name:void 0,app_version:void 0},r.metadata);return Object.defineProperties(o,{_defaultPayload:{value:c},_host:{value:r.host,writable:!0},_isEnabled:{get:function(){return y},set:function(I){y=I}},_log:{value:new Lo.default("EventPublisher")},_request:{value:r.request||jo.default,writable:!0},_token:{value:i,writable:!0},isEnabled:{enumerable:!0,get:function(){return y}},metadata:{enumerable:!0,get:function(){return P}},productName:{enumerable:!0,value:e},token:{enumerable:!0,get:function(){return this._token}}}),o}return n}(Oo.EventEmitter);ve.prototype._post=function(n,e,i,r,o,c,y){var P=this;if(!this.isEnabled&&!y||!this._host)return this._log.debug("Publishing cancelled",JSON.stringify({isEnabled:this.isEnabled,force:y,host:this._host})),Promise.resolve();if(!c||(!c.parameters||!c.parameters.CallSid)&&!c.outboundConnectionId)return c?this._log.debug("Publishing cancelled. Missing connection info",JSON.stringify({outboundConnectionId:c.outboundConnectionId,parameters:c.parameters})):this._log.debug("Publishing cancelled. Missing connection object"),Promise.resolve();var I={group:i,level:e.toUpperCase(),name:r,payload:o&&o.forEach?o.slice(0):Object.assign(this._defaultPayload(c),o),payload_type:"application/json",private:!1,publisher:this.productName,timestamp:new Date().toISOString()};this.metadata&&(I.publisher_metadata=this.metadata),n==="EndpointEvents"&&this._log.debug("Publishing insights",JSON.stringify({endpointName:n,event:I,force:y,host:this._host}));var D={body:I,headers:{"Content-Type":"application/json","X-Twilio-Token":this.token},url:"https://".concat(this._host,"/v4/").concat(n)};return new Promise(function(v,p){P._request.post(D,function(m){m?(P.emit("error",m),p(m)):v()})}).catch(function(v){P._log.error("Unable to post ".concat(i," ").concat(r," event to Insights. Received error: ").concat(v))})};ve.prototype.post=function(n,e,i,r,o,c){return this._post("EndpointEvents",n,e,i,r,o,c)};ve.prototype.debug=function(n,e,i,r){return this.post("debug",n,e,i,r)};ve.prototype.info=function(n,e,i,r){return this.post("info",n,e,i,r)};ve.prototype.warn=function(n,e,i,r){return this.post("warning",n,e,i,r)};ve.prototype.error=function(n,e,i,r){return this.post("error",n,e,i,r)};ve.prototype.postMetrics=function(n,e,i,r,o){var c=this;return new Promise(function(y){var P=i.map(Uo).map(function(I){return Object.assign(I,r)});y(c._post("EndpointMetrics","info",n,e,P,o))})};ve.prototype.setHost=function(n){this._host=n};ve.prototype.setToken=function(n){this._token=n};ve.prototype.enable=function(){this._isEnabled=!0};ve.prototype.disable=function(){this._isEnabled=!1};function Uo(t){return{audio_codec:t.codecName,audio_level_in:t.audioInputLevel,audio_level_out:t.audioOutputLevel,bytes_received:t.bytesReceived,bytes_sent:t.bytesSent,call_volume_input:t.inputVolume,call_volume_output:t.outputVolume,jitter:t.jitter,mos:t.mos&&Math.round(t.mos*100)/100,packets_lost:t.packetsLost,packets_lost_fraction:t.packetsLostFraction&&Math.round(t.packetsLostFraction*100)/100,packets_received:t.packetsReceived,rtt:t.rtt,timestamp:new Date(t.timestamp).toISOString(),total_bytes_received:t.totals.bytesReceived,total_bytes_sent:t.totals.bytesSent,total_packets_lost:t.totals.packetsLost,total_packets_received:t.totals.packetsReceived,total_packets_sent:t.totals.packetsSent}}Xt.default=ve;var Me={},Je={},en={};Object.defineProperty(en,"__esModule",{value:!0});var En=32767,In=typeof window<"u"?window.RTCStatsReport:void 0;function _e(t){if(!(this instanceof _e))return new _e(t);var n=this;Object.defineProperties(this,{_map:{value:t},size:{enumerable:!0,get:function(){return n._map.size}}}),this[Symbol.iterator]=t[Symbol.iterator]}In&&(_e.prototype=Object.create(In.prototype),_e.prototype.constructor=_e);["entries","forEach","get","has","keys","values"].forEach(function(t){_e.prototype[t]=function(){for(var n,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return(n=this._map)[t].apply(n,e)}});_e.fromArray=function(n){return new _e(n.reduce(function(e,i){return e.set(i.id,i),e},new Map))};_e.fromRTCStatsResponse=function(n){var e,i=new Map,r=n.result().reduce(function(c,y){var P=y.id;switch(y.type){case"googCertificate":c.set(P,Ho(y));break;case"datachannel":c.set(P,Wo(y));break;case"googCandidatePair":Ii(y,"googActiveConnection")&&(e=P),c.set(P,Bo(y));break;case"localcandidate":c.set(P,xn(y,!1));break;case"remotecandidate":c.set(P,xn(y,!0));break;case"ssrc":xe(y,"packetsReceived")?c.set("rtp-".concat(P),Vo(y)):c.set("rtp-".concat(P),$o(y)),c.set("track-".concat(P),Fo(y)),c.set("codec-".concat(P),No(y));break;case"googComponent":var I=Pn(y);i.set(I.selectedCandidatePairId,P),c.set(P,Pn(y));break}return c},new Map);if(e){var o=i.get(e);o&&(r.get(o).dtlsState="connected")}return new _e(r)};function Pn(t){return{bytesReceived:void 0,bytesSent:void 0,dtlsState:void 0,id:t.id,localCertificateId:t.stat("localCertificateId"),remoteCertificateId:t.stat("remoteCertificateId"),rtcpTransportStatsId:void 0,selectedCandidatePairId:t.stat("selectedCandidatePairId"),timestamp:Date.parse(t.timestamp),type:"transport"}}function No(t){return{channels:void 0,clockRate:void 0,id:t.id,implementation:void 0,mimeType:"".concat(t.stat("mediaType"),"/").concat(t.stat("googCodecName")),payloadType:void 0,sdpFmtpLine:void 0,timestamp:Date.parse(t.timestamp),type:"codec"}}function Fo(t){return{audioLevel:xe(t,"audioOutputLevel")?ee(t,"audioOutputLevel")/En:(ee(t,"audioInputLevel")||0)/En,detached:void 0,echoReturnLoss:Nt(t,"googEchoCancellationReturnLoss"),echoReturnLossEnhancement:Nt(t,"googEchoCancellationReturnLossEnhancement"),ended:void 0,frameHeight:xe(t,"googFrameHeightReceived")?ee(t,"googFrameHeightReceived"):ee(t,"googFrameHeightSent"),frameWidth:xe(t,"googFrameWidthReceived")?ee(t,"googFrameWidthReceived"):ee(t,"googFrameWidthSent"),framesCorrupted:void 0,framesDecoded:ee(t,"framesDecoded"),framesDropped:void 0,framesPerSecond:void 0,framesReceived:void 0,framesSent:ee(t,"framesEncoded"),fullFramesLost:void 0,id:t.id,kind:t.stat("mediaType"),partialFramesLost:void 0,remoteSource:void 0,ssrcIds:void 0,timestamp:Date.parse(t.timestamp),trackIdentifier:t.stat("googTrackId"),type:"track"}}function Ei(t,n){return{associateStatsId:void 0,codecId:"codec-".concat(t.id),firCount:n?ee(t,"googFirsSent"):void 0,id:t.id,isRemote:void 0,mediaType:t.stat("mediaType"),nackCount:n?ee(t,"googNacksSent"):ee(t,"googNacksReceived"),pliCount:n?ee(t,"googPlisSent"):ee(t,"googPlisReceived"),qpSum:ee(t,"qpSum"),sliCount:void 0,ssrc:t.stat("ssrc"),timestamp:Date.parse(t.timestamp),trackId:"track-".concat(t.id),transportId:t.stat("transportId")}}function Vo(t){var n=Ei(t,!0);return Object.assign(n,{burstDiscardCount:void 0,burstDiscardRate:void 0,burstLossCount:void 0,burstLossRate:void 0,burstPacketsDiscarded:void 0,burstPacketsLost:void 0,bytesReceived:ee(t,"bytesReceived"),fractionLost:void 0,framesDecoded:ee(t,"framesDecoded"),gapDiscardRate:void 0,gapLossRate:void 0,jitter:Ut(t.stat("googJitterReceived")),packetsDiscarded:void 0,packetsLost:ee(t,"packetsLost"),packetsReceived:ee(t,"packetsReceived"),packetsRepaired:void 0,roundTripTime:Ut(t.stat("googRtt")),type:"inbound-rtp"}),n}function $o(t){var n=Ei(t,!1);return Object.assign(n,{bytesSent:ee(t,"bytesSent"),framesEncoded:ee(t,"framesEncoded"),packetsSent:ee(t,"packetsSent"),remoteTimestamp:void 0,targetBitrate:void 0,type:"outbound-rtp"}),n}function xn(t,n){return{candidateType:qo(t.stat("candidateType")),deleted:void 0,id:t.id,ip:t.stat("ipAddress"),isRemote:n,port:ee(t,"portNumber"),priority:Nt(t,"priority"),protocol:t.stat("transport"),relayProtocol:void 0,timestamp:Date.parse(t.timestamp),transportId:void 0,type:n?"remote-candidate":"local-candidate",url:void 0}}function Bo(t){return{availableIncomingBitrate:void 0,availableOutgoingBitrate:void 0,bytesReceived:ee(t,"bytesReceived"),bytesSent:ee(t,"bytesSent"),consentRequestsSent:ee(t,"consentRequestsSent"),currentRoundTripTime:Ut(t.stat("googRtt")),id:t.id,lastPacketReceivedTimestamp:void 0,lastPacketSentTimestamp:void 0,localCandidateId:t.stat("localCandidateId"),nominated:void 0,priority:void 0,readable:void 0,remoteCandidateId:t.stat("remoteCandidateId"),requestsReceived:ee(t,"requestsReceived"),requestsSent:ee(t,"requestsSent"),responsesReceived:ee(t,"responsesReceived"),responsesSent:ee(t,"responsesSent"),retransmissionsReceived:void 0,retransmissionsSent:void 0,state:void 0,timestamp:Date.parse(t.timestamp),totalRoundTripTime:void 0,transportId:t.stat("googChannelId"),type:"candidate-pair",writable:Ii(t,"googWritable")}}function Ho(t){return{base64Certificate:t.stat("googDerBase64"),fingerprint:t.stat("googFingerprint"),fingerprintAlgorithm:t.stat("googFingerprintAlgorithm"),id:t.id,issuerCertificateId:t.stat("googIssuerId"),timestamp:Date.parse(t.timestamp),type:"certificate"}}function Wo(t){return{bytesReceived:void 0,bytesSent:void 0,datachannelid:t.stat("datachannelid"),id:t.id,label:t.stat("label"),messagesReceived:void 0,messagesSent:void 0,protocol:t.stat("protocol"),state:t.stat("state"),timestamp:Date.parse(t.timestamp),transportId:t.stat("transportId"),type:"data-channel"}}function Ut(t){return isNaN(t)||t===""?void 0:parseInt(t,10)/1e3}function qo(t){switch(t){case"peerreflexive":return"prflx";case"serverreflexive":return"srflx";case"host":case"relay":default:return t}}function ee(t,n){var e=t.stat(n);return xe(t,n)?parseInt(e,10):void 0}function Nt(t,n){var e=t.stat(n);return xe(t,n)?parseFloat(e):void 0}function Ii(t,n){var e=t.stat(n);return xe(t,n)?e==="true"||e===!0:void 0}function xe(t,n){var e=t.stat(n);return typeof e<"u"&&e!==""}en.default=_e;var An=H&&H.__spreadArray||function(t,n,e){if(e||arguments.length===2)for(var i=0,r=n.length,o;i<r;i++)(o||!(i in n))&&(o||(o=Array.prototype.slice.call(n,0,i)),o[i]=n[i]);return t.concat(o||Array.prototype.slice.call(n))};Object.defineProperty(Je,"__esModule",{value:!0});Je.getRTCStats=Qo;Je.getRTCIceCandidateStatsReport=Ko;var Rn=ce,Go=en,zo="PeerConnection is null",Jo="WebRTC statistics are unsupported";function Oe(t,n){return typeof t.get=="function"?t.get(n):t.find(function(e){return e.id===n})}function Pi(t){if(!t)return Promise.reject(new Rn.InvalidArgumentError(zo));if(typeof t.getStats!="function")return Promise.reject(new Rn.NotSupportedError(Jo));var n;try{n=t.getStats()}catch{n=new Promise(function(i){return t.getStats(i)}).then(Go.default.fromRTCStatsResponse)}return n}function Qo(t,n){return n=Object.assign({createRTCSample:Zo},n),Pi(t).then(n.createRTCSample)}function Ko(t){return Pi(t).then(function(n){var e=Array.from(n.values()).reduce(function(I,D){switch(["candidatePairs","localCandidates","remoteCandidates"].forEach(function(v){I[v]||(I[v]=[])}),D.type){case"candidate-pair":I.candidatePairs.push(D);break;case"local-candidate":I.localCandidates.push(D);break;case"remote-candidate":I.remoteCandidates.push(D);break;case"transport":D.selectedCandidatePairId&&(I.transport=D);break}return I},{}),i=e.candidatePairs,r=e.localCandidates,o=e.remoteCandidates,c=e.transport,y=i.find(function(I){return I.selected||c&&I.id===c.selectedCandidatePairId}),P;return y&&(P={localCandidate:r.find(function(I){return I.id===y.localCandidateId}),remoteCandidate:o.find(function(I){return I.id===y.remoteCandidateId})}),{iceCandidateStats:An(An([],r,!0),o,!0),selectedIceCandidatePairStats:P}})}function Xo(){}function Zo(t){var n=null,e=new Xo,i;Array.from(t.values()).forEach(function(P){if(!P.isRemote){var I=P.type.replace("-","");if(i=i||P.timestamp,P.remoteId){var D=Oe(t,P.remoteId);D&&D.roundTripTime&&(e.rtt=D.roundTripTime*1e3)}switch(I){case"inboundrtp":e.timestamp=e.timestamp||P.timestamp,e.jitter=P.jitter*1e3,e.packetsLost=P.packetsLost,e.packetsReceived=P.packetsReceived,e.bytesReceived=P.bytesReceived;break;case"outboundrtp":if(e.timestamp=P.timestamp,e.packetsSent=P.packetsSent,e.bytesSent=P.bytesSent,P.codecId){var v=Oe(t,P.codecId);e.codecName=v?v.mimeType&&v.mimeType.match(/(.*\/)?(.*)/)[2]:P.codecId}break;case"transport":n=P.id;break}}}),e.timestamp||(e.timestamp=i);var r=Oe(t,n);if(!r)return e;var o=Oe(t,r.selectedCandidatePairId);if(!o)return e;var c=Oe(t,o.localCandidateId),y=Oe(t,o.remoteCandidateId);return e.rtt||(e.rtt=o&&o.currentRoundTripTime*1e3),Object.assign(e,{localAddress:c&&(c.address||c.ip),remoteAddress:y&&(y.address||y.ip)}),e}var Dn;function xi(){if(Dn)return Me;Dn=1;var t=H&&H.__extends||function(){var p=function(m,s){return p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,_){g.__proto__=_}||function(g,_){for(var d in _)Object.prototype.hasOwnProperty.call(_,d)&&(g[d]=_[d])},p(m,s)};return function(m,s){if(typeof s!="function"&&s!==null)throw new TypeError("Class extends value "+String(s)+" is not a constructor or null");p(m,s);function g(){this.constructor=m}m.prototype=s===null?Object.create(s):(g.prototype=s.prototype,new g)}}(),n=H&&H.__assign||function(){return n=Object.assign||function(p){for(var m,s=1,g=arguments.length;s<g;s++){m=arguments[s];for(var _ in m)Object.prototype.hasOwnProperty.call(m,_)&&(p[_]=m[_])}return p},n.apply(this,arguments)},e=H&&H.__awaiter||function(p,m,s,g){function _(d){return d instanceof s?d:new s(function(u){u(d)})}return new(s||(s=Promise))(function(d,u){function R(w){try{h(g.next(w))}catch(L){u(L)}}function b(w){try{h(g.throw(w))}catch(L){u(L)}}function h(w){w.done?d(w.value):_(w.value).then(R,b)}h((g=g.apply(p,m||[])).next())})},i=H&&H.__generator||function(p,m){var s={label:0,sent:function(){if(d[0]&1)throw d[1];return d[1]},trys:[],ops:[]},g,_,d,u=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return u.next=R(0),u.throw=R(1),u.return=R(2),typeof Symbol=="function"&&(u[Symbol.iterator]=function(){return this}),u;function R(h){return function(w){return b([h,w])}}function b(h){if(g)throw new TypeError("Generator is already executing.");for(;u&&(u=0,h[0]&&(s=0)),s;)try{if(g=1,_&&(d=h[0]&2?_.return:h[0]?_.throw||((d=_.return)&&d.call(_),0):_.next)&&!(d=d.call(_,h[1])).done)return d;switch(_=0,d&&(h=[h[0]&2,d.value]),h[0]){case 0:case 1:d=h;break;case 4:return s.label++,{value:h[1],done:!1};case 5:s.label++,_=h[1],h=[0];continue;case 7:h=s.ops.pop(),s.trys.pop();continue;default:if(d=s.trys,!(d=d.length>0&&d[d.length-1])&&(h[0]===6||h[0]===2)){s=0;continue}if(h[0]===3&&(!d||h[1]>d[0]&&h[1]<d[3])){s.label=h[1];break}if(h[0]===6&&s.label<d[1]){s.label=d[1],d=h;break}if(d&&s.label<d[2]){s.label=d[2],s.ops.push(h);break}d[2]&&s.ops.pop(),s.trys.pop();continue}h=m.call(p,s)}catch(w){h=[6,w],_=0}finally{g=d=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}};Object.defineProperty(Me,"__esModule",{value:!0}),Me.PreflightTest=void 0;var r=me,o=pn(),c=Et(),y=ce,P=le,I=Je,D=se,v=function(p){t(m,p);function m(s,g){var _=p.call(this)||this;_._hasInsightsErrored=!1,_._log=new P.default("PreflightTest"),_._networkTiming={},_._options={codecPreferences:[o.default.Codec.PCMU,o.default.Codec.Opus],edge:"roaming",fakeMicInput:!1,logLevel:"error",signalingTimeoutMs:1e4},_._status=m.Status.Connecting,Object.assign(_._options,g),_._samples=[],_._warnings=[],_._startTime=Date.now(),_._initDevice(s,n(n({},_._options),{fileInputStream:_._options.fakeMicInput?_._getStreamFromFile():void 0}));var d=["codecPreferences","edge","fakeMicInput","logLevel","signalingTimeoutMs"],u=["audioContext","deviceFactory","fileInputStream","getRTCIceCandidateStatsReport","iceServers","rtcConfiguration"];if(typeof g=="object"){var R=n({},g);Object.keys(R).forEach(function(b){!d.includes(b)&&!u.includes(b)&&delete R[b],u.includes(b)&&(R[b]=!0)}),_._log.debug(".constructor",JSON.stringify(R))}return _}return m.prototype.stop=function(){var s=this;this._log.debug(".stop");var g=new y.GeneralErrors.CallCancelledError;this._device?(this._device.once(c.default.EventName.Unregistered,function(){return s._onFailed(g)}),this._device.destroy()):this._onFailed(g)},m.prototype._emitWarning=function(s,g,_){var d={name:s,description:g};_&&(d.rtcWarning=_),this._warnings.push(d),this._log.debug("#".concat(m.Events.Warning),JSON.stringify(d)),this.emit(m.Events.Warning,d)},m.prototype._getCallQuality=function(s){return s>4.2?m.CallQuality.Excellent:s>=4.1&&s<=4.2?m.CallQuality.Great:s>=3.7&&s<=4?m.CallQuality.Good:s>=3.1&&s<=3.6?m.CallQuality.Fair:m.CallQuality.Degraded},m.prototype._getReport=function(){var s,g,_,d=this._getRTCStats(),u={start:this._startTime};this._endTime&&(u.end=this._endTime,u.duration=this._endTime-this._startTime);var R={callSid:this._callSid,edge:this._edge,iceCandidateStats:(g=(s=this._rtcIceCandidateStatsReport)===null||s===void 0?void 0:s.iceCandidateStats)!==null&&g!==void 0?g:[],networkTiming:this._networkTiming,samples:this._samples,selectedEdge:this._options.edge,stats:d,testTiming:u,totals:this._getRTCSampleTotals(),warnings:this._warnings},b=(_=this._rtcIceCandidateStatsReport)===null||_===void 0?void 0:_.selectedIceCandidatePairStats;return b&&(R.selectedIceCandidatePairStats=b,R.isTurnRequired=b.localCandidate.candidateType==="relay"||b.remoteCandidate.candidateType==="relay"),d&&(R.callQuality=this._getCallQuality(d.mos.average)),R},m.prototype._getRTCSampleTotals=function(){if(this._latestSample)return n({},this._latestSample.totals)},m.prototype._getRTCStats=function(){var s=this._samples.findIndex(function(_){return typeof _.mos=="number"&&_.mos>0}),g=s>=0?this._samples.slice(s):[];if(!(!g||!g.length))return["jitter","mos","rtt"].reduce(function(_,d){var u,R=g.map(function(b){return b[d]});return n(n({},_),(u={},u[d]={average:Number((R.reduce(function(b,h){return b+h})/R.length).toPrecision(5)),max:Math.max.apply(Math,R),min:Math.min.apply(Math,R)},u))},{})},m.prototype._getStreamFromFile=function(){var s=this._options.audioContext;if(!s)throw new y.NotSupportedError("Cannot fake input audio stream: AudioContext is not supported by this browser.");var g=new Audio(D.COWBELL_AUDIO_URL);g.addEventListener("canplaythrough",function(){return g.play()}),typeof g.setAttribute=="function"&&g.setAttribute("crossorigin","anonymous");var _=s.createMediaElementSource(g),d=s.createMediaStreamDestination();return _.connect(d),d.stream},m.prototype._initDevice=function(s,g){var _=this;try{this._device=new(g.deviceFactory||c.default)(s,{chunderw:g.chunderw,codecPreferences:g.codecPreferences,edge:g.edge,eventgw:g.eventgw,fileInputStream:g.fileInputStream,logLevel:g.logLevel,preflight:!0}),this._device.once(c.default.EventName.Registered,function(){_._onDeviceRegistered()}),this._device.once(c.default.EventName.Error,function(d){_._onDeviceError(d)}),this._device.register()}catch(d){setTimeout(function(){_._onFailed(d)});return}this._signalingTimeoutTimer=setTimeout(function(){_._onDeviceError(new y.SignalingErrors.ConnectionError("WebSocket Connection Timeout"))},g.signalingTimeoutMs)},m.prototype._onDeviceError=function(s){this._device.destroy(),this._onFailed(s)},m.prototype._onDeviceRegistered=function(){return e(this,void 0,void 0,function(){var s,g,_,d=this;return i(this,function(u){switch(u.label){case 0:return clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),s=this,[4,this._device.connect({rtcConfiguration:this._options.rtcConfiguration})];case 1:return s._call=u.sent(),this._networkTiming.signaling={start:Date.now()},this._setupCallHandlers(this._call),this._edge=this._device.edge||void 0,this._options.fakeMicInput&&(this._echoTimer=setTimeout(function(){return d._device.disconnectAll()},D.ECHO_TEST_DURATION),g=this._device.audio,g&&(g.disconnect(!1),g.outgoing(!1))),this._call.once("disconnect",function(){d._device.once(c.default.EventName.Unregistered,function(){return d._onUnregistered()}),d._device.destroy()}),_=this._call._publisher,_.on("error",function(){d._hasInsightsErrored||d._emitWarning("insights-connection-error","Received an error when attempting to connect to Insights gateway"),d._hasInsightsErrored=!0}),[2]}})})},m.prototype._onFailed=function(s){clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),this._releaseHandlers(),this._endTime=Date.now(),this._status=m.Status.Failed,this._log.debug("#".concat(m.Events.Failed),s),this.emit(m.Events.Failed,s)},m.prototype._onUnregistered=function(){var s=this;setTimeout(function(){s._status!==m.Status.Failed&&(clearTimeout(s._echoTimer),clearTimeout(s._signalingTimeoutTimer),s._releaseHandlers(),s._endTime=Date.now(),s._status=m.Status.Completed,s._report=s._getReport(),s._log.debug("#".concat(m.Events.Completed),JSON.stringify(s._report)),s.emit(m.Events.Completed,s._report))},10)},m.prototype._releaseHandlers=function(){[this._device,this._call].forEach(function(s){s&&s.eventNames().forEach(function(g){return s.removeAllListeners(g)})})},m.prototype._setupCallHandlers=function(s){var g=this;this._options.fakeMicInput&&s.once("volume",function(){s._mediaHandler.outputs.forEach(function(_){return _.audio.muted=!0})}),s.on("warning",function(_,d){g._emitWarning(_,"Received an RTCWarning. See .rtcWarning for the RTCWarning",d)}),s.once("accept",function(){g._callSid=s._mediaHandler.callSid,g._status=m.Status.Connected,g._log.debug("#".concat(m.Events.Connected)),g.emit(m.Events.Connected)}),s.on("sample",function(_){return e(g,void 0,void 0,function(){var d;return i(this,function(u){switch(u.label){case 0:return this._latestSample?[3,2]:(d=this,[4,(this._options.getRTCIceCandidateStatsReport||I.getRTCIceCandidateStatsReport)(s._mediaHandler.version.pc)]);case 1:d._rtcIceCandidateStatsReport=u.sent(),u.label=2;case 2:return this._latestSample=_,this._samples.push(_),this._log.debug("#".concat(m.Events.Sample),JSON.stringify(_)),this.emit(m.Events.Sample,_),[2]}})})}),[{reportLabel:"peerConnection",type:"pcconnection"},{reportLabel:"ice",type:"iceconnection"},{reportLabel:"dtls",type:"dtlstransport"},{reportLabel:"signaling",type:"signaling"}].forEach(function(_){var d=_.type,u=_.reportLabel,R="on".concat(d,"statechange"),b=s._mediaHandler[R];s._mediaHandler[R]=function(h){var w=g._networkTiming[u]=g._networkTiming[u]||{start:0};h==="connecting"||h==="checking"?w.start=Date.now():(h==="connected"||h==="stable")&&!w.duration&&(w.end=Date.now(),w.duration=w.end-w.start),b(h)}})},Object.defineProperty(m.prototype,"callSid",{get:function(){return this._callSid},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"endTime",{get:function(){return this._endTime},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"latestSample",{get:function(){return this._latestSample},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"report",{get:function(){return this._report},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"startTime",{get:function(){return this._startTime},enumerable:!1,configurable:!0}),Object.defineProperty(m.prototype,"status",{get:function(){return this._status},enumerable:!1,configurable:!0}),m}(r.EventEmitter);return Me.PreflightTest=v,function(p){(function(m){m.Excellent="excellent",m.Great="great",m.Good="good",m.Fair="fair",m.Degraded="degraded"})(p.CallQuality||(p.CallQuality={})),function(m){m.Completed="completed",m.Connected="connected",m.Failed="failed",m.Sample="sample",m.Warning="warning"}(p.Events||(p.Events={})),function(m){m.Connecting="connecting",m.Connected="connected",m.Completed="completed",m.Failed="failed"}(p.Status||(p.Status={}))}(v||(Me.PreflightTest=v={})),Me}var tn={},Qe={},Yo=H&&H.__extends||function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,r){i.__proto__=r}||function(i,r){for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(i[o]=r[o])},t(n,e)};return function(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");t(n,e);function i(){this.constructor=n}n.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),vt=H&&H.__assign||function(){return vt=Object.assign||function(t){for(var n,e=1,i=arguments.length;e<i;e++){n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},vt.apply(this,arguments)};Object.defineProperty(Qe,"__esModule",{value:!0});Qe.WSTransportState=void 0;var ea=me,Mn=yt,Rt=ce,ta=le,Le=globalThis.WebSocket,na=1e4,ia=5e3,On=15e3,ra=15e3,oa=1/0,aa=1e3,sa=2e4,de;(function(t){t.Connecting="connecting",t.Closed="closed",t.Open="open"})(de||(Qe.WSTransportState=de={}));var ca=function(t){Yo(n,t);function n(e,i){i===void 0&&(i={});var r=t.call(this)||this;return r.state=de.Closed,r._backoffStartTime={preferred:null,primary:null},r._connectedUri=null,r._log=new ta.default("WSTransport"),r._shouldFallback=!1,r._uriIndex=0,r._moveUriIndex=function(){r._uriIndex++,r._uriIndex>=r._uris.length&&(r._uriIndex=0)},r._onSocketClose=function(o){if(r._log.error("Received websocket close event code: ".concat(o.code,". Reason: ").concat(o.reason)),o.code===1006||o.code===1015){r.emit("error",{code:31005,message:o.reason||"Websocket connection to Twilio's signaling servers were unexpectedly ended. If this is happening consistently, there may be an issue resolving the hostname provided. If a region or an edge is being specified in Device setup, ensure it is valid.",twilioError:new Rt.SignalingErrors.ConnectionError});var c=r.state===de.Open||r._previousState===de.Open;(r._shouldFallback||!c)&&r._moveUriIndex(),r._shouldFallback=!0}r._closeSocket()},r._onSocketError=function(o){r._log.error("WebSocket received error: ".concat(o.message)),r.emit("error",{code:31e3,message:o.message||"WSTransport socket error",twilioError:new Rt.SignalingErrors.ConnectionDisconnected})},r._onSocketMessage=function(o){if(r._setHeartbeatTimeout(),r._socket&&o.data===`
`){r._socket.send(`
`),r._log.debug("heartbeat");return}o&&typeof o.data=="string"&&r._log.debug("Received: ".concat(o.data)),r.emit("message",o)},r._onSocketOpen=function(){r._log.info("WebSocket opened successfully."),r._timeOpened=Date.now(),r._shouldFallback=!1,r._setState(de.Open),clearTimeout(r._connectTimeout),r._resetBackoffs(),r._setHeartbeatTimeout(),r.emit("open")},r._options=vt(vt({},n.defaultConstructorOptions),i),r._uris=e,r._backoff=r._setupBackoffs(),r}return n.prototype.close=function(){this._log.info("WSTransport.close() called..."),this._close()},n.prototype.open=function(){if(this._log.info("WSTransport.open() called..."),this._socket&&(this._socket.readyState===Le.CONNECTING||this._socket.readyState===Le.OPEN)){this._log.info("WebSocket already open.");return}this._preferredUri?this._connect(this._preferredUri):this._connect(this._uris[this._uriIndex])},n.prototype.send=function(e){if(this._log.debug("Sending: ".concat(e)),!this._socket||this._socket.readyState!==Le.OPEN)return this._log.debug("Cannot send message. WebSocket is not open."),!1;try{this._socket.send(e)}catch(i){return this._log.error("Error while sending message:",i.message),this._closeSocket(),!1}return!0},n.prototype.updatePreferredURI=function(e){this._preferredUri=e},n.prototype.updateURIs=function(e){typeof e=="string"&&(e=[e]),this._uris=e,this._uriIndex=0},n.prototype._close=function(){this._setState(de.Closed),this._closeSocket()},n.prototype._closeSocket=function(){if(clearTimeout(this._connectTimeout),clearTimeout(this._heartbeatTimeout),this._log.info("Closing and cleaning up WebSocket..."),!this._socket){this._log.info("No WebSocket to clean up.");return}this._socket.removeEventListener("close",this._onSocketClose),this._socket.removeEventListener("error",this._onSocketError),this._socket.removeEventListener("message",this._onSocketMessage),this._socket.removeEventListener("open",this._onSocketOpen),(this._socket.readyState===Le.CONNECTING||this._socket.readyState===Le.OPEN)&&this._socket.close(),this._timeOpened&&Date.now()-this._timeOpened>na&&this._resetBackoffs(),this.state!==de.Closed&&this._performBackoff(),delete this._socket,this.emit("close")},n.prototype._connect=function(e,i){var r=this;this._log.info(typeof i=="number"?"Attempting to reconnect (retry #".concat(i,")..."):"Attempting to connect..."),this._closeSocket(),this._setState(de.Connecting),this._connectedUri=e;try{this._socket=new this._options.WebSocket(this._connectedUri)}catch(o){this._log.error("Could not connect to endpoint:",o.message),this._close(),this.emit("error",{code:31e3,message:o.message||"Could not connect to ".concat(this._connectedUri),twilioError:new Rt.SignalingErrors.ConnectionDisconnected});return}this._socket.addEventListener("close",this._onSocketClose),this._socket.addEventListener("error",this._onSocketError),this._socket.addEventListener("message",this._onSocketMessage),this._socket.addEventListener("open",this._onSocketOpen),delete this._timeOpened,this._connectTimeout=setTimeout(function(){r._log.info("WebSocket connection attempt timed out."),r._moveUriIndex(),r._closeSocket()},this._options.connectTimeoutMs)},n.prototype._performBackoff=function(){this._preferredUri?(this._log.info("Preferred URI set; backing off."),this._backoff.preferred.backoff()):(this._log.info("Preferred URI not set; backing off."),this._backoff.primary.backoff())},n.prototype._resetBackoffs=function(){this._backoff.preferred.reset(),this._backoff.primary.reset(),this._backoffStartTime.preferred=null,this._backoffStartTime.primary=null},n.prototype._setHeartbeatTimeout=function(){var e=this;clearTimeout(this._heartbeatTimeout),this._heartbeatTimeout=setTimeout(function(){e._log.info("No messages received in ".concat(On/1e3," seconds. Reconnecting...")),e._shouldFallback=!0,e._closeSocket()},On)},n.prototype._setState=function(e){this._previousState=this.state,this.state=e},n.prototype._setupBackoffs=function(){var e=this,i={factor:2,jitter:.4,max:this._options.maxPreferredDelayMs,min:100};this._log.info("Initializing preferred transport backoff using config: ",i);var r=new Mn.default(i);r.on("backoff",function(y,P){if(e.state===de.Closed){e._log.info("Preferred backoff initiated but transport state is closed; not attempting a connection.");return}e._log.info("Will attempt to reconnect Websocket to preferred URI in ".concat(P,"ms")),y===0&&(e._backoffStartTime.preferred=Date.now(),e._log.info("Preferred backoff start; ".concat(e._backoffStartTime.preferred)))}),r.on("ready",function(y,P){if(e.state===de.Closed){e._log.info("Preferred backoff ready but transport state is closed; not attempting a connection.");return}if(e._backoffStartTime.preferred===null){e._log.info("Preferred backoff start time invalid; not attempting a connection.");return}if(Date.now()-e._backoffStartTime.preferred>e._options.maxPreferredDurationMs){e._log.info("Max preferred backoff attempt time exceeded; falling back to primary backoff."),e._preferredUri=null,e._backoff.primary.backoff();return}if(typeof e._preferredUri!="string"){e._log.info("Preferred URI cleared; falling back to primary backoff."),e._preferredUri=null,e._backoff.primary.backoff();return}e._connect(e._preferredUri,y+1)});var o={factor:2,jitter:.4,max:this._options.maxPrimaryDelayMs,min:this._uris&&this._uris.length>1?Math.floor(Math.random()*(5e3-1e3+1))+1e3:100};this._log.info("Initializing primary transport backoff using config: ",o);var c=new Mn.default(o);return c.on("backoff",function(y,P){if(e.state===de.Closed){e._log.info("Primary backoff initiated but transport state is closed; not attempting a connection.");return}e._log.info("Will attempt to reconnect WebSocket in ".concat(P,"ms")),y===0&&(e._backoffStartTime.primary=Date.now(),e._log.info("Primary backoff start; ".concat(e._backoffStartTime.primary)))}),c.on("ready",function(y,P){if(e.state===de.Closed){e._log.info("Primary backoff ready but transport state is closed; not attempting a connection.");return}if(e._backoffStartTime.primary===null){e._log.info("Primary backoff start time invalid; not attempting a connection.");return}if(Date.now()-e._backoffStartTime.primary>e._options.maxPrimaryDurationMs){e._log.info("Max primary backoff attempt time exceeded; not attempting a connection.");return}e._connect(e._uris[e._uriIndex],y+1)}),{preferred:r,primary:c}},Object.defineProperty(n.prototype,"uri",{get:function(){return this._connectedUri},enumerable:!1,configurable:!0}),n.defaultConstructorOptions={WebSocket:Le,connectTimeoutMs:ia,maxPreferredDelayMs:aa,maxPreferredDurationMs:ra,maxPrimaryDelayMs:sa,maxPrimaryDurationMs:oa},n}(ea.EventEmitter);Qe.default=ca;var la=H&&H.__extends||function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,r){i.__proto__=r}||function(i,r){for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(i[o]=r[o])},t(n,e)};return function(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");t(n,e);function i(){this.constructor=n}n.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}();Object.defineProperty(tn,"__esModule",{value:!0});var ua=me,da=se,nn=ce,fa=le,pa=Qe,ha="1.6",va=30,oe=function(t){la(n,t);function n(e,i,r){var o=t.call(this)||this;if(!(o instanceof n))return new n(e,i,r);var c={TransportFactory:pa.default};r=r||{};for(var y in c)y in r||(r[y]=c[y]);o.options=r,o.token=e||"",o.status="disconnected",o.gateway=null,o.region=null,o._messageQueue=[],o._preferredUri=null,o._uris=i,o._handleTransportClose=o._handleTransportClose.bind(o),o._handleTransportError=o._handleTransportError.bind(o),o._handleTransportMessage=o._handleTransportMessage.bind(o),o._handleTransportOpen=o._handleTransportOpen.bind(o),o._log=new fa.default("PStream"),o.on("error",function(){o._log.warn("Unexpected error handled in pstream")});var P=o;return o.addListener("ready",function(){P.status="ready"}),o.addListener("offline",function(){P.status="offline"}),o.addListener("close",function(){P._log.info('Received "close" from server. Destroying PStream...'),P._destroy()}),o.transport=new o.options.TransportFactory(o._uris,{backoffMaxMs:o.options.backoffMaxMs,maxPreferredDurationMs:o.options.maxPreferredDurationMs}),Object.defineProperties(o,{uri:{enumerable:!0,get:function(){return this.transport.uri}}}),o.transport.on("close",o._handleTransportClose),o.transport.on("error",o._handleTransportError),o.transport.on("message",o._handleTransportMessage),o.transport.on("open",o._handleTransportOpen),o.transport.open(),o}return n}(ua.EventEmitter);oe.prototype._handleTransportClose=function(){this.emit("transportClose"),this.status!=="disconnected"&&(this.status!=="offline"&&this.emit("offline",this),this.status="disconnected")};oe.prototype._handleTransportError=function(t){if(!t){this.emit("error",{error:{code:31e3,message:"Websocket closed without a provided reason",twilioError:new nn.SignalingErrors.ConnectionDisconnected}});return}this.emit("error",typeof t.code<"u"?{error:t}:t)};oe.prototype._handleTransportMessage=function(t){if(!(!t||!t.data||typeof t.data!="string")){var n=JSON.parse(t.data),e=n.type,i=n.payload,r=i===void 0?{}:i;this.gateway=r.gateway||this.gateway,this.region=r.region||this.region,e==="error"&&r.error&&(r.error.twilioError=new nn.SignalingErrors.ConnectionError),this.emit(e,r)}};oe.prototype._handleTransportOpen=function(){var t=this;this.status="connected",this.setToken(this.token),this.emit("transportOpen");var n=this._messageQueue.splice(0,this._messageQueue.length);n.forEach(function(e){return t._publish.apply(t,e)})};oe.toString=function(){return"[Twilio.PStream class]"};oe.prototype.toString=function(){return"[Twilio.PStream instance]"};oe.prototype.setToken=function(t){this._log.info("Setting token and publishing listen"),this.token=t;var n=0,e=this.options.maxPreferredDurationMs;this._log.info("maxPreferredDurationMs:".concat(e)),typeof e=="number"&&e>=0&&(n=Math.min(Math.ceil(e/1e3),va)),this._log.info("reconnectTimeout:".concat(n));var i={browserinfo:_a(),reconnectTimeout:n,token:t};this._publish("listen",i)};oe.prototype.sendMessage=function(t,n,e,i,r){e===void 0&&(e="application/json");var o={callsid:t,content:n,contenttype:e,messagetype:i,voiceeventsid:r};this._publish("message",o,!0)};oe.prototype.register=function(t){var n={media:t};this._publish("register",n,!0)};oe.prototype.invite=function(t,n,e){var i={callsid:n,sdp:t,twilio:e?{params:e}:{}};this._publish("invite",i,!0)};oe.prototype.reconnect=function(t,n,e){var i={callsid:n,reconnect:e,sdp:t,twilio:{}};this._publish("invite",i,!0)};oe.prototype.answer=function(t,n){this._publish("answer",{sdp:t,callsid:n},!0)};oe.prototype.dtmf=function(t,n){this._publish("dtmf",{callsid:t,dtmf:n},!0)};oe.prototype.hangup=function(t,n){var e=n?{callsid:t,message:n}:{callsid:t};this._publish("hangup",e,!0)};oe.prototype.reject=function(t){this._publish("reject",{callsid:t},!0)};oe.prototype.reinvite=function(t,n){this._publish("reinvite",{sdp:t,callsid:n},!1)};oe.prototype._destroy=function(){this.transport.removeListener("close",this._handleTransportClose),this.transport.removeListener("error",this._handleTransportError),this.transport.removeListener("message",this._handleTransportMessage),this.transport.removeListener("open",this._handleTransportOpen),this.transport.close(),this.emit("offline",this)};oe.prototype.destroy=function(){return this._log.info("PStream.destroy() called..."),this._destroy(),this};oe.prototype.updatePreferredURI=function(t){this._preferredUri=t,this.transport.updatePreferredURI(t)};oe.prototype.updateURIs=function(t){this._uris=t,this.transport.updateURIs(this._uris)};oe.prototype.publish=function(t,n){return this._publish(t,n,!0)};oe.prototype._publish=function(t,n,e){var i=JSON.stringify({payload:n,type:t,version:ha}),r=!!this.transport.send(i);r||(this.emit("error",{error:{code:31009,message:"No transport available to send or receive messages",twilioError:new nn.GeneralErrors.TransportError}}),e&&this._messageQueue.push([t,n,!0]))};function _a(){var t=typeof navigator<"u"?navigator:{},n={browser:{platform:t.platform||"unknown",userAgent:t.userAgent||"unknown"},p:"browser",plugin:"rtc",v:da.RELEASE_VERSION};return n}tn.default=oe;var Ai={};(function(t){var n;Object.defineProperty(t,"__esModule",{value:!0}),t.defaultEdge=t.regionToEdge=t.regionShortcodes=t.Region=t.Edge=void 0,t.createEventGatewayURI=y,t.createSignalingEndpointURL=P,t.getChunderURIs=I,t.getRegionShortcode=D;var e=ce,i;(function(v){v.Sydney="sydney",v.SaoPaulo="sao-paulo",v.Dublin="dublin",v.Frankfurt="frankfurt",v.Tokyo="tokyo",v.Singapore="singapore",v.Ashburn="ashburn",v.Umatilla="umatilla",v.Roaming="roaming",v.AshburnIx="ashburn-ix",v.SanJoseIx="san-jose-ix",v.LondonIx="london-ix",v.FrankfurtIx="frankfurt-ix",v.SingaporeIx="singapore-ix",v.SydneyIx="sydney-ix",v.TokyoIx="tokyo-ix"})(i||(t.Edge=i={}));var r;(function(v){v.Au1="au1",v.Au1Ix="au1-ix",v.Br1="br1",v.De1="de1",v.De1Ix="de1-ix",v.Gll="gll",v.Ie1="ie1",v.Ie1Ix="ie1-ix",v.Ie1Tnx="ie1-tnx",v.Jp1="jp1",v.Jp1Ix="jp1-ix",v.Sg1="sg1",v.Sg1Ix="sg1-ix",v.Sg1Tnx="sg1-tnx",v.Us1="us1",v.Us1Ix="us1-ix",v.Us1Tnx="us1-tnx",v.Us2="us2",v.Us2Ix="us2-ix",v.Us2Tnx="us2-tnx"})(r||(t.Region=r={})),t.regionShortcodes={ASIAPAC_SINGAPORE:r.Sg1,ASIAPAC_SYDNEY:r.Au1,ASIAPAC_TOKYO:r.Jp1,EU_FRANKFURT:r.De1,EU_IRELAND:r.Ie1,SOUTH_AMERICA_SAO_PAULO:r.Br1,US_EAST_VIRGINIA:r.Us1,US_WEST_OREGON:r.Us2},t.regionToEdge=(n={},n[r.Au1]=i.Sydney,n[r.Br1]=i.SaoPaulo,n[r.Ie1]=i.Dublin,n[r.De1]=i.Frankfurt,n[r.Jp1]=i.Tokyo,n[r.Sg1]=i.Singapore,n[r.Us1]=i.Ashburn,n[r.Us2]=i.Umatilla,n[r.Gll]=i.Roaming,n[r.Us1Ix]=i.AshburnIx,n[r.Us2Ix]=i.SanJoseIx,n[r.Ie1Ix]=i.LondonIx,n[r.De1Ix]=i.FrankfurtIx,n[r.Sg1Ix]=i.SingaporeIx,n[r.Au1Ix]=i.SydneyIx,n[r.Jp1Ix]=i.TokyoIx,n[r.Us1Tnx]=i.AshburnIx,n[r.Us2Tnx]=i.AshburnIx,n[r.Ie1Tnx]=i.LondonIx,n[r.Sg1Tnx]=i.SingaporeIx,n),t.defaultEdge=i.Roaming;var o="eventgw.twilio.com";function c(v){return"voice-js.".concat(v,".twilio.com")}function y(v){return v?"eventgw.".concat(v,".twilio.com"):o}function P(v){return"wss://".concat(v,"/signal")}function I(v){if(v&&typeof v!="string"&&!Array.isArray(v))throw new e.InvalidArgumentError("If `edge` is provided, it must be of type `string` or an array of strings.");var p;if(v){var m=Array.isArray(v)?v:[v];p=m.map(function(s){return c(s)})}else p=[c(t.defaultEdge)];return p}function D(v){return t.regionShortcodes[v]||null}})(Ai);var De={},rn={},wt={},Ee={};Object.defineProperty(Ee,"__esModule",{value:!0});Ee.getPreferredCodecInfo=ba;Ee.setCodecPreferences=Ca;Ee.setIceAggressiveNomination=wa;Ee.setMaxAverageBitrate=Sa;var ct=re,Ln={0:"PCMU",8:"PCMA"},ma=111,ga=51e4,ya=6e3;function ba(t){var n=/a=rtpmap:(\d+) (\S+)/m.exec(t)||[null,"",""],e=n[1],i=n[2],r=new RegExp("a=fmtp:".concat(e," (\\S+)"),"m"),o=r.exec(t)||[null,""],c=o[1];return{codecName:i,codecParams:c}}function wa(t){return ct.isChrome(window,window.navigator)?t.split(`
`).filter(function(n){return n.indexOf("a=ice-lite")===-1}).join(`
`):t}function Sa(t,n){if(typeof n!="number"||n<ya||n>ga)return t;var e=/a=rtpmap:(\d+) opus/m.exec(t),i=e&&e.length?e[1]:ma,r=new RegExp("a=fmtp:".concat(i)),o=t.split(`
`).map(function(c){return r.test(c)?c+";maxaveragebitrate=".concat(n):c});return o.join(`
`)}function Ca(t,n){var e=ka(t),i=t.split(`\r
m=`)[0];return[i].concat(e.map(function(r){if(!/^m=(audio|video)/.test(r))return r;var o=r.match(/^m=(audio|video)/)[1],c=Ta(r),y=Ea(c,n),P=Ia(y,r),I=c.get("pcma")||[],D=c.get("pcmu")||[],v=o==="audio"?new Set(I.concat(D)):new Set;return v.has(y[0])?P.replace(/\r\nb=(AS|TIAS):([0-9]+)/g,""):P})).join(`\r
`)}function ka(t,n,e){return t.replace(/\r\n\r\n$/,`\r
`).split(`\r
m=`).slice(1).map(function(i){return"m=".concat(i)}).filter(function(i){var r=new RegExp("m=".concat(n||".*"),"gm"),o=new RegExp("a=".concat(e||".*"),"gm");return r.test(i)&&o.test(i)})}function Ta(t){return Array.from(Pa(t)).reduce(function(n,e){var i=e[0],r=e[1],o=n.get(r)||[];return n.set(r,o.concat(i))},new Map)}function Ea(t,n){n=n.map(function(o){return o.toLowerCase()});var e=ct.flatMap(n,function(o){return t.get(o)||[]}),i=ct.difference(Array.from(t.keys()),n),r=ct.flatMap(i,function(o){return t.get(o)});return e.concat(r)}function Ia(t,n){var e=n.split(`\r
`),i=e[0],r=e.slice(1);return i=i.replace(/([0-9]+\s?)+$/,t.join(" ")),[i].concat(r).join(`\r
`)}function Pa(t){return xa(t).reduce(function(n,e){var i=new RegExp("a=rtpmap:".concat(e," ([^/]+)")),r=t.match(i),o=r?r[1].toLowerCase():Ln[e]?Ln[e].toLowerCase():"";return n.set(e,o)},new Map)}function xa(t){var n=t.split(`\r
`)[0],e=n.match(/([0-9]+)/g);return e?e.slice(1).map(function(i){return parseInt(i,10)}):[]}Object.defineProperty(wt,"__esModule",{value:!0});var Aa=le,Ri=re,St=Ee;function be(t){if(this.log=new Aa.default("RTCPC"),typeof window>"u"){this.log.info("No RTCPeerConnection implementation available. The window object was not found.");return}t&&t.RTCPeerConnection?this.RTCPeerConnection=t.RTCPeerConnection:typeof window.RTCPeerConnection=="function"?this.RTCPeerConnection=window.RTCPeerConnection:typeof window.webkitRTCPeerConnection=="function"?this.RTCPeerConnection=webkitRTCPeerConnection:typeof window.mozRTCPeerConnection=="function"?(this.RTCPeerConnection=mozRTCPeerConnection,window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate):this.log.info("No RTCPeerConnection implementation available")}be.prototype.create=function(t){this.pc=new this.RTCPeerConnection(t)};be.prototype.createModernConstraints=function(t){if(typeof t>"u")return null;var n=Object.assign({},t);return typeof webkitRTCPeerConnection<"u"&&!Ri.isLegacyEdge()?(n.mandatory={},typeof t.audio<"u"&&(n.mandatory.OfferToReceiveAudio=t.audio),typeof t.video<"u"&&(n.mandatory.OfferToReceiveVideo=t.video)):(typeof t.audio<"u"&&(n.offerToReceiveAudio=t.audio),typeof t.video<"u"&&(n.offerToReceiveVideo=t.video)),delete n.audio,delete n.video,n};be.prototype.createOffer=function(t,n,e,i){var r=this;return n=this.createModernConstraints(n),Mi(this.pc.createOffer,this.pc)(n).then(function(o){if(!r.pc)return Promise.resolve();var c=(0,St.setMaxAverageBitrate)(o.sdp,t);return Ct(r.pc.setLocalDescription,r.pc)(new RTCSessionDescription({sdp:c,type:"offer"}))}).then(e,i)};be.prototype.createAnswer=function(t,n,e,i){var r=this;return n=this.createModernConstraints(n),Mi(this.pc.createAnswer,this.pc)(n).then(function(o){if(!r.pc)return Promise.resolve();var c=(0,St.setMaxAverageBitrate)(o.sdp,t);return Ct(r.pc.setLocalDescription,r.pc)(new RTCSessionDescription({sdp:c,type:"answer"}))}).then(e,i)};be.prototype.processSDP=function(t,n,e,i,r,o){var c=this;e=(0,St.setCodecPreferences)(e,n);var y=new RTCSessionDescription({sdp:e,type:"offer"});return Ct(this.pc.setRemoteDescription,this.pc)(y).then(function(){c.createAnswer(t,i,r,o)})};be.prototype.getSDP=function(){return this.pc.localDescription.sdp};be.prototype.processAnswer=function(t,n,e,i){return this.pc?(n=(0,St.setCodecPreferences)(n,t),Ct(this.pc.setRemoteDescription,this.pc)(new RTCSessionDescription({sdp:n,type:"answer"})).then(e,i)):Promise.resolve()};be.test=function(){if(typeof navigator=="object"){var t=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia;if(Ri.isLegacyEdge(navigator))return!1;if(t&&typeof window.RTCPeerConnection=="function")return!0;if(t&&typeof window.webkitRTCPeerConnection=="function")return!0;if(t&&typeof window.mozRTCPeerConnection=="function"){try{var n=new window.mozRTCPeerConnection;if(typeof n.getLocalStreams!="function")return!1}catch{return!1}return!0}else if(typeof RTCIceGatherer<"u")return!0}return!1};function Di(t,n,e,i){return function(){var r=Array.prototype.slice.call(arguments);return new Promise(function(o){var c=t.apply(n,r);if(!i){o(c);return}if(typeof c=="object"&&typeof c.then=="function")o(c);else throw new Error}).catch(function(){return new Promise(function(o,c){t.apply(n,e?[o,c].concat(r):r.concat([o,c]))})})}}function Mi(t,n){return Di(t,n,!0,!0)}function Ct(t,n){return Di(t,n,!1,!1)}wt.default=be;Object.defineProperty(rn,"__esModule",{value:!0});var ge=ce,Ra=le,Oi=re,_t=wt,Da=Ee,Ma=15e3,Oa="none",La="timeout",ja="new",jn=50;function z(t,n,e){if(!t||!n)throw new ge.InvalidArgumentError("Audiohelper, and pstream are required arguments");if(!(this instanceof z))return new z(t,n,e);this._log=new Ra.default("PeerConnection");function i(){this._log.warn("Unexpected noop call in peerconnection")}this.onaudio=i,this.onopen=i,this.onerror=i,this.onclose=i,this.ondisconnected=i,this.onfailed=i,this.onconnected=i,this.onreconnected=i,this.onsignalingstatechange=i,this.ondtlstransportstatechange=i,this.onicegatheringfailure=i,this.onicegatheringstatechange=i,this.oniceconnectionstatechange=i,this.onpcconnectionstatechange=i,this.onicecandidate=i,this.onselectedcandidatepairchange=i,this.onvolume=i,this.version=null,this.pstream=n,this.stream=null,this.sinkIds=new Set(["default"]),this.outputs=new Map,this.status="connecting",this.callSid=null,this.isMuted=!1;var r=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);return this._isSinkSupported=!!r&&typeof HTMLAudioElement<"u"&&HTMLAudioElement.prototype.setSinkId,this._audioContext=r&&t._audioContext,this._audioHelper=t,this._hasIceCandidates=!1,this._hasIceGatheringFailures=!1,this._iceGatheringTimeoutId=null,this._masterAudio=null,this._masterAudioDeviceId=null,this._mediaStreamSource=null,this._dtmfSender=null,this._dtmfSenderUnsupported=!1,this._callEvents=[],this._nextTimeToPublish=Date.now(),this._onAnswerOrRinging=i,this._onHangup=i,this._remoteStream=null,this._shouldManageStream=!0,this._iceState=ja,this._isUnifiedPlan=e.isUnifiedPlan,this.options=e=e||{},this.navigator=e.navigator||(typeof navigator<"u"?navigator:null),this.util=e.util||Oi,this.codecPreferences=e.codecPreferences,this}z.prototype.uri=function(){return this._uri};z.prototype.openDefaultDeviceWithConstraints=function(t){return this._audioHelper._openDefaultDeviceWithConstraints(t).then(this._setInputTracksFromStream.bind(this,!1))};z.prototype.setInputTracksFromStream=function(t){var n=this;return this._setInputTracksFromStream(!0,t).then(function(){n._shouldManageStream=!1})};z.prototype._createAnalyser=function(t,n){n=Object.assign({fftSize:32,smoothingTimeConstant:.3},n);var e=t.createAnalyser();for(var i in n)e[i]=n[i];return e};z.prototype._setVolumeHandler=function(t){this.onvolume=t};z.prototype._startPollingVolume=function(){if(!(!this._audioContext||!this.stream||!this._remoteStream)){var t=this._audioContext,n=this._inputAnalyser=this._createAnalyser(t),e=n.frequencyBinCount,i=new Uint8Array(e);this._inputAnalyser2=this._createAnalyser(t,{maxDecibels:0,minDecibels:-127,smoothingTimeConstant:0});var r=this._outputAnalyser=this._createAnalyser(t),o=r.frequencyBinCount,c=new Uint8Array(o);this._outputAnalyser2=this._createAnalyser(t,{maxDecibels:0,minDecibels:-127,smoothingTimeConstant:0}),this._updateInputStreamSource(this.stream),this._updateOutputStreamSource(this._remoteStream);var y=this;setTimeout(function P(){if(y._audioContext){if(y.status==="closed"){y._inputAnalyser.disconnect(),y._outputAnalyser.disconnect(),y._inputAnalyser2.disconnect(),y._outputAnalyser2.disconnect();return}}else return;y._inputAnalyser.getByteFrequencyData(i);var I=y.util.average(i);y._inputAnalyser2.getByteFrequencyData(i);var D=y.util.average(i);y._outputAnalyser.getByteFrequencyData(c);var v=y.util.average(c);y._outputAnalyser2.getByteFrequencyData(c);var p=y.util.average(c);y.onvolume(I/255,v/255,D,p),setTimeout(P,jn)},jn)}};z.prototype._stopStream=function(){this._shouldManageStream&&this._audioHelper._stopDefaultInputDeviceStream()};z.prototype._updateInputStreamSource=function(t){this._inputStreamSource&&this._inputStreamSource.disconnect();try{this._inputStreamSource=this._audioContext.createMediaStreamSource(t),this._inputStreamSource.connect(this._inputAnalyser),this._inputStreamSource.connect(this._inputAnalyser2)}catch(n){this._log.warn("Unable to update input MediaStreamSource",n),this._inputStreamSource=null}};z.prototype._updateOutputStreamSource=function(t){this._outputStreamSource&&this._outputStreamSource.disconnect();try{this._outputStreamSource=this._audioContext.createMediaStreamSource(t),this._outputStreamSource.connect(this._outputAnalyser),this._outputStreamSource.connect(this._outputAnalyser2)}catch(n){this._log.warn("Unable to update output MediaStreamSource",n),this._outputStreamSource=null}};z.prototype._setInputTracksFromStream=function(t,n){return this._isUnifiedPlan?this._setInputTracksForUnifiedPlan(t,n):this._setInputTracksForPlanB(t,n)};z.prototype._setInputTracksForPlanB=function(t,n){var e=this;if(!n)return Promise.reject(new ge.InvalidArgumentError("Can not set input stream to null while in a call"));if(!n.getAudioTracks().length)return Promise.reject(new ge.InvalidArgumentError("Supplied input stream has no audio tracks"));var i=this.stream;return i?(this._stopStream(),Ua(this.version.pc,i),i.getAudioTracks().forEach(i.removeTrack,i),n.getAudioTracks().forEach(i.addTrack,i),Li(this.version.pc,n),this._updateInputStreamSource(this.stream)):this.stream=t?Ft(n):n,this.mute(this.isMuted),this.version?new Promise(function(r,o){e.version.createOffer(e.options.maxAverageBitrate,{audio:!0},function(){e.version.processAnswer(e.codecPreferences,e._answerSdp,function(){r(e.stream)},o)},o)}):Promise.resolve(this.stream)};z.prototype._setInputTracksForUnifiedPlan=function(t,n){var e=this;if(!n)return Promise.reject(new ge.InvalidArgumentError("Can not set input stream to null while in a call"));if(!n.getAudioTracks().length)return Promise.reject(new ge.InvalidArgumentError("Supplied input stream has no audio tracks"));var i=this.stream,r=function(){return e.mute(e.isMuted),Promise.resolve(e.stream)};if(!i)this.stream=t?Ft(n,this.options.MediaStream):n;else return this._shouldManageStream&&this._stopStream(),this._sender||(this._sender=this.version.pc.getSenders()[0]),this._sender.replaceTrack(n.getAudioTracks()[0]).then(function(){return e._updateInputStreamSource(n),e.stream=t?Ft(n,e.options.MediaStream):n,r()});return r()};z.prototype._onInputDevicesChanged=function(){if(this.stream){var t=this.stream.getAudioTracks().every(function(n){return n.readyState==="ended"});t&&this._shouldManageStream&&this.openDefaultDeviceWithConstraints({audio:!0})}};z.prototype._onIceGatheringFailure=function(t){this._hasIceGatheringFailures=!0,this.onicegatheringfailure(t)};z.prototype._onMediaConnectionStateChange=function(t){var n=this._iceState;if(!(n===t||t!=="connected"&&t!=="disconnected"&&t!=="failed")){this._iceState=t;var e;switch(t){case"connected":n==="disconnected"||n==="failed"?(e="ICE liveliness check succeeded. Connection with Twilio restored",this._log.info(e),this.onreconnected(e)):(e="Media connection established.",this._log.info(e),this.onconnected(e)),this._stopIceGatheringTimeout(),this._hasIceGatheringFailures=!1;break;case"disconnected":e="ICE liveliness check failed. May be having trouble connecting to Twilio",this._log.warn(e),this.ondisconnected(e);break;case"failed":e="Connection with Twilio was interrupted.",this._log.warn(e),this.onfailed(e);break}}};z.prototype._setSinkIds=function(t){return this._isSinkSupported?(this.sinkIds=new Set(t.forEach?t:[t]),this.version?this._updateAudioOutputs():Promise.resolve()):Promise.reject(new ge.NotSupportedError("Audio output selection is not supported by this browser"))};z.prototype._startIceGatheringTimeout=function(){var n=this;this._stopIceGatheringTimeout(),this._iceGatheringTimeoutId=setTimeout(function(){n._onIceGatheringFailure(La)},Ma)};z.prototype._stopIceGatheringTimeout=function(){clearInterval(this._iceGatheringTimeoutId)};z.prototype._updateAudioOutputs=function(){var n=Array.from(this.sinkIds).filter(function(o){return!this.outputs.has(o)},this),e=Array.from(this.outputs.keys()).filter(function(o){return!this.sinkIds.has(o)},this),i=this,r=n.map(this._createAudioOutput,this);return Promise.all(r).then(function(){return Promise.all(e.map(i._removeAudioOutput,i))})};z.prototype._createAudio=function(n){var e=new Audio(n);return this.onaudio(e),e};z.prototype._createAudioOutput=function(n){var e=null;this._mediaStreamSource&&(e=this._audioContext.createMediaStreamDestination(),this._mediaStreamSource.connect(e));var i=this._createAudio();on(i,e&&e.stream?e.stream:this.pcStream);var r=this;return i.setSinkId(n).then(function(){return i.play()}).then(function(){r.outputs.set(n,{audio:i,dest:e})})};z.prototype._removeAudioOutputs=function(){return this._masterAudio&&typeof this._masterAudioDeviceId<"u"&&(this._disableOutput(this,this._masterAudioDeviceId),this.outputs.delete(this._masterAudioDeviceId),this._masterAudioDeviceId=null,this._masterAudio.paused||this._masterAudio.pause(),typeof this._masterAudio.srcObject<"u"?this._masterAudio.srcObject=null:this._masterAudio.src="",this._masterAudio=null),Array.from(this.outputs.keys()).map(this._removeAudioOutput,this)};z.prototype._disableOutput=function(n,e){var i=n.outputs.get(e);i&&(i.audio&&(i.audio.pause(),i.audio.src=""),i.dest&&i.dest.disconnect())};z.prototype._reassignMasterOutput=function(n,e){var i=n.outputs.get(e);n.outputs.delete(e);var r=this,o=Array.from(n.outputs.keys())[0],c=typeof o=="string"?o:"default";return i.audio.setSinkId(c).then(function(){r._disableOutput(n,c),n.outputs.set(c,i),n._masterAudioDeviceId=c}).catch(function(){n.outputs.set(e,i),r._log.info("Could not reassign master output. Attempted to roll back.")})};z.prototype._removeAudioOutput=function(n){return this._masterAudioDeviceId===n?this._reassignMasterOutput(this,n):(this._disableOutput(this,n),this.outputs.delete(n),Promise.resolve())};z.prototype._onAddTrack=function(n,e){var i=n._masterAudio=this._createAudio();on(i,e),i.play();var r=Array.from(n.outputs.keys())[0],o=typeof r=="string"?r:"default";n._masterAudioDeviceId=o,n.outputs.set(o,{audio:i});try{n._mediaStreamSource=n._audioContext.createMediaStreamSource(e)}catch(c){this._log.warn("Unable to create a MediaStreamSource from onAddTrack",c),this._mediaStreamSource=null}n.pcStream=e,n._updateAudioOutputs()};z.prototype._fallbackOnAddTrack=function(n,e){var i=document&&document.createElement("audio");i.autoplay=!0,on(i,e)||n._log.info("Error attaching stream to element."),n.outputs.set("default",{audio:i})};z.prototype._setEncodingParameters=function(t){if(!(!t||!this._sender||typeof this._sender.getParameters!="function"||typeof this._sender.setParameters!="function")){var n=this._sender.getParameters();!n.priority&&!(n.encodings&&n.encodings.length)||(n.priority="high",n.encodings&&n.encodings.length&&n.encodings.forEach(function(e){e.priority="high",e.networkPriority="high"}),this._sender.setParameters(n))}};z.prototype._setupPeerConnection=function(t){var n=this,e=this,i=new(this.options.rtcpcFactory||_t.default)({RTCPeerConnection:this.options.RTCPeerConnection});i.create(t),Li(i.pc,this.stream);var r=RTCRtpReceiver.getCapabilities("audio").codecs;this._log.debug("sorting codecs",r,this.codecPreferences);var o=Oi.sortByMimeTypes(r,this.codecPreferences),c=i.pc.getTransceivers()[0];this._log.debug("setting sorted codecs",o),c.setCodecPreferences(o);var y="ontrack"in i.pc?"ontrack":"onaddstream";return i.pc[y]=function(P){var I=e._remoteStream=P.stream||P.streams[0];typeof i.pc.getSenders=="function"&&(n._sender=i.pc.getSenders()[0]),e._isSinkSupported?e._onAddTrack(e,I):e._fallbackOnAddTrack(e,I),e._startPollingVolume()},i};z.prototype._maybeSetIceAggressiveNomination=function(t){return this.options.forceAggressiveIceNomination?(0,Da.setIceAggressiveNomination)(t):t};z.prototype._setupChannel=function(){var t=this,n=this.version.pc;this.version.pc.onopen=function(){t.status="open",t.onopen()},this.version.pc.onstatechange=function(){t.version.pc&&t.version.pc.readyState==="stable"&&(t.status="open",t.onopen())},this.version.pc.onsignalingstatechange=function(){var e=n.signalingState;t._log.info('signalingState is "'.concat(e,'"')),t.version.pc&&t.version.pc.signalingState==="stable"&&(t.status="open",t.onopen()),t.onsignalingstatechange(n.signalingState)},n.onconnectionstatechange=function(e){var i=n.connectionState;if(!i&&e&&e.target){var r=e.target;i=r.connectionState||r.connectionState_,t._log.info("pc.connectionState not detected. Using target PC. State=".concat(i))}i?t._log.info('pc.connectionState is "'.concat(i,'"')):t._log.warn('onconnectionstatechange detected but state is "'.concat(i,'"')),t.onpcconnectionstatechange(i),t._onMediaConnectionStateChange(i)},n.onicecandidate=function(e){var i=e.candidate;i&&(t._hasIceCandidates=!0,t.onicecandidate(i),t._setupRTCIceTransportListener()),t._log.info("ICE Candidate: ".concat(JSON.stringify(i)))},n.onicegatheringstatechange=function(){var e=n.iceGatheringState;e==="gathering"?t._startIceGatheringTimeout():e==="complete"&&(t._stopIceGatheringTimeout(),t._hasIceCandidates||t._onIceGatheringFailure(Oa),t._hasIceCandidates&&t._hasIceGatheringFailures&&t._startIceGatheringTimeout()),t._log.info('pc.iceGatheringState is "'.concat(n.iceGatheringState,'"')),t.onicegatheringstatechange(e)},n.oniceconnectionstatechange=function(){t._log.info('pc.iceConnectionState is "'.concat(n.iceConnectionState,'"')),t.oniceconnectionstatechange(n.iceConnectionState),t._onMediaConnectionStateChange(n.iceConnectionState)}};z.prototype._initializeMediaStream=function(t){return this.status==="open"?!1:this.pstream.status==="disconnected"?(this.onerror({info:{code:31e3,message:"Cannot establish connection. Client is disconnected",twilioError:new ge.SignalingErrors.ConnectionDisconnected}}),this.close(),!1):(this.version=this._setupPeerConnection(t),this._setupChannel(),!0)};z.prototype._removeReconnectionListeners=function(){this.pstream&&(this.pstream.removeListener("answer",this._onAnswerOrRinging),this.pstream.removeListener("hangup",this._onHangup))};z.prototype._setupRTCDtlsTransportListener=function(){var t=this,n=this.getRTCDtlsTransport();if(!(!n||n.onstatechange)){var e=function(){t._log.info('dtlsTransportState is "'.concat(n.state,'"')),t.ondtlstransportstatechange(n.state)};e(),n.onstatechange=e}};z.prototype._setupRTCIceTransportListener=function(){var t=this,n=this._getRTCIceTransport();!n||n.onselectedcandidatepairchange||(n.onselectedcandidatepairchange=function(){return t.onselectedcandidatepairchange(n.getSelectedCandidatePair())})};z.prototype.iceRestart=function(){var t=this;this._log.info("Attempting to restart ICE..."),this._hasIceCandidates=!1,this.version.createOffer(this.options.maxAverageBitrate,{iceRestart:!0}).then(function(){t._removeReconnectionListeners(),t._onAnswerOrRinging=function(n){if(t._removeReconnectionListeners(),!n.sdp||t.version.pc.signalingState!=="have-local-offer"){var e="Invalid state or param during ICE Restart:"+"hasSdp:".concat(!!n.sdp,", signalingState:").concat(t.version.pc.signalingState);t._log.warn(e);return}var i=t._maybeSetIceAggressiveNomination(n.sdp);t._answerSdp=i,t.status!=="closed"&&t.version.processAnswer(t.codecPreferences,i,null,function(r){var o=r&&r.message?r.message:r;t._log.error("Failed to process answer during ICE Restart. Error: ".concat(o))})},t._onHangup=function(){t._log.info("Received hangup during ICE Restart"),t._removeReconnectionListeners()},t.pstream.on("answer",t._onAnswerOrRinging),t.pstream.on("hangup",t._onHangup),t.pstream.reinvite(t.version.getSDP(),t.callSid)}).catch(function(n){var e=n&&n.message?n.message:n;t._log.error("Failed to createOffer during ICE Restart. Error: ".concat(e)),t.onfailed(e)})};z.prototype.makeOutgoingCall=function(t,n,e,i,r){var o=this;if(!this._initializeMediaStream(i))return;var c=this;this.callSid=e;function y(){c.options&&c._setEncodingParameters(c.options.dscp),r(c.version.pc)}function P(v){var p=v.message||v;c.onerror({info:{code:31e3,message:"Error processing answer: ".concat(p),twilioError:new ge.MediaErrors.ClientRemoteDescFailed}})}this._onAnswerOrRinging=function(v){if(v.sdp){var p=o._maybeSetIceAggressiveNomination(v.sdp);c._answerSdp=p,c.status!=="closed"&&c.version.processAnswer(o.codecPreferences,p,y,P),c.pstream.removeListener("answer",c._onAnswerOrRinging),c.pstream.removeListener("ringing",c._onAnswerOrRinging)}},this.pstream.on("answer",this._onAnswerOrRinging),this.pstream.on("ringing",this._onAnswerOrRinging);function I(){c.status!=="closed"&&(n?c.pstream.reconnect(c.version.getSDP(),c.callSid,n):c.pstream.invite(c.version.getSDP(),c.callSid,t),c._setupRTCDtlsTransportListener())}function D(v){var p=v.message||v;c.onerror({info:{code:31e3,message:"Error creating the offer: ".concat(p),twilioError:new ge.MediaErrors.ClientLocalDescFailed}})}this.version.createOffer(this.options.maxAverageBitrate,{audio:!0},I,D)};z.prototype.answerIncomingCall=function(t,n,e,i){if(!this._initializeMediaStream(e))return;n=this._maybeSetIceAggressiveNomination(n),this._answerSdp=n.replace(/^a=setup:actpass$/gm,"a=setup:passive"),this.callSid=t;var r=this;function o(){r.status!=="closed"&&(r.pstream.answer(r.version.getSDP(),t),r.options&&r._setEncodingParameters(r.options.dscp),i(r.version.pc),r._setupRTCDtlsTransportListener())}function c(y){var P=y.message||y;r.onerror({info:{code:31e3,message:"Error creating the answer: ".concat(P),twilioError:new ge.MediaErrors.ClientRemoteDescFailed}})}this.version.processSDP(this.options.maxAverageBitrate,this.codecPreferences,n,{audio:!0},o,c)};z.prototype.close=function(){this.version&&this.version.pc&&(this.version.pc.signalingState!=="closed"&&this.version.pc.close(),this.version.pc=null),this.stream&&(this.mute(!1),this._stopStream()),this.stream=null,this._removeReconnectionListeners(),this._stopIceGatheringTimeout(),Promise.all(this._removeAudioOutputs()).catch(function(){}),this._mediaStreamSource&&this._mediaStreamSource.disconnect(),this._inputAnalyser&&this._inputAnalyser.disconnect(),this._outputAnalyser&&this._outputAnalyser.disconnect(),this._inputAnalyser2&&this._inputAnalyser2.disconnect(),this._outputAnalyser2&&this._outputAnalyser2.disconnect(),this.status="closed",this.onclose()};z.prototype.reject=function(t){this.callSid=t};z.prototype.ignore=function(t){this.callSid=t};z.prototype.mute=function(t){if(this.isMuted=t,!!this.stream)if(this._sender&&this._sender.track)this._sender.track.enabled=!t;else{var n=typeof this.stream.getAudioTracks=="function"?this.stream.getAudioTracks():this.stream.audioTracks;n.forEach(function(e){e.enabled=!t})}};z.prototype.getOrCreateDTMFSender=function(){if(this._dtmfSender||this._dtmfSenderUnsupported)return this._dtmfSender||null;var n=this,e=this.version.pc;if(!e)return this._log.warn("No RTCPeerConnection available to call createDTMFSender on"),null;if(typeof e.getSenders=="function"&&(typeof RTCDTMFSender=="function"||typeof RTCDtmfSender=="function")){var i=e.getSenders().find(function(o){return o.dtmf});if(i)return this._log.info("Using RTCRtpSender#dtmf"),this._dtmfSender=i.dtmf,this._dtmfSender}if(typeof e.createDTMFSender=="function"&&typeof e.getLocalStreams=="function"){var r=e.getLocalStreams().map(function(o){var c=n._getAudioTracks(o);return c&&c[0]})[0];return r?(this._log.info("Creating RTCDTMFSender"),this._dtmfSender=e.createDTMFSender(r),this._dtmfSender):(this._log.warn("No local audio MediaStreamTrack available on the RTCPeerConnection to pass to createDTMFSender"),null)}return this._log.info("RTCPeerConnection does not support RTCDTMFSender"),this._dtmfSenderUnsupported=!0,null};z.prototype.getRTCDtlsTransport=function(){var n=this.version&&this.version.pc&&typeof this.version.pc.getSenders=="function"&&this.version.pc.getSenders()[0];return n&&n.transport||null};z.prototype._canStopMediaStreamTrack=function(){return typeof MediaStreamTrack.prototype.stop=="function"};z.prototype._getAudioTracks=function(t){return typeof t.getAudioTracks=="function"?t.getAudioTracks():t.audioTracks};z.prototype._getRTCIceTransport=function(){var n=this.getRTCDtlsTransport();return n&&n.iceTransport||null};z.protocol=function(){return _t.default.test()?new _t.default:null}();function Li(t,n){typeof t.addTrack=="function"?n.getAudioTracks().forEach(function(e){t.addTrack(e,n)}):t.addStream(n)}function Ft(t,n){var e;return n?e=new n:typeof MediaStream<"u"?e=new MediaStream:e=new webkitMediaStream,t.getAudioTracks().forEach(e.addTrack,e),e}function Ua(t,n){typeof t.removeTrack=="function"?t.getSenders().forEach(function(e){t.removeTrack(e)}):t.removeStream(n)}function on(t,n){if(typeof t.srcObject<"u")t.srcObject=n;else if(typeof t.mozSrcObject<"u")t.mozSrcObject=n;else if(typeof t.src<"u"){var e=t.options.window||window;t.src=(e.URL||e.webkitURL).createObjectURL(n)}else return!1;return!0}z.enabled=_t.default.test();rn.default=z;Object.defineProperty(De,"__esModule",{value:!0});De.PeerConnection=void 0;De.enabled=Va;De.getMediaEngine=$a;var Na=rn;De.PeerConnection=Na.default;var Fa=wt;function Va(){return Fa.default.test()}function $a(){return typeof RTCIceGatherer<"u"?"ORTC":"WebRTC"}var an={};Object.defineProperty(an,"__esModule",{value:!0});var Dt=ce,Ba=re;function Ha(t,n){return n=n||{},n.util=n.util||Ba,n.navigator=n.navigator||(typeof navigator<"u"?navigator:null),new Promise(function(e,i){if(!n.navigator)throw new Dt.NotSupportedError("getUserMedia is not supported");switch("function"){case typeof(n.navigator.mediaDevices&&n.navigator.mediaDevices.getUserMedia):return e(n.navigator.mediaDevices.getUserMedia(t));case typeof n.navigator.webkitGetUserMedia:return n.navigator.webkitGetUserMedia(t,e,i);case typeof n.navigator.mozGetUserMedia:return n.navigator.mozGetUserMedia(t,e,i);case typeof n.navigator.getUserMedia:return n.navigator.getUserMedia(t,e,i);default:throw new Dt.NotSupportedError("getUserMedia is not supported")}}).catch(function(e){throw n.util.isFirefox()&&e.name==="NotReadableError"?new Dt.NotSupportedError(`Firefox does not currently support opening multiple audio input trackssimultaneously, even across different tabs.
Related Bugzilla thread: https://bugzilla.mozilla.org/show_bug.cgi?id=1299324`):e})}an.default=Ha;var kt={};Object.defineProperty(kt,"__esModule",{value:!0});kt.generateVoiceEventSid=qa;var ot=ce;function Wa(){if(typeof window!="object")throw new ot.NotSupportedError("This platform is not supported.");var t=window.crypto;if(typeof t!="object")throw new ot.NotSupportedError("The `crypto` module is not available on this platform.");if(typeof t.getRandomValues!="function")throw new ot.NotSupportedError("The function `crypto.getRandomValues` is not available on this platform.");if(typeof window.Uint8Array!="function")throw new ot.NotSupportedError("The `Uint8Array` module is not available on this platform.");return t.getRandomValues(new window.Uint8Array(16)).reduce(function(n,e){return"".concat(n).concat(e.toString(16).padStart(2,"0"))},"")}function qa(){return"KX".concat(Wa())}var sn={},Tt={},cn={};Object.defineProperty(cn,"__esModule",{value:!0});var Ga=function(){function t(){var n=this;this._promise=new Promise(function(e,i){n._resolve=e,n._reject=i})}return Object.defineProperty(t.prototype,"promise",{get:function(){return this._promise},enumerable:!1,configurable:!0}),t.prototype.reject=function(n){this._reject(n)},t.prototype.resolve=function(n){this._resolve(n)},t}();cn.default=Ga;var za=H&&H.__awaiter||function(t,n,e,i){function r(o){return o instanceof e?o:new e(function(c){c(o)})}return new(e||(e=Promise))(function(o,c){function y(D){try{I(i.next(D))}catch(v){c(v)}}function P(D){try{I(i.throw(D))}catch(v){c(v)}}function I(D){D.done?o(D.value):r(D.value).then(y,P)}I((i=i.apply(t,n||[])).next())})},Ja=H&&H.__generator||function(t,n){var e={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,r,o,c=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return c.next=y(0),c.throw=y(1),c.return=y(2),typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function y(I){return function(D){return P([I,D])}}function P(I){if(i)throw new TypeError("Generator is already executing.");for(;c&&(c=0,I[0]&&(e=0)),e;)try{if(i=1,r&&(o=I[0]&2?r.return:I[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,I[1])).done)return o;switch(r=0,o&&(I=[I[0]&2,o.value]),I[0]){case 0:case 1:o=I;break;case 4:return e.label++,{value:I[1],done:!1};case 5:e.label++,r=I[1],I=[0];continue;case 7:I=e.ops.pop(),e.trys.pop();continue;default:if(o=e.trys,!(o=o.length>0&&o[o.length-1])&&(I[0]===6||I[0]===2)){e=0;continue}if(I[0]===3&&(!o||I[1]>o[0]&&I[1]<o[3])){e.label=I[1];break}if(I[0]===6&&e.label<o[1]){e.label=o[1],o=I;break}if(o&&e.label<o[2]){e.label=o[2],e.ops.push(I);break}o[2]&&e.ops.pop(),e.trys.pop();continue}I=n.call(t,e)}catch(D){I=[6,D],r=0}finally{i=o=0}if(I[0]&5)throw I[1];return{value:I[0]?I[1]:void 0,done:!0}}};Object.defineProperty(Tt,"__esModule",{value:!0});Tt.AsyncQueue=void 0;var Qa=cn,Ka=function(){function t(){this._operations=[]}return t.prototype.enqueue=function(n){var e=!!this._operations.length,i=new Qa.default;return this._operations.push({deferred:i,callback:n}),e||this._processQueue(),i.promise},t.prototype._processQueue=function(){return za(this,void 0,void 0,function(){var n,e,i,r,o,c,y;return Ja(this,function(P){switch(P.label){case 0:if(!this._operations.length)return[3,5];n=this._operations[0],e=n.deferred,i=n.callback,r=void 0,o=void 0,c=void 0,P.label=1;case 1:return P.trys.push([1,3,,4]),[4,i()];case 2:return r=P.sent(),c=!0,[3,4];case 3:return y=P.sent(),o=y,[3,4];case 4:return this._operations.shift(),c?e.resolve(r):e.reject(o),[3,0];case 5:return[2]}})})},t}();Tt.AsyncQueue=Ka;var ln={},un={};Object.defineProperty(un,"__esModule",{value:!0});var Xa=function(){function t(){var n=this;this.promise=new Promise(function(e,i){n._resolve=e,n._reject=i})}return Object.defineProperty(t.prototype,"reject",{get:function(){return this._reject},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"resolve",{get:function(){return this._resolve},enumerable:!1,configurable:!0}),t}();un.default=Xa;var dn={},Za=H&&H.__spreadArray||function(t,n,e){if(e||arguments.length===2)for(var i=0,r=n.length,o;i<r;i++)(o||!(i in n))&&(o||(o=Array.prototype.slice.call(n,0,i)),o[i]=n[i]);return t.concat(o||Array.prototype.slice.call(n))};Object.defineProperty(dn,"__esModule",{value:!0});var Ya=me,es=function(){function t(){this._eventEmitter=new Ya.EventEmitter}return t.prototype.addEventListener=function(n,e){return this._eventEmitter.addListener(n,e)},t.prototype.dispatchEvent=function(n){for(var e,i=[],r=1;r<arguments.length;r++)i[r-1]=arguments[r];return(e=this._eventEmitter).emit.apply(e,Za([n],i,!1))},t.prototype.removeEventListener=function(n,e){return this._eventEmitter.removeListener(n,e)},t}();dn.default=es;var ts=H&&H.__extends||function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,r){i.__proto__=r}||function(i,r){for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(i[o]=r[o])},t(n,e)};return function(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");t(n,e);function i(){this.constructor=n}n.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),lt=H&&H.__awaiter||function(t,n,e,i){function r(o){return o instanceof e?o:new e(function(c){c(o)})}return new(e||(e=Promise))(function(o,c){function y(D){try{I(i.next(D))}catch(v){c(v)}}function P(D){try{I(i.throw(D))}catch(v){c(v)}}function I(D){D.done?o(D.value):r(D.value).then(y,P)}I((i=i.apply(t,n||[])).next())})},ut=H&&H.__generator||function(t,n){var e={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},i,r,o,c=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return c.next=y(0),c.throw=y(1),c.return=y(2),typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function y(I){return function(D){return P([I,D])}}function P(I){if(i)throw new TypeError("Generator is already executing.");for(;c&&(c=0,I[0]&&(e=0)),e;)try{if(i=1,r&&(o=I[0]&2?r.return:I[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,I[1])).done)return o;switch(r=0,o&&(I=[I[0]&2,o.value]),I[0]){case 0:case 1:o=I;break;case 4:return e.label++,{value:I[1],done:!1};case 5:e.label++,r=I[1],I=[0];continue;case 7:I=e.ops.pop(),e.trys.pop();continue;default:if(o=e.trys,!(o=o.length>0&&o[o.length-1])&&(I[0]===6||I[0]===2)){e=0;continue}if(I[0]===3&&(!o||I[1]>o[0]&&I[1]<o[3])){e.label=I[1];break}if(I[0]===6&&e.label<o[1]){e.label=o[1],o=I;break}if(o&&e.label<o[2]){e.label=o[2],e.ops.push(I);break}o[2]&&e.ops.pop(),e.trys.pop();continue}I=n.call(t,e)}catch(D){I=[6,D],r=0}finally{i=o=0}if(I[0]&5)throw I[1];return{value:I[0]?I[1]:void 0,done:!0}}};Object.defineProperty(ln,"__esModule",{value:!0});var ns=un,is=dn,rs=function(t){ts(n,t);function n(e,i,r){i===void 0&&(i={}),r===void 0&&(r={});var o=t.call(this)||this;return o._audioNode=null,o._loop=!1,o._pendingPlayDeferreds=[],o._sinkId="default",o._src="",typeof i!="string"&&(r=i),o._audioContext=e,o._audioElement=new(r.AudioFactory||Audio),o._bufferPromise=o._createPlayDeferred().promise,o._destination=o._audioContext.destination,o._gainNode=o._audioContext.createGain(),o._gainNode.connect(o._destination),o._XMLHttpRequest=r.XMLHttpRequestFactory||XMLHttpRequest,o.addEventListener("canplaythrough",function(){o._resolvePlayDeferreds()}),typeof i=="string"&&(o.src=i),o}return Object.defineProperty(n.prototype,"destination",{get:function(){return this._destination},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"loop",{get:function(){return this._loop},set:function(e){var i=this;function r(){i._audioNode.removeEventListener("ended",r),i.pause()}!e&&this.loop&&!this.paused&&this._audioNode.addEventListener("ended",r),this._loop=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"muted",{get:function(){return this._gainNode.gain.value===0},set:function(e){this._gainNode.gain.value=e?0:1},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"paused",{get:function(){return this._audioNode===null},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"src",{get:function(){return this._src},set:function(e){this._load(e)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"srcObject",{get:function(){return this._audioElement.srcObject},set:function(e){this._audioElement.srcObject=e},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"sinkId",{get:function(){return this._sinkId},enumerable:!1,configurable:!0}),n.prototype.load=function(){this._load(this._src)},n.prototype.pause=function(){this.paused||(this._audioElement.pause(),this._audioNode.stop(),this._audioNode.disconnect(this._gainNode),this._audioNode=null,this._rejectPlayDeferreds(new Error("The play() request was interrupted by a call to pause().")))},n.prototype.play=function(){return lt(this,void 0,void 0,function(){var e,i=this;return ut(this,function(r){switch(r.label){case 0:return this.paused?[3,2]:[4,this._bufferPromise];case 1:if(r.sent(),!this.paused)return[2];throw new Error("The play() request was interrupted by a call to pause().");case 2:return this._audioNode=this._audioContext.createBufferSource(),this._audioNode.loop=this.loop,this._audioNode.addEventListener("ended",function(){i._audioNode&&i._audioNode.loop||i.dispatchEvent("ended")}),[4,this._bufferPromise];case 3:if(e=r.sent(),this.paused)throw new Error("The play() request was interrupted by a call to pause().");return this._audioNode.buffer=e,this._audioNode.connect(this._gainNode),this._audioNode.start(),this._audioElement.srcObject?[2,this._audioElement.play()]:[2]}})})},n.prototype.setSinkId=function(e){return lt(this,void 0,void 0,function(){return ut(this,function(i){switch(i.label){case 0:if(typeof this._audioElement.setSinkId!="function")throw new Error("This browser does not support setSinkId.");return e===this.sinkId?[2]:e==="default"?(this.paused||this._gainNode.disconnect(this._destination),this._audioElement.srcObject=null,this._destination=this._audioContext.destination,this._gainNode.connect(this._destination),this._sinkId=e,[2]):[4,this._audioElement.setSinkId(e)];case 1:return i.sent(),this._audioElement.srcObject?[2]:(this._gainNode.disconnect(this._audioContext.destination),this._destination=this._audioContext.createMediaStreamDestination(),this._audioElement.srcObject=this._destination.stream,this._sinkId=e,this._gainNode.connect(this._destination),[2])}})})},n.prototype._createPlayDeferred=function(){var e=new ns.default;return this._pendingPlayDeferreds.push(e),e},n.prototype._load=function(e){var i=this;this._src&&this._src!==e&&this.pause(),this._src=e,this._bufferPromise=new Promise(function(r,o){return lt(i,void 0,void 0,function(){var c;return ut(this,function(y){switch(y.label){case 0:return e?[4,os(this._audioContext,this._XMLHttpRequest,e)]:[2,this._createPlayDeferred().promise];case 1:return c=y.sent(),this.dispatchEvent("canplaythrough"),r(c),[2]}})})})},n.prototype._rejectPlayDeferreds=function(e){var i=this._pendingPlayDeferreds;i.splice(0,i.length).forEach(function(r){var o=r.reject;return o(e)})},n.prototype._resolvePlayDeferreds=function(e){var i=this._pendingPlayDeferreds;i.splice(0,i.length).forEach(function(r){var o=r.resolve;return o(e)})},n}(is.default);function os(t,n,e){return lt(this,void 0,void 0,function(){var i,r;return ut(this,function(o){switch(o.label){case 0:return i=new n,i.open("GET",e,!0),i.responseType="arraybuffer",[4,new Promise(function(c){i.addEventListener("load",c),i.send()})];case 1:r=o.sent();try{return[2,t.decodeAudioData(r.target.response)]}catch{return[2,new Promise(function(y){t.decodeAudioData(r.target.response,y)})]}return[2]}})})}ln.default=rs;Object.defineProperty(sn,"__esModule",{value:!0});var as=Tt,Un=ln,ji=ce;function ye(t,n,e){if(!(this instanceof ye))return new ye(t,n,e);if(!t||!n)throw new ji.InvalidArgumentError("name and url are required arguments");e=Object.assign({AudioFactory:typeof Audio<"u"?Audio:null,maxDuration:0,shouldLoop:!1},e),e.AudioPlayer=e.audioContext?Un.default.bind(Un.default,e.audioContext):e.AudioFactory,Object.defineProperties(this,{_Audio:{value:e.AudioPlayer},_activeEls:{value:new Map},_isSinkSupported:{value:e.AudioFactory!==null&&typeof e.AudioFactory.prototype.setSinkId=="function"},_maxDuration:{value:e.maxDuration},_maxDurationTimeout:{value:null,writable:!0},_operations:{value:new as.AsyncQueue},_playPromise:{value:null,writable:!0},_shouldLoop:{value:e.shouldLoop},_sinkIds:{value:["default"]},isPlaying:{enumerable:!0,get:function(){return!!this._playPromise}},name:{enumerable:!0,value:t},url:{enumerable:!0,value:n}}),this._Audio&&this._play(!0,!1)}function Ui(t){t&&(t.pause(),t.src="",t.srcObject=null,t.load())}ye.prototype._playAudioElement=function(n,e,i){var r=this,o=this._activeEls.get(n);if(!o)throw new ji.InvalidArgumentError('sinkId: "'.concat(n,`" doesn't have an audio element`));return o.muted=!!e,o.loop=!!i,o.play().then(function(){return o}).catch(function(c){throw Ui(o),r._activeEls.delete(n),c})};ye.prototype._play=function(n,e){this.isPlaying&&this._stop(),this._maxDuration>0&&(this._maxDurationTimeout=setTimeout(this._stop.bind(this),this._maxDuration)),e=typeof e=="boolean"?e:this._shouldLoop;var i=this,r=this._playPromise=Promise.all(this._sinkIds.map(function(c){if(!i._Audio)return Promise.resolve();var y=i._activeEls.get(c);return y?i._playAudioElement(c,n,e):(y=new i._Audio(i.url),typeof y.setAttribute=="function"&&y.setAttribute("crossorigin","anonymous"),new Promise(function(P){y.addEventListener("canplaythrough",P)}).then(function(){return(i._isSinkSupported?y.setSinkId(c):Promise.resolve()).then(function(){return i._activeEls.set(c,y),i._playPromise?i._playAudioElement(c,n,e):Promise.resolve()})}))}));return r};ye.prototype._stop=function(){var n=this;this._activeEls.forEach(function(e,i){n._sinkIds.includes(i)?(e.pause(),e.currentTime=0):(Ui(e),n._activeEls.delete(i))}),clearTimeout(this._maxDurationTimeout),this._playPromise=null,this._maxDurationTimeout=null};ye.prototype.setSinkIds=function(n){this._isSinkSupported&&(n=n.forEach?n:[n],[].splice.apply(this._sinkIds,[0,this._sinkIds.length].concat(n)))};ye.prototype.stop=function(){var n=this;this._operations.enqueue(function(){return n._stop(),Promise.resolve()})};ye.prototype.play=function(){var n=this;return this._operations.enqueue(function(){return n._play()})};sn.default=ye;var Nn;function Et(){if(Nn)return nt;Nn=1;var t=H&&H.__extends||function(){var E=function(f,S){return E=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,j){a.__proto__=j}||function(a,j){for(var C in j)Object.prototype.hasOwnProperty.call(j,C)&&(a[C]=j[C])},E(f,S)};return function(f,S){if(typeof S!="function"&&S!==null)throw new TypeError("Class extends value "+String(S)+" is not a constructor or null");E(f,S);function a(){this.constructor=f}f.prototype=S===null?Object.create(S):(a.prototype=S.prototype,new a)}}(),n=H&&H.__assign||function(){return n=Object.assign||function(E){for(var f,S=1,a=arguments.length;S<a;S++){f=arguments[S];for(var j in f)Object.prototype.hasOwnProperty.call(f,j)&&(E[j]=f[j])}return E},n.apply(this,arguments)},e=H&&H.__awaiter||function(E,f,S,a){function j(C){return C instanceof S?C:new S(function(V){V(C)})}return new(S||(S=Promise))(function(C,V){function k(M){try{A(a.next(M))}catch(B){V(B)}}function x(M){try{A(a.throw(M))}catch(B){V(B)}}function A(M){M.done?C(M.value):j(M.value).then(k,x)}A((a=a.apply(E,f||[])).next())})},i=H&&H.__generator||function(E,f){var S={label:0,sent:function(){if(C[0]&1)throw C[1];return C[1]},trys:[],ops:[]},a,j,C,V=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return V.next=k(0),V.throw=k(1),V.return=k(2),typeof Symbol=="function"&&(V[Symbol.iterator]=function(){return this}),V;function k(A){return function(M){return x([A,M])}}function x(A){if(a)throw new TypeError("Generator is already executing.");for(;V&&(V=0,A[0]&&(S=0)),S;)try{if(a=1,j&&(C=A[0]&2?j.return:A[0]?j.throw||((C=j.return)&&C.call(j),0):j.next)&&!(C=C.call(j,A[1])).done)return C;switch(j=0,C&&(A=[A[0]&2,C.value]),A[0]){case 0:case 1:C=A;break;case 4:return S.label++,{value:A[1],done:!1};case 5:S.label++,j=A[1],A=[0];continue;case 7:A=S.ops.pop(),S.trys.pop();continue;default:if(C=S.trys,!(C=C.length>0&&C[C.length-1])&&(A[0]===6||A[0]===2)){S=0;continue}if(A[0]===3&&(!C||A[1]>C[0]&&A[1]<C[3])){S.label=A[1];break}if(A[0]===6&&S.label<C[1]){S.label=C[1],C=A;break}if(C&&S.label<C[2]){S.label=C[2],S.ops.push(A);break}C[2]&&S.ops.pop(),S.trys.pop();continue}A=f.call(E,S)}catch(M){A=[6,M],j=0}finally{a=C=0}if(A[0]&5)throw A[1];return{value:A[0]?A[1]:void 0,done:!0}}};Object.defineProperty(nt,"__esModule",{value:!0});var r=me,o=mi,c=ko(),y=bt,P=pn(),I=se,D=Kt,v=ce,p=Xt,m=le,s=xi(),g=tn,_=Ai,d=De,u=an,R=kt,b=sn,h=re,w=3e4,L=2e3,l="twilio-js-sdk",$='Parameter "token" must be of type "string".',T=function(E){t(f,E);function f(S,a){var j;a===void 0&&(a={});var C=E.call(this)||this;if(C._activeCall=null,C._audio=null,C._audioProcessorEventObserver=null,C._callInputStream=null,C._calls=[],C._callSinkIds=["default"],C._chunderURIs=[],C._defaultOptions={allowIncomingWhileBusy:!1,closeProtection:!1,codecPreferences:[P.default.Codec.PCMU,P.default.Codec.Opus],dscp:!0,enableImprovedSignalingErrorPrecision:!1,forceAggressiveIceNomination:!1,logLevel:o.levels.ERROR,maxCallSignalingTimeoutMs:0,preflight:!1,sounds:{},tokenRefreshMs:1e4,voiceEventSidGenerator:R.generateVoiceEventSid},C._edge=null,C._home=null,C._identity=null,C._log=new m.default("Device"),C._makeCallPromise=null,C._options={},C._preferredURI=null,C._publisher=null,C._region=null,C._regTimer=null,C._shouldReRegister=!1,C._soundcache=new Map,C._state=f.State.Unregistered,C._stateEventMapping=(j={},j[f.State.Destroyed]=f.EventName.Destroyed,j[f.State.Unregistered]=f.EventName.Unregistered,j[f.State.Registering]=f.EventName.Registering,j[f.State.Registered]=f.EventName.Registered,j),C._stream=null,C._streamConnectedPromise=null,C._tokenWillExpireTimeout=null,C._createDefaultPayload=function(A){var M={aggressive_nomination:C._options.forceAggressiveIceNomination,browser_extension:C._isBrowserExtension,dscp:!!C._options.dscp,ice_restart_enabled:!0,platform:d.getMediaEngine(),sdk_version:I.RELEASE_VERSION};function B(Q,K){K&&(M[Q]=K)}if(A){var U=A.parameters.CallSid;B("call_sid",/^TJ/.test(U)?void 0:U),B("temp_call_sid",A.outboundConnectionId),B("audio_codec",A.codec),M.direction=A.direction}return B("gateway",C._stream&&C._stream.gateway),B("region",C._stream&&C._stream.region),M},C._onSignalingClose=function(){C._stream=null,C._streamConnectedPromise=null},C._onSignalingConnected=function(A){var M,B=(0,_.getRegionShortcode)(A.region);if(C._edge=A.edge||_.regionToEdge[B]||A.region,C._region=B||A.region,C._home=A.home,(M=C._publisher)===null||M===void 0||M.setHost((0,_.createEventGatewayURI)(A.home)),A.token&&(C._identity=A.token.identity,typeof A.token.ttl=="number"&&typeof C._options.tokenRefreshMs=="number")){var U=A.token.ttl*1e3,Q=Math.max(0,U-C._options.tokenRefreshMs);C._tokenWillExpireTimeout=setTimeout(function(){C._log.debug("#tokenWillExpire"),C.emit("tokenWillExpire",C),C._tokenWillExpireTimeout&&(clearTimeout(C._tokenWillExpireTimeout),C._tokenWillExpireTimeout=null)},Q)}var K=C._getChunderws()||(0,_.getChunderURIs)(C._edge);if(K.length>0){var X=K[0];C._preferredURI=(0,_.createSignalingEndpointURL)(X)}else C._log.warn("Could not parse a preferred URI from the stream#connected event.");C._shouldReRegister&&C.register()},C._onSignalingError=function(A){if(typeof A!="object"){C._log.warn("Invalid signaling error payload",A);return}var M=A.error,B=A.callsid,U=A.voiceeventsid;if(typeof M!="object"||U){C._log.warn("Ignoring signaling error payload",{originalError:M,voiceeventsid:U});return}var Q=typeof B=="string"&&C._findCall(B)||void 0,K=M.code,X=M.message,Z=M.twilioError;if(typeof K=="number")if(K===31201)Z=new v.AuthorizationErrors.AuthenticationFailed(M);else if(K===31204)Z=new v.AuthorizationErrors.AccessTokenInvalid(M);else if(K===31205)C._stopRegistrationTimer(),Z=new v.AuthorizationErrors.AccessTokenExpired(M);else{var ae=(0,v.getPreciseSignalingErrorByCode)(!!C._options.enableImprovedSignalingErrorPrecision,K);typeof ae<"u"&&(Z=new ae(M))}Z||(C._log.error("Unknown signaling error: ",M),Z=new v.GeneralErrors.UnknownError(X,M)),C._log.error("Received error: ",Z),C._log.debug("#error",M),C.emit(f.EventName.Error,Z,Q)},C._onSignalingInvite=function(A){return e(C,void 0,void 0,function(){var M,B,U,Q,K,X=this,Z;return i(this,function(ae){switch(ae.label){case 0:if(M=!!this._activeCall,M&&!this._options.allowIncomingWhileBusy)return this._log.info("Device busy; ignoring incoming invite"),[2];if(!A.callsid||!A.sdp)return this._log.debug("#error",A),this.emit(f.EventName.Error,new v.ClientErrors.BadRequest("Malformed invite from gateway")),[2];B=A.parameters||{},B.CallSid=B.CallSid||A.callsid,U=Object.assign({},(0,h.queryToJson)(B.Params)),this._makeCallPromise=this._makeCall(U,{callParameters:B,enableImprovedSignalingErrorPrecision:!!this._options.enableImprovedSignalingErrorPrecision,offerSdp:A.sdp,reconnectToken:A.reconnect,voiceEventSidGenerator:this._options.voiceEventSidGenerator}),ae.label=1;case 1:return ae.trys.push([1,,3,4]),[4,this._makeCallPromise];case 2:return Q=ae.sent(),[3,4];case 3:return this._makeCallPromise=null,[7];case 4:return this._calls.push(Q),Q.once("accept",function(){X._soundcache.get(f.SoundName.Incoming).stop(),X._publishNetworkChange()}),K=!((Z=this._audio)===null||Z===void 0)&&Z.incoming()&&!M?function(){return X._soundcache.get(f.SoundName.Incoming).play()}:function(){return Promise.resolve()},this._showIncomingCall(Q,K),[2]}})})},C._onSignalingOffline=function(){C._log.info("Stream is offline"),C._edge=null,C._region=null,C._shouldReRegister=C.state!==f.State.Unregistered,C._setState(f.State.Unregistered)},C._onSignalingReady=function(){C._log.info("Stream is ready"),C._setState(f.State.Registered)},C._publishNetworkChange=function(){C._activeCall&&C._networkInformation&&C._publisher.info("network-information","network-change",{connection_type:C._networkInformation.type,downlink:C._networkInformation.downlink,downlinkMax:C._networkInformation.downlinkMax,effective_type:C._networkInformation.effectiveType,rtt:C._networkInformation.rtt},C._activeCall)},C._updateInputStream=function(A){var M=C._activeCall;return M&&!A?Promise.reject(new v.InvalidStateError("Cannot unset input device while a call is in progress.")):(C._callInputStream=A,M?M._setInputTracksFromStream(A):Promise.resolve())},C._updateSinkIds=function(A,M){var B=A==="ringtone"?C._updateRingtoneSinkIds(M):C._updateSpeakerSinkIds(M);return B.then(function(){C._publisher.info("audio","".concat(A,"-devices-set"),{audio_device_ids:M},C._activeCall)},function(U){throw C._publisher.error("audio","".concat(A,"-devices-set-failed"),{audio_device_ids:M,message:U.message},C._activeCall),U})},C._setupLoglevel(a.logLevel),C._logOptions("constructor",a),C.updateToken(S),(0,h.isLegacyEdge)())throw new v.NotSupportedError("Microsoft Edge Legacy (https://support.microsoft.com/en-us/help/4533505/what-is-microsoft-edge-legacy) is deprecated and will not be able to connect to Twilio to make or receive calls after September 1st, 2020. Please see this documentation for a list of supported browsers https://www.twilio.com/docs/voice/client/javascript#supported-browsers");if(!f.isSupported&&a.ignoreBrowserSupport)throw window&&window.location&&window.location.protocol==="http:"?new v.NotSupportedError("twilio.js wasn't able to find WebRTC browser support.           This is most likely because this page is served over http rather than https,           which does not support WebRTC in many browsers. Please load this page over https and           try again."):new v.NotSupportedError("twilio.js 1.3+ SDKs require WebRTC browser support.         For more information, see <https://www.twilio.com/docs/api/client/twilio-js>.         If you have any questions about this announcement, please contact         Twilio Support at <help@twilio.com>.");var V=globalThis,k=V.msBrowser||V.browser||V.chrome;if(C._isBrowserExtension=!!k&&!!k.runtime&&!!k.runtime.id||!!V.safari&&!!V.safari.extension,C._isBrowserExtension&&C._log.info("Running as browser extension."),navigator){var x=navigator;C._networkInformation=x.connection||x.mozConnection||x.webkitConnection}return C._networkInformation&&typeof C._networkInformation.addEventListener=="function"&&C._networkInformation.addEventListener("change",C._publishNetworkChange),f._getOrCreateAudioContext(),f._audioContext&&(f._dialtonePlayer||(f._dialtonePlayer=new D.default(f._audioContext))),typeof f._isUnifiedPlanDefault>"u"&&(f._isUnifiedPlanDefault=typeof window<"u"&&typeof RTCPeerConnection<"u"&&typeof RTCRtpTransceiver<"u"?(0,h.isUnifiedPlanDefault)(window,window.navigator,RTCPeerConnection,RTCRtpTransceiver):!1),C._boundDestroy=C.destroy.bind(C),C._boundConfirmClose=C._confirmClose.bind(C),typeof window<"u"&&window.addEventListener&&(window.addEventListener("unload",C._boundDestroy),window.addEventListener("pagehide",C._boundDestroy)),C.updateOptions(a),C}return Object.defineProperty(f,"audioContext",{get:function(){return f._audioContext},enumerable:!1,configurable:!0}),Object.defineProperty(f,"extension",{get:function(){var S=typeof document<"u"?document.createElement("audio"):{canPlayType:!1},a;try{a=S.canPlayType&&!!S.canPlayType("audio/mpeg").replace(/no/,"")}catch{a=!1}var j;try{j=S.canPlayType&&!!S.canPlayType("audio/ogg;codecs='vorbis'").replace(/no/,"")}catch{j=!1}return j&&!a?"ogg":"mp3"},enumerable:!1,configurable:!0}),Object.defineProperty(f,"isSupported",{get:function(){return d.enabled()},enumerable:!1,configurable:!0}),Object.defineProperty(f,"packageName",{get:function(){return I.PACKAGE_NAME},enumerable:!1,configurable:!0}),f.runPreflight=function(S,a){return new s.PreflightTest(S,n({audioContext:f._getOrCreateAudioContext()},a))},f.toString=function(){return"[Twilio.Device class]"},Object.defineProperty(f,"version",{get:function(){return I.RELEASE_VERSION},enumerable:!1,configurable:!0}),f._getOrCreateAudioContext=function(){return f._audioContext||(typeof AudioContext<"u"?f._audioContext=new AudioContext:typeof webkitAudioContext<"u"&&(f._audioContext=new webkitAudioContext)),f._audioContext},Object.defineProperty(f.prototype,"audio",{get:function(){return this._audio},enumerable:!1,configurable:!0}),f.prototype.connect=function(){return e(this,arguments,void 0,function(S){var a,j,C,V,k,x,A,M,B;return S===void 0&&(S={}),i(this,function(U){switch(U.label){case 0:if(this._log.debug(".connect",JSON.stringify(S)),this._throwIfDestroyed(),this._activeCall)throw new v.InvalidStateError("A Call is already active");if(S.connectToken){try{V=JSON.parse(decodeURIComponent(atob(S.connectToken))),a=V.customParameters,j=V.parameters,C=V.signalingReconnectToken}catch{throw new v.InvalidArgumentError("Cannot parse connectToken")}if(!j||!j.CallSid||!C)throw new v.InvalidArgumentError("Invalid connectToken")}k=!1,x={},A={enableImprovedSignalingErrorPrecision:!!this._options.enableImprovedSignalingErrorPrecision,rtcConfiguration:S.rtcConfiguration,voiceEventSidGenerator:this._options.voiceEventSidGenerator},C&&j?(k=!0,A.callParameters=j,A.reconnectCallSid=j.CallSid,A.reconnectToken=C,x=a||x):x=S.params||x,this._makeCallPromise=this._makeCall(x,A,k),U.label=1;case 1:return U.trys.push([1,,3,4]),B=this,[4,this._makeCallPromise];case 2:return M=B._activeCall=U.sent(),[3,4];case 3:return this._makeCallPromise=null,[7];case 4:return this._calls.splice(0).forEach(function(Q){return Q.ignore()}),this._soundcache.get(f.SoundName.Incoming).stop(),M.accept({rtcConstraints:S.rtcConstraints}),this._publishNetworkChange(),[2,M]}})})},Object.defineProperty(f.prototype,"calls",{get:function(){return this._calls},enumerable:!1,configurable:!0}),f.prototype.destroy=function(){var S;this._log.debug(".destroy"),this._log.debug("Rejecting any incoming calls");var a=this._calls.slice(0);a.forEach(function(j){return j.reject()}),this.disconnectAll(),this._stopRegistrationTimer(),this._destroyStream(),this._destroyAudioHelper(),(S=this._audioProcessorEventObserver)===null||S===void 0||S.destroy(),this._destroyPublisher(),this._networkInformation&&typeof this._networkInformation.removeEventListener=="function"&&this._networkInformation.removeEventListener("change",this._publishNetworkChange),typeof window<"u"&&window.removeEventListener&&(window.removeEventListener("beforeunload",this._boundConfirmClose),window.removeEventListener("unload",this._boundDestroy),window.removeEventListener("pagehide",this._boundDestroy)),this._setState(f.State.Destroyed),r.EventEmitter.prototype.removeAllListeners.call(this)},f.prototype.disconnectAll=function(){this._log.debug(".disconnectAll");var S=this._calls.splice(0);S.forEach(function(a){return a.disconnect()}),this._activeCall&&this._activeCall.disconnect()},Object.defineProperty(f.prototype,"edge",{get:function(){return this._edge},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"home",{get:function(){return this._home},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"identity",{get:function(){return this._identity},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"isBusy",{get:function(){return!!this._activeCall},enumerable:!1,configurable:!0}),f.prototype.register=function(){return e(this,void 0,void 0,function(){return i(this,function(S){switch(S.label){case 0:if(this._log.debug(".register"),this.state!==f.State.Unregistered)throw new v.InvalidStateError('Attempt to register when device is in state "'.concat(this.state,'". ')+'Must be "'.concat(f.State.Unregistered,'".'));return this._shouldReRegister=!1,this._setState(f.State.Registering),[4,this._streamConnectedPromise||this._setupStream()];case 1:return S.sent(),[4,this._sendPresence(!0)];case 2:return S.sent(),[4,(0,h.promisifyEvents)(this,f.State.Registered,f.State.Unregistered)];case 3:return S.sent(),[2]}})})},Object.defineProperty(f.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0}),Object.defineProperty(f.prototype,"token",{get:function(){return this._token},enumerable:!1,configurable:!0}),f.prototype.toString=function(){return"[Twilio.Device instance]"},f.prototype.unregister=function(){return e(this,void 0,void 0,function(){var S,a;return i(this,function(j){switch(j.label){case 0:if(this._log.debug(".unregister"),this.state!==f.State.Registered)throw new v.InvalidStateError('Attempt to unregister when device is in state "'.concat(this.state,'". ')+'Must be "'.concat(f.State.Registered,'".'));return this._shouldReRegister=!1,[4,this._streamConnectedPromise];case 1:return S=j.sent(),a=new Promise(function(C){S.on("offline",C)}),[4,this._sendPresence(!1)];case 2:return j.sent(),[4,a];case 3:return j.sent(),[2]}})})},f.prototype.updateOptions=function(S){if(S===void 0&&(S={}),this._logOptions("updateOptions",S),this.state===f.State.Destroyed)throw new v.InvalidStateError('Attempt to "updateOptions" when device is in state "'.concat(this.state,'".'));this._options=n(n(n({},this._defaultOptions),this._options),S);var a=new Set(this._chunderURIs),j=this._chunderURIs=(this._getChunderws()||(0,_.getChunderURIs)(this._options.edge)).map(_.createSignalingEndpointURL),C=a.size!==j.length;if(!C)for(var V=0,k=j;V<k.length;V++){var x=k[V];if(!a.has(x)){C=!0;break}}if(this.isBusy&&C)throw new v.InvalidStateError("Cannot change Edge while on an active Call");this._setupLoglevel(this._options.logLevel);for(var A=0,M=Object.keys(f._defaultSounds);A<M.length;A++){var B=M[A],U=f._defaultSounds[B],Q="".concat(I.SOUNDS_BASE_URL,"/").concat(U.filename,".").concat(f.extension)+"?cache=".concat(I.RELEASE_VERSION),K=this._options.sounds&&this._options.sounds[B]||Q,X=new(this._options.Sound||b.default)(B,K,{audioContext:this._options.disableAudioContextSounds?null:f.audioContext,maxDuration:U.maxDuration,shouldLoop:U.shouldLoop});this._soundcache.set(B,X)}this._setupAudioHelper(),this._setupPublisher(),C&&this._streamConnectedPromise&&this._setupStream(),typeof window<"u"&&typeof window.addEventListener=="function"&&this._options.closeProtection&&(window.removeEventListener("beforeunload",this._boundConfirmClose),window.addEventListener("beforeunload",this._boundConfirmClose))},f.prototype.updateToken=function(S){if(this._log.debug(".updateToken"),this.state===f.State.Destroyed)throw new v.InvalidStateError('Attempt to "updateToken" when device is in state "'.concat(this.state,'".'));if(typeof S!="string")throw new v.InvalidArgumentError($);this._token=S,this._stream&&this._stream.setToken(this._token),this._publisher&&this._publisher.setToken(this._token)},f.prototype._confirmClose=function(S){if(!this._activeCall)return"";var a=this._options.closeProtection||!1,j=typeof a!="string"?"A call is currently in-progress. Leaving or reloading this page will end the call.":a;return(S||window.event).returnValue=j,j},f.prototype._destroyAudioHelper=function(){this._audio&&(this._audio._destroy(),this._audio=null)},f.prototype._destroyPublisher=function(){this._publisher&&(this._publisher=null)},f.prototype._destroyStream=function(){this._stream&&(this._stream.removeListener("close",this._onSignalingClose),this._stream.removeListener("connected",this._onSignalingConnected),this._stream.removeListener("error",this._onSignalingError),this._stream.removeListener("invite",this._onSignalingInvite),this._stream.removeListener("offline",this._onSignalingOffline),this._stream.removeListener("ready",this._onSignalingReady),this._stream.destroy(),this._stream=null),this._onSignalingOffline(),this._streamConnectedPromise=null},f.prototype._findCall=function(S){return this._calls.find(function(a){return a.parameters.CallSid===S||a.outboundConnectionId===S})||null},f.prototype._getChunderws=function(){return typeof this._options.chunderw=="string"?[this._options.chunderw]:Array.isArray(this._options.chunderw)?this._options.chunderw:null},f.prototype._logOptions=function(S,a){a===void 0&&(a={});var j=["allowIncomingWhileBusy","appName","appVersion","closeProtection","codecPreferences","disableAudioContextSounds","dscp","edge","enableImprovedSignalingErrorPrecision","forceAggressiveIceNomination","logLevel","maxAverageBitrate","maxCallSignalingTimeoutMs","sounds","tokenRefreshMs"],C=["RTCPeerConnection","enumerateDevices","getUserMedia","MediaStream"];if(typeof a=="object"){var V=n({},a);Object.keys(V).forEach(function(k){!j.includes(k)&&!C.includes(k)&&delete V[k],C.includes(k)&&(V[k]=!0)}),this._log.debug(".".concat(S),JSON.stringify(V))}},f.prototype._makeCall=function(S,a){return e(this,arguments,void 0,function(j,C,V){var k,x,A,M,B,U=this,Q;return V===void 0&&(V=!1),i(this,function(K){switch(K.label){case 0:if(typeof f._isUnifiedPlanDefault>"u")throw new v.InvalidStateError("Device has not been initialized.");return k=(Q=this._audio)===null||Q===void 0?void 0:Q._getInputDevicePromise(),k?(this._log.debug("inputDevicePromise detected, waiting..."),[4,k]):[3,2];case 1:K.sent(),this._log.debug("inputDevicePromise resolved"),K.label=2;case 2:return B={audioHelper:this._audio,isUnifiedPlanDefault:f._isUnifiedPlanDefault,onIgnore:function(){U._soundcache.get(f.SoundName.Incoming).stop()}},[4,this._streamConnectedPromise||this._setupStream()];case 3:return x=(B.pstream=K.sent(),B.publisher=this._publisher,B.soundcache=this._soundcache,B),C=Object.assign({MediaStream:this._options.MediaStream,RTCPeerConnection:this._options.RTCPeerConnection,beforeAccept:function(X){!U._activeCall||U._activeCall===X||(U._activeCall.disconnect(),U._removeCall(U._activeCall))},codecPreferences:this._options.codecPreferences,customSounds:this._options.sounds,dialtonePlayer:f._dialtonePlayer,dscp:this._options.dscp,forceAggressiveIceNomination:this._options.forceAggressiveIceNomination,getInputStream:function(){return U._options.fileInputStream||U._callInputStream},getSinkIds:function(){return U._callSinkIds},maxAverageBitrate:this._options.maxAverageBitrate,preflight:this._options.preflight,rtcConstraints:this._options.rtcConstraints,shouldPlayDisconnect:function(){var X;return(X=U._audio)===null||X===void 0?void 0:X.disconnect()},twimlParams:j,voiceEventSidGenerator:this._options.voiceEventSidGenerator},C),A=function(){if(!U._stream){U._log.warn("UnsetPreferredUri called without a stream");return}U._activeCall===null&&U._calls.length===0&&U._stream.updatePreferredURI(null)},M=new(this._options.Call||P.default)(x,C),this._publisher.info("settings","init",{MediaStream:!!this._options.MediaStream,RTCPeerConnection:!!this._options.RTCPeerConnection,enumerateDevices:!!this._options.enumerateDevices,getUserMedia:!!this._options.getUserMedia},M),M.once("accept",function(){var X,Z,ae;U._stream.updatePreferredURI(U._preferredURI),U._removeCall(M),U._activeCall=M,U._audio&&U._audio._maybeStartPollingVolume(),M.direction===P.default.CallDirection.Outgoing&&(!((X=U._audio)===null||X===void 0)&&X.outgoing())&&!V&&U._soundcache.get(f.SoundName.Outgoing).play();var fe={edge:U._edge||U._region};U._options.edge&&(fe.selected_edge=Array.isArray(U._options.edge)?U._options.edge:[U._options.edge]),U._publisher.info("settings","edge",fe,M),!((Z=U._audio)===null||Z===void 0)&&Z.processedStream&&((ae=U._audioProcessorEventObserver)===null||ae===void 0||ae.emit("enabled"))}),M.addListener("error",function(X){M.status()==="closed"&&(U._removeCall(M),A()),U._audio&&U._audio._maybeStopPollingVolume(),U._maybeStopIncomingSound()}),M.once("cancel",function(){U._log.info("Canceled: ".concat(M.parameters.CallSid)),U._removeCall(M),A(),U._audio&&U._audio._maybeStopPollingVolume(),U._maybeStopIncomingSound()}),M.once("disconnect",function(){U._audio&&U._audio._maybeStopPollingVolume(),U._removeCall(M),A(),U._maybeStopIncomingSound()}),M.once("reject",function(){U._log.info("Rejected: ".concat(M.parameters.CallSid)),U._audio&&U._audio._maybeStopPollingVolume(),U._removeCall(M),A(),U._maybeStopIncomingSound()}),M.on("transportClose",function(){M.status()===P.default.State.Pending&&(U._audio&&U._audio._maybeStopPollingVolume(),U._removeCall(M),U._maybeStopIncomingSound())}),[2,M]}})})},f.prototype._maybeStopIncomingSound=function(){this._calls.length||this._soundcache.get(f.SoundName.Incoming).stop()},f.prototype._removeCall=function(S){this._activeCall===S&&(this._activeCall=null,this._makeCallPromise=null);for(var a=this._calls.length-1;a>=0;a--)S===this._calls[a]&&this._calls.splice(a,1)},f.prototype._sendPresence=function(S){return e(this,void 0,void 0,function(){var a;return i(this,function(j){switch(j.label){case 0:return[4,this._streamConnectedPromise];case 1:return a=j.sent(),a?(a.register({audio:S}),S?this._startRegistrationTimer():this._stopRegistrationTimer(),[2]):[2]}})})},f.prototype._setState=function(S){if(S!==this.state){this._state=S;var a=this._stateEventMapping[S];this._log.debug("#".concat(a)),this.emit(a)}},f.prototype._setupAudioHelper=function(){var S=this;this._audioProcessorEventObserver||(this._audioProcessorEventObserver=new y.AudioProcessorEventObserver,this._audioProcessorEventObserver.on("event",function(j){var C=j.name,V=j.group;S._publisher.info(V,C,{},S._activeCall)}));var a={audioContext:f.audioContext,audioProcessorEventObserver:this._audioProcessorEventObserver,beforeSetInputDevice:function(){return S._makeCallPromise?(S._log.debug("beforeSetInputDevice pause detected"),S._makeCallPromise):(S._log.debug("beforeSetInputDevice pause not detected, setting default"),Promise.resolve())},enumerateDevices:this._options.enumerateDevices,getUserMedia:this._options.getUserMedia||u.default};if(this._audio){this._log.info("Found existing audio helper; updating options..."),this._audio._updateUserOptions(a);return}this._audio=new(this._options.AudioHelper||c.default)(this._updateSinkIds,this._updateInputStream,a),this._audio.on("deviceChange",function(j){var C=S._activeCall,V=j.map(function(k){return k.deviceId});S._publisher.info("audio","device-change",{lost_active_device_ids:V},C),C&&C._mediaHandler._onInputDevicesChanged()})},f.prototype._setupLoglevel=function(S){var a=typeof S=="number"||typeof S=="string"?S:o.levels.ERROR;this._log.setDefaultLevel(a),this._log.info("Set logger default level to",a)},f.prototype._setupPublisher=function(){var S=this;this._publisher&&(this._log.info("Found existing publisher; destroying..."),this._destroyPublisher());var a={defaultPayload:this._createDefaultPayload,metadata:{app_name:this._options.appName,app_version:this._options.appVersion}};return this._options.eventgw&&(a.host=this._options.eventgw),this._home&&(a.host=(0,_.createEventGatewayURI)(this._home)),this._publisher=new(this._options.Publisher||p.default)(l,this.token,a),this._options.publishEvents===!1?this._publisher.disable():this._publisher.on("error",function(j){S._log.warn("Cannot connect to insights.",j)}),this._publisher},f.prototype._setupStream=function(){var S=this;return this._stream&&(this._log.info("Found existing stream; destroying..."),this._destroyStream()),this._log.info("Setting up VSP"),this._stream=new(this._options.PStream||g.default)(this.token,this._chunderURIs,{backoffMaxMs:this._options.backoffMaxMs,maxPreferredDurationMs:this._options.maxCallSignalingTimeoutMs}),this._stream.addListener("close",this._onSignalingClose),this._stream.addListener("connected",this._onSignalingConnected),this._stream.addListener("error",this._onSignalingError),this._stream.addListener("invite",this._onSignalingInvite),this._stream.addListener("offline",this._onSignalingOffline),this._stream.addListener("ready",this._onSignalingReady),this._streamConnectedPromise=(0,h.promisifyEvents)(this._stream,"connected","close").then(function(){return S._stream})},f.prototype._showIncomingCall=function(S,a){var j=this,C;return Promise.race([a(),new Promise(function(V,k){C=setTimeout(function(){var x="Playing incoming ringtone took too long; it might not play. Continuing execution...";k(new Error(x))},L)})]).catch(function(V){j._log.warn(V.message)}).then(function(){clearTimeout(C),j._log.debug("#incoming",JSON.stringify({customParameters:S.customParameters,parameters:S.parameters})),j.emit(f.EventName.Incoming,S)})},f.prototype._startRegistrationTimer=function(){var S=this;this._stopRegistrationTimer(),this._regTimer=setTimeout(function(){S._sendPresence(!0)},w)},f.prototype._stopRegistrationTimer=function(){this._regTimer&&clearTimeout(this._regTimer)},f.prototype._throwIfDestroyed=function(){if(this.state===f.State.Destroyed)throw new v.InvalidStateError("Device has been destroyed.")},f.prototype._updateRingtoneSinkIds=function(S){return Promise.resolve(this._soundcache.get(f.SoundName.Incoming).setSinkIds(S))},f.prototype._updateSpeakerSinkIds=function(S){Array.from(this._soundcache.entries()).filter(function(j){return j[0]!==f.SoundName.Incoming}).forEach(function(j){return j[1].setSinkIds(S)}),this._callSinkIds=S;var a=this._activeCall;return a?a._setSinkIds(S):Promise.resolve()},f._defaultSounds={disconnect:{filename:"disconnect",maxDuration:3e3},dtmf0:{filename:"dtmf-0",maxDuration:1e3},dtmf1:{filename:"dtmf-1",maxDuration:1e3},dtmf2:{filename:"dtmf-2",maxDuration:1e3},dtmf3:{filename:"dtmf-3",maxDuration:1e3},dtmf4:{filename:"dtmf-4",maxDuration:1e3},dtmf5:{filename:"dtmf-5",maxDuration:1e3},dtmf6:{filename:"dtmf-6",maxDuration:1e3},dtmf7:{filename:"dtmf-7",maxDuration:1e3},dtmf8:{filename:"dtmf-8",maxDuration:1e3},dtmf9:{filename:"dtmf-9",maxDuration:1e3},dtmfh:{filename:"dtmf-hash",maxDuration:1e3},dtmfs:{filename:"dtmf-star",maxDuration:1e3},incoming:{filename:"incoming",shouldLoop:!0},outgoing:{filename:"outgoing",maxDuration:3e3}},f}(r.EventEmitter);return function(E){(function(f){f.Error="error",f.Incoming="incoming",f.Destroyed="destroyed",f.Unregistered="unregistered",f.Registering="registering",f.Registered="registered",f.TokenWillExpire="tokenWillExpire"})(E.EventName||(E.EventName={})),function(f){f.Destroyed="destroyed",f.Unregistered="unregistered",f.Registering="registering",f.Registered="registered"}(E.State||(E.State={})),function(f){f.Incoming="incoming",f.Outgoing="outgoing",f.Disconnect="disconnect",f.Dtmf0="dtmf0",f.Dtmf1="dtmf1",f.Dtmf2="dtmf2",f.Dtmf3="dtmf3",f.Dtmf4="dtmf4",f.Dtmf5="dtmf5",f.Dtmf6="dtmf6",f.Dtmf7="dtmf7",f.Dtmf8="dtmf8",f.Dtmf9="dtmf9",f.DtmfS="dtmfs",f.DtmfH="dtmfh"}(E.SoundName||(E.SoundName={}))}(T||(T={})),nt.default=T,nt}var It={};Object.defineProperty(It,"__esModule",{value:!0});It.IceCandidate=void 0;var ss=function(){function t(n,e){e===void 0&&(e=!1),this.deleted=!1;var i,r=n.candidate.split("network-cost ");r[1]&&(i=parseInt(r[1],10)),this.candidateType=n.type,this.ip=n.ip||n.address,this.isRemote=e,this.networkCost=i,this.port=n.port,this.priority=n.priority,this.protocol=n.protocol,this.relatedAddress=n.relatedAddress,this.relatedPort=n.relatedPort,this.tcpType=n.tcpType,this.transportId=n.sdpMid}return t.prototype.toPayload=function(){return{candidate_type:this.candidateType,deleted:this.deleted,ip:this.ip,is_remote:this.isRemote,"network-cost":this.networkCost,port:this.port,priority:this.priority,protocol:this.protocol,related_address:this.relatedAddress,related_port:this.relatedPort,tcp_type:this.tcpType,transport_id:this.transportId}},t}();It.IceCandidate=ss;var fn={},Ke={};Object.defineProperty(Ke,"__esModule",{value:!0});Ke.calculate=Ni;Ke.isNonNegativeNumber=We;var Fn=94.768;function Ni(t,n,e){if(typeof t!="number"||typeof n!="number"||typeof e!="number"||!We(t)||!We(n)||!We(e))return null;var i=t+n*2+10,r=0;switch(!0){case i<160:r=Fn-i/40;break;case i<1e3:r=Fn-(i-120)/10;break}switch(!0){case e<=r/2.5:r=Math.max(r-e*2.5,6.52);break;default:r=0;break}var o=1+.035*r+7e-6*r*(r-60)*(100-r);return o}function We(t){return typeof t=="number"&&!isNaN(t)&&isFinite(t)&&t>=0}Ke.default={calculate:Ni,isNonNegativeNumber:We};var cs=H&&H.__extends||function(){var t=function(n,e){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,r){i.__proto__=r}||function(i,r){for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(i[o]=r[o])},t(n,e)};return function(n,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");t(n,e);function i(){this.constructor=n}n.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}(),Se=H&&H.__assign||function(){return Se=Object.assign||function(t){for(var n,e=1,i=arguments.length;e<i;e++){n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},Se.apply(this,arguments)},Vt=H&&H.__spreadArray||function(t,n,e){if(e||arguments.length===2)for(var i=0,r=n.length,o;i<r;i++)(o||!(i in n))&&(o||(o=Array.prototype.slice.call(n,0,i)),o[i]=n[i]);return t.concat(o||Array.prototype.slice.call(n))};Object.defineProperty(fn,"__esModule",{value:!0});var ls=me,Vn=ce,us=Ke,ds=Je,Mt=re,fs=5,ps=0,hs=3,vs=1e3,_s=5*1e3,ms={audioInputLevel:{minStandardDeviation:327.67,sampleCount:10},audioOutputLevel:{minStandardDeviation:327.67,sampleCount:10},bytesReceived:{clearCount:2,min:1,raiseCount:3,sampleCount:3},bytesSent:{clearCount:2,min:1,raiseCount:3,sampleCount:3},jitter:{max:30},mos:{min:3},packetsLostFraction:[{max:1},{clearValue:1,maxAverage:3,sampleCount:7}],rtt:{max:400}};function gs(t,n){return n.reduce(function(e,i){return e+=i>t?1:0},0)}function ys(t,n){return n.reduce(function(e,i){return e+=i<t?1:0},0)}function bs(t){if(t.length<=0)return null;var n=t.reduce(function(r,o){return r+o},0)/t.length,e=t.map(function(r){return Math.pow(r-n,2)}),i=Math.sqrt(e.reduce(function(r,o){return r+o},0)/e.length);return i}function ws(t){return t.reduce(function(n,e){return Vt(Vt([],n,!0),e,!0)},[])}var Ss=function(t){cs(n,t);function n(e){var i=t.call(this)||this;i._activeWarnings=new Map,i._currentStreaks=new Map,i._inputVolumes=[],i._outputVolumes=[],i._sampleBuffer=[],i._supplementalSampleBuffers={audioInputLevel:[],audioOutputLevel:[]},i._warningsEnabled=!0,e=e||{},i._getRTCStats=e.getRTCStats||ds.getRTCStats,i._mos=e.Mos||us.default,i._peerConnection=e.peerConnection,i._thresholds=Se(Se({},ms),e.thresholds);var r=Object.values(i._thresholds).map(function(o){return o.sampleCount}).filter(function(o){return!!o});return i._maxSampleCount=Math.max.apply(Math,Vt([fs],r,!1)),i._peerConnection&&i.enable(i._peerConnection),i}return n.prototype.addVolumes=function(e,i){this._inputVolumes.push(e),this._outputVolumes.push(i)},n.prototype.disable=function(){return this._sampleInterval&&(clearInterval(this._sampleInterval),delete this._sampleInterval),this},n.prototype.disableWarnings=function(){return this._warningsEnabled&&this._activeWarnings.clear(),this._warningsEnabled=!1,this},n.prototype.enable=function(e){if(e){if(this._peerConnection&&e!==this._peerConnection)throw new Vn.InvalidArgumentError("Attempted to replace an existing PeerConnection in StatsMonitor.enable");this._peerConnection=e}if(!this._peerConnection)throw new Vn.InvalidArgumentError("Can not enable StatsMonitor without a PeerConnection");return this._sampleInterval=this._sampleInterval||setInterval(this._fetchSample.bind(this),vs),this},n.prototype.enableWarnings=function(){return this._warningsEnabled=!0,this},n.prototype.hasActiveWarning=function(e,i){var r="".concat(e,":").concat(i);return!!this._activeWarnings.get(r)},n.prototype._addSample=function(e){var i=this._sampleBuffer;i.push(e),i.length>this._maxSampleCount&&i.splice(0,i.length-this._maxSampleCount)},n.prototype._clearWarning=function(e,i,r){var o="".concat(e,":").concat(i),c=this._activeWarnings.get(o);!c||Date.now()-c.timeRaised<_s||(this._activeWarnings.delete(o),this.emit("warning-cleared",Se(Se({},r),{name:e,threshold:{name:i,value:this._thresholds[e][i]}})))},n.prototype._createSample=function(e,i){var r=i&&i.totals.bytesSent||0,o=i&&i.totals.bytesReceived||0,c=i&&i.totals.packetsSent||0,y=i&&i.totals.packetsReceived||0,P=i&&i.totals.packetsLost||0,I=e.bytesSent-r,D=e.bytesReceived-o,v=e.packetsSent-c,p=e.packetsReceived-y,m=e.packetsLost-P,s=p+m,g=s>0?m/s*100:0,_=e.packetsReceived+e.packetsLost,d=_>0?e.packetsLost/_*100:100,u=typeof e.rtt=="number"||!i?e.rtt:i.rtt,R=this._inputVolumes.splice(0);this._supplementalSampleBuffers.audioInputLevel.push(R);var b=this._outputVolumes.splice(0);return this._supplementalSampleBuffers.audioOutputLevel.push(b),{audioInputLevel:Math.round((0,Mt.average)(R)),audioOutputLevel:Math.round((0,Mt.average)(b)),bytesReceived:D,bytesSent:I,codecName:e.codecName,jitter:e.jitter,mos:this._mos.calculate(u,e.jitter,i&&g),packetsLost:m,packetsLostFraction:g,packetsReceived:p,packetsSent:v,rtt:u,timestamp:e.timestamp,totals:{bytesReceived:e.bytesReceived,bytesSent:e.bytesSent,packetsLost:e.packetsLost,packetsLostFraction:d,packetsReceived:e.packetsReceived,packetsSent:e.packetsSent}}},n.prototype._fetchSample=function(){var e=this;this._getSample().then(function(i){e._addSample(i),e._raiseWarnings(),e.emit("sample",i)}).catch(function(i){e.disable(),e.emit("error",i)})},n.prototype._getSample=function(){var e=this;return this._getRTCStats(this._peerConnection).then(function(i){var r=null;return e._sampleBuffer.length&&(r=e._sampleBuffer[e._sampleBuffer.length-1]),e._createSample(i,r)})},n.prototype._raiseWarning=function(e,i,r){var o="".concat(e,":").concat(i);if(!this._activeWarnings.has(o)){this._activeWarnings.set(o,{timeRaised:Date.now()});var c=this._thresholds[e],y;if(Array.isArray(c)){var P=c.find(function(I){return i in I});P&&(y=P[i])}else y=this._thresholds[e][i];this.emit("warning",Se(Se({},r),{name:e,threshold:{name:i,value:y}}))}},n.prototype._raiseWarnings=function(){var e=this;this._warningsEnabled&&Object.keys(this._thresholds).forEach(function(i){return e._raiseWarningsForStat(i)})},n.prototype._raiseWarningsForStat=function(e){var i=this,r=Array.isArray(this._thresholds[e])?this._thresholds[e]:[this._thresholds[e]];r.forEach(function(o){var c=i._sampleBuffer,y=o.clearCount||ps,P=o.raiseCount||hs,I=o.sampleCount||i._maxSampleCount,D=c.slice(-I),v=D.map(function(h){return h[e]}),p=v.some(function(h){return typeof h>"u"||h===null});if(!p){var m;if(typeof o.max=="number"&&(m=gs(o.max,v),m>=P?i._raiseWarning(e,"max",{values:v,samples:D}):m<=y&&i._clearWarning(e,"max",{values:v,samples:D})),typeof o.min=="number"&&(m=ys(o.min,v),m>=P?i._raiseWarning(e,"min",{values:v,samples:D}):m<=y&&i._clearWarning(e,"min",{values:v,samples:D})),typeof o.maxDuration=="number"&&c.length>1){D=c.slice(-2);var s=D[0][e],g=D[1][e],_=i._currentStreaks.get(e)||0,d=s===g?_+1:0;i._currentStreaks.set(e,d),d>=o.maxDuration?i._raiseWarning(e,"maxDuration",{value:d}):d===0&&i._clearWarning(e,"maxDuration",{value:_})}if(typeof o.minStandardDeviation=="number"){var u=i._supplementalSampleBuffers[e];if(!u||u.length<o.sampleCount)return;u.length>o.sampleCount&&u.splice(0,u.length-o.sampleCount);var R=ws(u.slice(-I)),b=bs(R);if(typeof b!="number")return;b<o.minStandardDeviation?i._raiseWarning(e,"minStandardDeviation",{value:b}):i._clearWarning(e,"minStandardDeviation",{value:b})}[["maxAverage",function(h,w){return h>w}],["minAverage",function(h,w){return h<w}]].forEach(function(h){var w=h[0],L=h[1];if(typeof o[w]=="number"&&v.length>=I){var l=(0,Mt.average)(v);L(l,o[w])?i._raiseWarning(e,w,{values:v,samples:D}):L(l,o.clearValue||o[w])||i._clearWarning(e,w,{values:v,samples:D})}})}})},n}(ls.EventEmitter);fn.default=Ss;var $n;function pn(){if($n)return tt;$n=1;var t=H&&H.__extends||function(){var T=function(E,f){return T=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(S,a){S.__proto__=a}||function(S,a){for(var j in a)Object.prototype.hasOwnProperty.call(a,j)&&(S[j]=a[j])},T(E,f)};return function(E,f){if(typeof f!="function"&&f!==null)throw new TypeError("Class extends value "+String(f)+" is not a constructor or null");T(E,f);function S(){this.constructor=E}E.prototype=f===null?Object.create(f):(S.prototype=f.prototype,new S)}}(),n=H&&H.__assign||function(){return n=Object.assign||function(T){for(var E,f=1,S=arguments.length;f<S;f++){E=arguments[f];for(var a in E)Object.prototype.hasOwnProperty.call(E,a)&&(T[a]=E[a])}return T},n.apply(this,arguments)};Object.defineProperty(tt,"__esModule",{value:!0});var e=me,i=yt,r=Et(),o=ce,c=le,y=De,P=It,I=Ee,D=kt,v=fn,p=re,m=se,s={factor:1.1,jitter:.5,max:3e4,min:1},g=70,_=500,d=160,u=10,R=5e3,b={disconnect:!0,info:{code:31003,message:"Connection with Twilio was interrupted.",twilioError:new o.MediaErrors.ConnectionError}},h={packetsLostFraction:{max:"packet-loss",maxAverage:"packets-lost-fraction"}},w={audioInputLevel:"audio-input-level",audioOutputLevel:"audio-output-level",bytesReceived:"bytes-received",bytesSent:"bytes-sent",jitter:"jitter",mos:"mos",rtt:"rtt"},L={max:"high-",maxAverage:"high-",maxDuration:"constant-",min:"low-",minStandardDeviation:"constant-"},l=function(T){t(E,T);function E(f,S){var a=T.call(this)||this;a.parameters={},a._inputVolumeStreak=0,a._isAnswered=!1,a._isCancelled=!1,a._isRejected=!1,a._latestInputVolume=0,a._latestOutputVolume=0,a._log=new c.default("Call"),a._mediaStatus=E.State.Pending,a._messages=new Map,a._metricsSamples=[],a._options={MediaHandler:y.PeerConnection,MediaStream:null,enableImprovedSignalingErrorPrecision:!1,offerSdp:null,shouldPlayDisconnect:function(){return!0},voiceEventSidGenerator:D.generateVoiceEventSid},a._outputVolumeStreak=0,a._shouldSendHangup=!0,a._signalingStatus=E.State.Pending,a._soundcache=new Map,a._status=E.State.Pending,a._wasConnected=!1,a.toString=function(){return"[Twilio.Call instance]"},a._emitWarning=function(k,x,A,M,B,U){var Q=B?"-cleared":"-raised",K="".concat(k,"warning").concat(Q);if(!(x==="constant-audio-input-level"&&a.isMuted())){var X=B?"info":"warning";x==="constant-audio-output-level"&&(X="info");var Z={threshold:A};if(M&&(M instanceof Array?Z.values=M.map(function(fe){return typeof fe=="number"?Math.round(fe*100)/100:M}):Z.value=M),a._publisher.post(X,K,x,{data:Z},a),x!=="constant-audio-output-level"){var ae=B?"warning-cleared":"warning";a._log.debug("#".concat(ae),x),a.emit(ae,x,U&&!B?U:null)}}},a._onAck=function(k){var x=k.acktype,A=k.callsid,M=k.voiceeventsid;if(a.parameters.CallSid!==A){a._log.warn("Received ack from a different callsid: ".concat(A));return}x==="message"&&a._onMessageSent(M)},a._onAnswer=function(k){typeof k.reconnect=="string"&&(a._signalingReconnectToken=k.reconnect),!(a._isAnswered&&a._status!==E.State.Reconnecting)&&(a._setCallSid(k),a._isAnswered=!0,a._maybeTransitionToOpen())},a._onCancel=function(k){var x=k.callsid;a.parameters.CallSid===x&&(a._isCancelled=!0,a._publisher.info("connection","cancel",null,a),a._cleanupEventListeners(),a._mediaHandler.close(),a._status=E.State.Closed,a._log.debug("#cancel"),a.emit("cancel"),a._pstream.removeListener("cancel",a._onCancel))},a._onConnected=function(){a._log.info("Received connected from pstream"),a._signalingReconnectToken&&a._mediaHandler.version&&a._pstream.reconnect(a._mediaHandler.version.getSDP(),a.parameters.CallSid,a._signalingReconnectToken)},a._onHangup=function(k){if(a.status()!==E.State.Closed){if(k.callsid&&(a.parameters.CallSid||a.outboundConnectionId)){if(k.callsid!==a.parameters.CallSid&&k.callsid!==a.outboundConnectionId)return}else if(k.callsid)return;if(a._log.info("Received HANGUP from gateway"),k.error){var x=k.error.code,A=(0,o.getPreciseSignalingErrorByCode)(a._options.enableImprovedSignalingErrorPrecision,x),M=typeof A<"u"?new A(k.error.message):new o.GeneralErrors.ConnectionError("Error sent from gateway in HANGUP",k.error);a._log.error("Received an error from the gateway:",M),a._log.debug("#error",M),a.emit("error",M)}a._shouldSendHangup=!1,a._publisher.info("connection","disconnected-by-remote",null,a),a._disconnect(null,!0),a._cleanupEventListeners()}},a._onMediaFailure=function(k){var x=E.MediaFailure,A=x.ConnectionDisconnected,M=x.ConnectionFailed,B=x.IceGatheringFailed,U=x.LowBytes,Q=k===M||k===B;if(!(0,p.isChrome)(window,window.navigator)&&k===M)return a._mediaHandler.onerror(b);if(a._mediaStatus===E.State.Reconnecting){if(Q){if(Date.now()-a._mediaReconnectStartTime>s.max)return a._log.warn("Exceeded max ICE retries"),a._mediaHandler.onerror(b);try{a._mediaReconnectBackoff.backoff()}catch(fe){if(!(fe.message&&fe.message==="Backoff in progress."))throw fe}}return}var K=a._mediaHandler.version.pc,X=K&&K.iceConnectionState==="disconnected",Z=a._monitor.hasActiveWarning("bytesSent","min")||a._monitor.hasActiveWarning("bytesReceived","min");if(k===U&&X||k===A&&Z||Q){var ae=new o.MediaErrors.ConnectionError("Media connection failed.");a._log.warn("ICE Connection disconnected."),a._publisher.warn("connection","error",ae,a),a._publisher.info("connection","reconnecting",null,a),a._mediaReconnectStartTime=Date.now(),a._status=E.State.Reconnecting,a._mediaStatus=E.State.Reconnecting,a._mediaReconnectBackoff.reset(),a._mediaReconnectBackoff.backoff(),a._log.debug("#reconnecting"),a.emit("reconnecting",ae)}},a._onMediaReconnected=function(){a._mediaStatus===E.State.Reconnecting&&(a._log.info("ICE Connection reestablished."),a._mediaStatus=E.State.Open,a._signalingStatus===E.State.Open&&(a._publisher.info("connection","reconnected",null,a),a._log.debug("#reconnected"),a.emit("reconnected"),a._status=E.State.Open))},a._onMessageReceived=function(k){var x=k.callsid,A=k.content,M=k.contenttype,B=k.messagetype,U=k.voiceeventsid;if(a.parameters.CallSid!==x){a._log.warn("Received a message from a different callsid: ".concat(x));return}var Q={content:A,contentType:M,messageType:B,voiceEventSid:U};a._publisher.info("call-message",B,{content_type:M,event_type:"received",voice_event_sid:U},a),a._log.debug("#messageReceived",JSON.stringify(Q)),a.emit("messageReceived",Q)},a._onMessageSent=function(k){if(!a._messages.has(k)){a._log.warn("Received a messageSent with a voiceEventSid that doesn't exists: ".concat(k));return}var x=a._messages.get(k);a._messages.delete(k),a._publisher.info("call-message",x==null?void 0:x.messageType,{content_type:x==null?void 0:x.contentType,event_type:"sent",voice_event_sid:k},a),a._log.debug("#messageSent",JSON.stringify(x)),a.emit("messageSent",x)},a._onRinging=function(k){if(a._setCallSid(k),!(a._status!==E.State.Connecting&&a._status!==E.State.Ringing)){var x=!!k.sdp;a._status=E.State.Ringing,a._publisher.info("connection","outgoing-ringing",{hasEarlyMedia:x},a),a._log.debug("#ringing"),a.emit("ringing",x)}},a._onRTCSample=function(k){var x=n(n({},k),{inputVolume:a._latestInputVolume,outputVolume:a._latestOutputVolume});a._codec=x.codecName,a._metricsSamples.push(x),a._metricsSamples.length>=u&&a._publishMetrics(),a.emit("sample",k)},a._onSignalingError=function(k){var x=k.callsid,A=k.voiceeventsid,M=k.error;if(a.parameters.CallSid!==x){a._log.warn("Received an error from a different callsid: ".concat(x));return}if(A&&a._messages.has(A)){a._messages.delete(A),a._log.warn("Received an error while sending a message.",k),a._publisher.error("call-message","error",{code:M.code,message:M.message,voice_event_sid:A},a);var B=void 0,U=(0,o.getPreciseSignalingErrorByCode)(!!a._options.enableImprovedSignalingErrorPrecision,M.code);typeof U<"u"&&(B=new U(M)),B||(a._log.error("Unknown Call Message Error: ",M),B=new o.GeneralErrors.UnknownError(M.message,M)),a._log.debug("#error",M,B),a.emit("error",B)}},a._onSignalingReconnected=function(){a._signalingStatus===E.State.Reconnecting&&(a._log.info("Signaling Connection reestablished."),a._signalingStatus=E.State.Open,a._mediaStatus===E.State.Open&&(a._publisher.info("connection","reconnected",null,a),a._log.debug("#reconnected"),a.emit("reconnected"),a._status=E.State.Open))},a._onTransportClose=function(){a._log.error("Received transportClose from pstream"),a._log.debug("#transportClose"),a.emit("transportClose"),a._signalingReconnectToken?(a._status=E.State.Reconnecting,a._signalingStatus=E.State.Reconnecting,a._log.debug("#reconnecting"),a.emit("reconnecting",new o.SignalingErrors.ConnectionDisconnected)):(a._status=E.State.Closed,a._signalingStatus=E.State.Closed)},a._reemitWarning=function(k,x){var A=/^audio/.test(k.name)?"audio-level-":"network-quality-",M=L[k.threshold.name],B;k.name in h?B=h[k.name][k.threshold.name]:k.name in w&&(B=w[k.name]);var U=M+B;a._emitWarning(A,U,k.threshold.value,k.values||k.value,x,k)},a._reemitWarningCleared=function(k){a._reemitWarning(k,!0)},a._isUnifiedPlanDefault=f.isUnifiedPlanDefault,a._soundcache=f.soundcache,typeof f.onIgnore=="function"&&(a._onIgnore=f.onIgnore);var j=S&&S.twimlParams||{};a.customParameters=new Map(Object.entries(j).map(function(k){var x=k[0],A=k[1];return[x,String(A)]})),Object.assign(a._options,S),a._options.callParameters&&(a.parameters=a._options.callParameters),a._options.reconnectToken&&(a._signalingReconnectToken=a._options.reconnectToken),a._voiceEventSidGenerator=a._options.voiceEventSidGenerator||D.generateVoiceEventSid,a._direction=a.parameters.CallSid&&!a._options.reconnectCallSid?E.CallDirection.Incoming:E.CallDirection.Outgoing,a.parameters?a.callerInfo=a.parameters.StirStatus?{isVerified:a.parameters.StirStatus==="TN-Validation-Passed-A"}:null:a.callerInfo=null,a._mediaReconnectBackoff=new i.default(s),a._mediaReconnectBackoff.on("ready",function(){return a._mediaHandler.iceRestart()}),a.outboundConnectionId=$();var C=a._publisher=f.publisher;a._direction===E.CallDirection.Incoming?C.info("connection","incoming",null,a):C.info("connection","outgoing",{preflight:a._options.preflight,reconnect:!!a._options.reconnectCallSid},a);var V=a._monitor=new(a._options.StatsMonitor||v.default);return V.on("sample",a._onRTCSample),V.disableWarnings(),setTimeout(function(){return V.enableWarnings()},R),V.on("warning",function(k,x){(k.name==="bytesSent"||k.name==="bytesReceived")&&a._onMediaFailure(E.MediaFailure.LowBytes),a._reemitWarning(k,x)}),V.on("warning-cleared",function(k){a._reemitWarningCleared(k)}),a._mediaHandler=new a._options.MediaHandler(f.audioHelper,f.pstream,{MediaStream:a._options.MediaStream,RTCPeerConnection:a._options.RTCPeerConnection,codecPreferences:a._options.codecPreferences,dscp:a._options.dscp,forceAggressiveIceNomination:a._options.forceAggressiveIceNomination,isUnifiedPlan:a._isUnifiedPlanDefault,maxAverageBitrate:a._options.maxAverageBitrate}),a.on("volume",function(k,x){a._inputVolumeStreak=a._checkVolume(k,a._inputVolumeStreak,a._latestInputVolume,"input"),a._outputVolumeStreak=a._checkVolume(x,a._outputVolumeStreak,a._latestOutputVolume,"output"),a._latestInputVolume=k,a._latestOutputVolume=x}),a._mediaHandler.onaudio=function(k){a._log.debug("#audio"),a.emit("audio",k)},a._mediaHandler.onvolume=function(k,x,A,M){V.addVolumes(A/255*32767,M/255*32767),a.emit("volume",k,x)},a._mediaHandler.ondtlstransportstatechange=function(k){var x=k==="failed"?"error":"debug";a._publisher.post(x,"dtls-transport-state",k,null,a)},a._mediaHandler.onpcconnectionstatechange=function(k){var x="debug",A=a._mediaHandler.getRTCDtlsTransport();k==="failed"&&(x=A&&A.state==="failed"?"error":"warning"),a._publisher.post(x,"pc-connection-state",k,null,a)},a._mediaHandler.onicecandidate=function(k){var x=new P.IceCandidate(k).toPayload();a._publisher.debug("ice-candidate","ice-candidate",x,a)},a._mediaHandler.onselectedcandidatepairchange=function(k){var x=new P.IceCandidate(k.local).toPayload(),A=new P.IceCandidate(k.remote,!0).toPayload();a._publisher.debug("ice-candidate","selected-ice-candidate-pair",{local_candidate:x,remote_candidate:A},a)},a._mediaHandler.oniceconnectionstatechange=function(k){var x=k==="failed"?"error":"debug";a._publisher.post(x,"ice-connection-state",k,null,a)},a._mediaHandler.onicegatheringfailure=function(k){a._publisher.warn("ice-gathering-state",k,null,a),a._onMediaFailure(E.MediaFailure.IceGatheringFailed)},a._mediaHandler.onicegatheringstatechange=function(k){a._publisher.debug("ice-gathering-state",k,null,a)},a._mediaHandler.onsignalingstatechange=function(k){a._publisher.debug("signaling-state",k,null,a)},a._mediaHandler.ondisconnected=function(k){a._log.warn(k),a._publisher.warn("network-quality-warning-raised","ice-connectivity-lost",{message:k},a),a._log.debug("#warning","ice-connectivity-lost"),a.emit("warning","ice-connectivity-lost"),a._onMediaFailure(E.MediaFailure.ConnectionDisconnected)},a._mediaHandler.onfailed=function(k){a._onMediaFailure(E.MediaFailure.ConnectionFailed)},a._mediaHandler.onconnected=function(){a._status===E.State.Reconnecting&&a._onMediaReconnected()},a._mediaHandler.onreconnected=function(k){a._log.info(k),a._publisher.info("network-quality-warning-cleared","ice-connectivity-lost",{message:k},a),a._log.debug("#warning-cleared","ice-connectivity-lost"),a.emit("warning-cleared","ice-connectivity-lost"),a._onMediaReconnected()},a._mediaHandler.onerror=function(k){k.disconnect===!0&&a._disconnect(k.info&&k.info.message);var x=k.info.twilioError||new o.GeneralErrors.UnknownError(k.info.message);a._log.error("Received an error from MediaStream:",k),a._log.debug("#error",x),a.emit("error",x)},a._mediaHandler.onopen=function(){a._status===E.State.Open||a._status===E.State.Reconnecting||(a._status===E.State.Ringing||a._status===E.State.Connecting?(a.mute(a._mediaHandler.isMuted),a._mediaStatus=E.State.Open,a._maybeTransitionToOpen()):a._mediaHandler.close())},a._mediaHandler.onclose=function(){a._status=E.State.Closed,a._options.shouldPlayDisconnect&&a._options.shouldPlayDisconnect()&&!a._isCancelled&&!a._isRejected&&a._soundcache.get(r.default.SoundName.Disconnect).play(),V.disable(),a._publishMetrics(),!a._isCancelled&&!a._isRejected&&(a._log.debug("#disconnect"),a.emit("disconnect",a))},a._pstream=f.pstream,a._pstream.on("ack",a._onAck),a._pstream.on("cancel",a._onCancel),a._pstream.on("error",a._onSignalingError),a._pstream.on("ringing",a._onRinging),a._pstream.on("transportClose",a._onTransportClose),a._pstream.on("connected",a._onConnected),a._pstream.on("message",a._onMessageReceived),a.on("error",function(k){a._publisher.error("connection","error",{code:k.code,message:k.message},a),a._pstream&&a._pstream.status==="disconnected"&&a._cleanupEventListeners()}),a.on("disconnect",function(){a._cleanupEventListeners()}),a}return Object.defineProperty(E.prototype,"direction",{get:function(){return this._direction},enumerable:!1,configurable:!0}),Object.defineProperty(E.prototype,"codec",{get:function(){return this._codec},enumerable:!1,configurable:!0}),Object.defineProperty(E.prototype,"connectToken",{get:function(){var f=this,S=this._signalingReconnectToken,a=this.parameters&&this.parameters.CallSid?this.parameters.CallSid:void 0;if(!(!S||!a)){var j=this.customParameters&&typeof this.customParameters.keys=="function"?Array.from(this.customParameters.keys()).reduce(function(V,k){return V[k]=f.customParameters.get(k),V},{}):{},C=this.parameters||{};return btoa(encodeURIComponent(JSON.stringify({customParameters:j,parameters:C,signalingReconnectToken:S})))}},enumerable:!1,configurable:!0}),E.prototype._setInputTracksFromStream=function(f){return this._mediaHandler.setInputTracksFromStream(f)},E.prototype._setSinkIds=function(f){return this._mediaHandler._setSinkIds(f)},E.prototype.accept=function(f){var S=this;if(this._log.debug(".accept",f),this._status!==E.State.Pending){this._log.debug(".accept noop. status is '".concat(this._status,"'"));return}f=f||{};var a=f.rtcConfiguration||this._options.rtcConfiguration,j=f.rtcConstraints||this._options.rtcConstraints||{},C={audio:typeof j.audio<"u"?j.audio:!0};this._status=E.State.Connecting;var V=function(){if(S._status!==E.State.Connecting){S._cleanupEventListeners(),S._mediaHandler.close();return}var A=function(U){var Q=S._direction===E.CallDirection.Incoming?"accepted-by-local":"accepted-by-remote";S._publisher.info("connection",Q,null,S);var K=(0,I.getPreferredCodecInfo)(S._mediaHandler.version.getSDP()),X=K.codecName,Z=K.codecParams;S._publisher.info("settings","codec",{codec_params:Z,selected_codec:X},S),S._monitor.enable(U)},M=typeof S._options.getSinkIds=="function"&&S._options.getSinkIds();if(Array.isArray(M)&&S._mediaHandler._setSinkIds(M).catch(function(){}),S._pstream.addListener("hangup",S._onHangup),S._direction===E.CallDirection.Incoming)S._isAnswered=!0,S._pstream.on("answer",S._onAnswer),S._mediaHandler.answerIncomingCall(S.parameters.CallSid,S._options.offerSdp,a,A);else{var B=Array.from(S.customParameters.entries()).map(function(U){return"".concat(encodeURIComponent(U[0]),"=").concat(encodeURIComponent(U[1]))}).join("&");S._pstream.on("answer",S._onAnswer),S._mediaHandler.makeOutgoingCall(B,S._signalingReconnectToken,S._options.reconnectCallSid||S.outboundConnectionId,a,A)}};this._options.beforeAccept&&this._options.beforeAccept(this);var k=typeof this._options.getInputStream=="function"&&this._options.getInputStream(),x=k?this._mediaHandler.setInputTracksFromStream(k):this._mediaHandler.openDefaultDeviceWithConstraints(C);x.then(function(){S._publisher.info("get-user-media","succeeded",{data:{audioConstraints:C}},S),V()},function(A){var M;A.code===31208||["PermissionDeniedError","NotAllowedError"].indexOf(A.name)!==-1?(M=new o.UserMediaErrors.PermissionDeniedError,S._publisher.error("get-user-media","denied",{data:{audioConstraints:C,error:A}},S)):(M=new o.UserMediaErrors.AcquisitionFailedError,S._publisher.error("get-user-media","failed",{data:{audioConstraints:C,error:A}},S)),S._disconnect(),S._log.debug("#error",A),S.emit("error",M)})},E.prototype.disconnect=function(){this._log.debug(".disconnect"),this._disconnect()},E.prototype.getLocalStream=function(){return this._mediaHandler&&this._mediaHandler.stream},E.prototype.getRemoteStream=function(){return this._mediaHandler&&this._mediaHandler._remoteStream},E.prototype.ignore=function(){if(this._log.debug(".ignore"),this._status!==E.State.Pending){this._log.debug(".ignore noop. status is '".concat(this._status,"'"));return}this._status=E.State.Closed,this._mediaHandler.ignore(this.parameters.CallSid),this._publisher.info("connection","ignored-by-local",null,this),this._onIgnore&&this._onIgnore()},E.prototype.isMuted=function(){return this._mediaHandler.isMuted},E.prototype.mute=function(f){f===void 0&&(f=!0),this._log.debug(".mute",f);var S=this._mediaHandler.isMuted;this._mediaHandler.mute(f);var a=this._mediaHandler.isMuted;S!==a&&(this._publisher.info("connection",a?"muted":"unmuted",null,this),this._log.debug("#mute",a),this.emit("mute",a,this))},E.prototype.postFeedback=function(f,S){if(typeof f>"u"||f===null)return this._postFeedbackDeclined();if(!Object.values(E.FeedbackScore).includes(f))throw new o.InvalidArgumentError("Feedback score must be one of: ".concat(Object.values(E.FeedbackScore)));if(typeof S<"u"&&S!==null&&!Object.values(E.FeedbackIssue).includes(S))throw new o.InvalidArgumentError("Feedback issue must be one of: ".concat(Object.values(E.FeedbackIssue)));return this._publisher.info("feedback","received",{issue_name:S,quality_score:f},this,!0)},E.prototype.reject=function(){if(this._log.debug(".reject"),this._status!==E.State.Pending){this._log.debug(".reject noop. status is '".concat(this._status,"'"));return}this._isRejected=!0,this._pstream.reject(this.parameters.CallSid),this._mediaHandler.reject(this.parameters.CallSid),this._publisher.info("connection","rejected-by-local",null,this),this._cleanupEventListeners(),this._mediaHandler.close(),this._status=E.State.Closed,this._log.debug("#reject"),this.emit("reject")},E.prototype.sendDigits=function(f){var S=this;if(this._log.debug(".sendDigits",f),f.match(/[^0-9*#w]/))throw new o.InvalidArgumentError("Illegal character passed into sendDigits");var a=this._options.customSounds||{},j=[];f.split("").forEach(function(A){var M=A!=="w"?"dtmf".concat(A):"";M==="dtmf*"&&(M="dtmfs"),M==="dtmf#"&&(M="dtmfh"),j.push(M)});var C=function(){var A=j.shift();A&&(S._options.dialtonePlayer&&!a[A]?S._options.dialtonePlayer.play(A):S._soundcache.get(A).play()),j.length&&setTimeout(function(){return C()},200)};C();var V=this._mediaHandler.getOrCreateDTMFSender();function k(A){if(A.length){var M=A.shift();M&&M.length&&V.insertDTMF(M,d,g),setTimeout(k.bind(null,A),_)}}if(V){if(!("canInsertDTMF"in V)||V.canInsertDTMF){this._log.info("Sending digits using RTCDTMFSender"),k(f.split("w"));return}this._log.info("RTCDTMFSender cannot insert DTMF")}if(this._log.info("Sending digits over PStream"),this._pstream!==null&&this._pstream.status!=="disconnected")this._pstream.dtmf(this.parameters.CallSid,f);else{var x=new o.GeneralErrors.ConnectionError("Could not send DTMF: Signaling channel is disconnected");this._log.debug("#error",x),this.emit("error",x)}},E.prototype.sendMessage=function(f){this._log.debug(".sendMessage",JSON.stringify(f));var S=f.content,a=f.contentType,j=f.messageType;if(typeof S>"u"||S===null)throw new o.InvalidArgumentError("`content` is empty");if(typeof j!="string")throw new o.InvalidArgumentError("`messageType` must be a string.");if(j.length===0)throw new o.InvalidArgumentError("`messageType` must be a non-empty string.");if(this._pstream===null)throw new o.InvalidStateError("Could not send CallMessage; Signaling channel is disconnected");var C=this.parameters.CallSid;if(typeof this.parameters.CallSid>"u")throw new o.InvalidStateError("Could not send CallMessage; Call has no CallSid");var V=this._voiceEventSidGenerator();return this._messages.set(V,{content:S,contentType:a,messageType:j,voiceEventSid:V}),this._pstream.sendMessage(C,S,a,j,V),V},E.prototype.status=function(){return this._status},E.prototype._checkVolume=function(f,S,a,j){var C=S>=10,V=0;return a===f&&(V=S),V>=10?this._emitWarning("audio-level-","constant-audio-".concat(j,"-level"),10,V,!1):C&&this._emitWarning("audio-level-","constant-audio-".concat(j,"-level"),10,V,!0),V},E.prototype._cleanupEventListeners=function(){var f=this,S=function(){f._pstream&&(f._pstream.removeListener("ack",f._onAck),f._pstream.removeListener("answer",f._onAnswer),f._pstream.removeListener("cancel",f._onCancel),f._pstream.removeListener("error",f._onSignalingError),f._pstream.removeListener("hangup",f._onHangup),f._pstream.removeListener("ringing",f._onRinging),f._pstream.removeListener("transportClose",f._onTransportClose),f._pstream.removeListener("connected",f._onConnected),f._pstream.removeListener("message",f._onMessageReceived))};S(),setTimeout(S,0)},E.prototype._createMetricPayload=function(){var f={call_sid:this.parameters.CallSid,dscp:!!this._options.dscp,sdk_version:m.RELEASE_VERSION};return this._options.gateway&&(f.gateway=this._options.gateway),f.direction=this._direction,f},E.prototype._disconnect=function(f,S){if(f=typeof f=="string"?f:null,!(this._status!==E.State.Open&&this._status!==E.State.Connecting&&this._status!==E.State.Reconnecting&&this._status!==E.State.Ringing)){if(this._log.info("Disconnecting..."),this._pstream!==null&&this._pstream.status!=="disconnected"&&this._shouldSendHangup){var a=this.parameters.CallSid||this.outboundConnectionId;a&&this._pstream.hangup(a,f)}this._cleanupEventListeners(),this._mediaHandler.close(),S||this._publisher.info("connection","disconnected-by-local",null,this)}},E.prototype._maybeTransitionToOpen=function(){this._wasConnected,this._isAnswered&&(this._onSignalingReconnected(),this._signalingStatus=E.State.Open,this._mediaHandler&&this._mediaHandler.status==="open"&&(this._status=E.State.Open,this._wasConnected||(this._wasConnected=!0,this._log.debug("#accept"),this.emit("accept",this))))},E.prototype._postFeedbackDeclined=function(){return this._publisher.info("feedback","received-none",null,this,!0)},E.prototype._publishMetrics=function(){var f=this;this._metricsSamples.length!==0&&this._publisher.postMetrics("quality-metrics-samples","metrics-sample",this._metricsSamples.splice(0),this._createMetricPayload(),this).catch(function(S){f._log.warn("Unable to post metrics to Insights. Received error:",S)})},E.prototype._setCallSid=function(f){var S=f.callsid;S&&(this.parameters.CallSid=S,this._mediaHandler.callSid=S)},E.toString=function(){return"[Twilio.Call class]"},E}(e.EventEmitter);(function(T){(function(E){E.Closed="closed",E.Connecting="connecting",E.Open="open",E.Pending="pending",E.Reconnecting="reconnecting",E.Ringing="ringing"})(T.State||(T.State={})),function(E){E.AudioLatency="audio-latency",E.ChoppyAudio="choppy-audio",E.DroppedCall="dropped-call",E.Echo="echo",E.NoisyCall="noisy-call",E.OneWayAudio="one-way-audio"}(T.FeedbackIssue||(T.FeedbackIssue={})),function(E){E[E.One=1]="One",E[E.Two=2]="Two",E[E.Three=3]="Three",E[E.Four=4]="Four",E[E.Five=5]="Five"}(T.FeedbackScore||(T.FeedbackScore={})),function(E){E.Incoming="INCOMING",E.Outgoing="OUTGOING"}(T.CallDirection||(T.CallDirection={})),function(E){E.Opus="opus",E.PCMU="pcmu"}(T.Codec||(T.Codec={})),function(E){E.None="none",E.Timeout="timeout"}(T.IceGatheringFailureReason||(T.IceGatheringFailureReason={})),function(E){E.ConnectionDisconnected="ConnectionDisconnected",E.ConnectionFailed="ConnectionFailed",E.IceGatheringFailed="IceGatheringFailed",E.LowBytes="LowBytes"}(T.MediaFailure||(T.MediaFailure={}))})(l||(l={}));function $(){return"TJSxxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(T){var E=Math.random()*16|0,f=T==="x"?E:E&3|8;return f.toString(16)})}return tt.default=l,tt}(function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.TwilioError=t.Logger=t.PreflightTest=t.Device=t.Call=void 0;var n=pn();t.Call=n.default;var e=Et();t.Device=e.default;var i=le;Object.defineProperty(t,"Logger",{enumerable:!0,get:function(){return i.Logger}});var r=xi();Object.defineProperty(t,"PreflightTest",{enumerable:!0,get:function(){return r.PreflightTest}});var o=ce;t.TwilioError=o})(si);const Cs={class:"flex flex-row-reverse items-center gap-1"},ks={class:"flex flex-col items-center justify-center gap-3"},Ts={class:"flex flex-col items-center justify-center gap-1"},Es={class:"text-xl font-medium"},Is={class:"text-sm text-ink-gray-5"},Ps={key:0,class:"my-1 text-base"},xs={key:1,class:"my-1 text-base"},As={key:2,class:"flex gap-2"},Rs={key:3},Ds={key:4,class:"flex gap-2"},Ms={class:"flex items-center gap-2"},Os={class:"max-w-[120px] truncate"},Ls={key:0,class:"flex items-center gap-2"},js={class:"my-1 min-w-[40px] text-center"},Us={key:1,class:"flex items-center gap-3"},Ns={class:"my-1"},Fs={key:2,class:"flex items-center gap-2"},Vs={__name:"TwilioCallUI",setup(t,{expose:n}){let e="",i=G("Connecting..."),r=null,o=G(!1),c=G(!1),y=G(!1),P=G(!1),I=G(!1),D=G(null),v=G(null),p=G("");const m=G(""),s=G({full_name:"",image:"",mobile_no:""});ke(m,k=>{k&&g.fetch()});const g=pe({url:"crm.integrations.api.get_contact_by_phone_number",makeParams(){return{phone_number:m.value}},cache:["contact",m.value],onSuccess(k){s.value=k}}),_=G(!1),d=G({name:"",title:"",content:""});async function u(k,x=!1){d.value=k,x&&k.name&&await Ne("crm.integrations.api.add_note_to_call_log",{call_sid:r.parameters.CallSid,note:k})}const{width:R,height:b}=Gn();let{style:h}=zn(D,{initialValue:{x:R.value-280,y:b.value-310},preventDefault:!0});async function w(){i.value="Requesting Access Token...";try{const k=await Ne("crm.integrations.twilio.api.generate_access_token");i.value="Got a token.",L(k.token)}catch(k){i.value="An error occurred. "+k.message}}function L(k){e=new si.Device(k,{codecPreferences:["opus","pcmu"],fakeLocalDTMF:!0,enableRingingState:!0}),l(),e.register()}function l(){e.on("registered",()=>{i.value="Ready to make and receive calls!"}),e.on("unregistered",k=>{i.value="Logged out"}),e.on("error",k=>{i.value="Twilio.Device Error: "+k.message}),e.on("incoming",T),e.on("tokenWillExpire",async()=>{const k=await Ne("crm.integrations.twilio.api.generate_access_token");e.updateToken(k.token)})}function $(){r.isMuted()?(r.mute(!1),I.value=!1):(r.mute(),I.value=!0)}function T(k){i.value=`Incoming call from ${k.parameters.From}`,m.value=k.parameters.From,o.value=!0,r=k,r.on("accept",x=>{console.log("conn",x)}),k.on("cancel",a),k.on("disconnect",a),k.on("reject",a)}async function E(){i.value="Accepted incoming call.",y.value=!0,await r.accept(),v.value.start()}function f(){r.reject(),i.value="Rejected incoming call",o.value=!1,c.value==null?c=!1:c.value=!1,p.value="",I.value=!1}function S(){r.disconnect(),i.value="Hanging up incoming call",y.value=!1,p.value="",I.value=!1,d.value={name:"",title:"",content:""},v.value.stop()}function a(){i.value="Call ended from handle disconnected Incoming call.",o.value=!1,c.value==null?c=!1:c.value=!1,r=null,I.value=!1,y.value=!1,v.value.stop()}async function j(k){if(m.value=k,e){i.value=`Attempting to call ${k} ...`;try{r=await e.connect({params:{To:k}}),o.value=!0,p.value="initiating",$t("make_outgoing_call"),r.on("messageReceived",x=>{let A=x.content;p.value=A.CallStatus,i.value=`Call status: ${A.CallStatus}`,A.CallStatus=="in-progress"&&(i.value="Call in progress.",P.value=!1,y.value=!0,v.value.start())}),r.on("accept",()=>{i.value="Initiated call!",o.value=!0,P.value=!0,y.value=!1}),r.on("disconnect",x=>{i.value="Call ended from makeOutgoing call disconnect.",P.value=!1,y.value=!1,o.value=!1,c=!1,r=null,p.value="",I.value=!1,v.value.stop(),d.value={name:"",title:"",content:""}}),r.on("cancel",()=>{i.value="Call ended from makeOutgoing call cancel.",P.value=!1,y.value=!1,o.value=!1,c=!1,r=null,p.value="",I.value=!1,d.value={name:"",title:"",content:""},v.value.stop()})}catch(x){i.value=`Could not connect call: ${x.message}`}}else i.value="Unable to make call."}function C(){r.disconnect(),o.value=!1,c.value==null?c=!1:c.value=!1,P.value=!1,y.value=!1,p.value="",I.value=!1,d.value={name:"",title:"",content:""}}function V(){o.value=!o.value,c.value==null?c=!c:c.value=!c.value}return ke(()=>i.value,k=>{console.log(k)},{immediate:!0}),n({makeOutgoingCall:j,setup:w}),(k,x)=>{var M,B,U,Q,K,X;const A=ue("Button");return F(),q(Re,null,[dt(O("div",qi(Gi(k.$attrs)),[O("div",{ref_key:"callPopup",ref:D,class:"fixed z-20 flex w-60 cursor-move select-none flex-col rounded-lg bg-surface-gray-7 p-4 text-ink-gray-2 shadow-2xl",style:Jn(N(h))},[O("div",Cs,[W(oi,{class:"h-4 w-4 cursor-pointer",onClick:V})]),O("div",ks,[(M=s.value)!=null&&M.image?(F(),Y(N(He),{key:0,image:s.value.image,label:s.value.full_name,class:he(["relative flex !h-24 !w-24 items-center justify-center [&>div]:text-[30px]",N(y)||N(P)?"":"pulse"])},null,8,["image","label","class"])):ie("",!0),O("div",Ts,[O("div",Es,J(((B=s.value)==null?void 0:B.full_name)??k.__("Unknown")),1),O("div",Is,J((U=s.value)==null?void 0:U.mobile_no),1)]),W(ai,{ref_key:"counterUp",ref:v},{default:ne(()=>{var Z;return[N(y)?(F(),q("div",Ps,J((Z=N(v))==null?void 0:Z.updatedTime),1)):ie("",!0)]}),_:1},512),N(y)?ie("",!0):(F(),q("div",xs,J(N(p)=="initiating"?k.__("Initiating call..."):N(p)=="ringing"?k.__("Ringing..."):N(P)?k.__("Calling..."):k.__("Incoming call...")),1)),N(y)?(F(),q("div",As,[W(A,{icon:N(I)?"mic-off":"mic",class:"rounded-full",onClick:$},null,8,["icon"]),W(A,{class:"cursor-pointer rounded-full",tooltip:k.__("Add a note"),icon:ti,onClick:x[0]||(x[0]=Z=>_.value=!0)},null,8,["tooltip"]),W(A,{class:"rounded-full bg-surface-red-5 hover:bg-surface-red-6 rotate-[135deg] text-ink-white",tooltip:k.__("Hang up"),icon:we,onClick:S},null,8,["tooltip"])])):N(P)||N(p)=="initiating"?(F(),q("div",Rs,[W(A,{size:"md",variant:"solid",theme:"red",label:k.__("Cancel"),onClick:C,class:"rounded-lg text-ink-white",disabled:N(p)=="initiating"},{prefix:ne(()=>[W(we,{class:"rotate-[135deg]"})]),_:1},8,["label","disabled"])])):(F(),q("div",Ds,[W(A,{size:"md",variant:"solid",theme:"green",label:k.__("Accept"),class:"rounded-lg text-ink-white",iconLeft:we,onClick:E},null,8,["label"]),W(A,{size:"md",variant:"solid",theme:"red",label:k.__("Reject"),class:"rounded-lg text-ink-white",onClick:f},{prefix:ne(()=>[W(we,{class:"rotate-[135deg]"})]),_:1},8,["label"])]))])],4)],16),[[ft,N(o)]]),dt(O("div",Ve({class:"ml-2 flex cursor-pointer select-none items-center justify-between gap-3 rounded-lg bg-surface-gray-7 px-2 py-[7px] text-base text-ink-gray-2",onClick:V},k.$attrs),[O("div",Ms,[(Q=s.value)!=null&&Q.image?(F(),Y(N(He),{key:0,image:s.value.image,label:s.value.full_name,class:"relative flex !h-5 !w-5 items-center justify-center"},null,8,["image","label"])):ie("",!0),O("div",Os,J(((K=s.value)==null?void 0:K.full_name)??k.__("Unknown")),1)]),N(y)?(F(),q("div",Ls,[O("div",js,J((X=N(v))==null?void 0:X.updatedTime),1),W(A,{variant:"solid",theme:"red",class:"!h-6 !w-6 rounded-full rotate-[135deg] text-ink-white",icon:we,onClick:je(S,["stop"])})])):N(P)?(F(),q("div",Us,[O("div",Ns,J(N(p)=="ringing"?k.__("Ringing..."):k.__("Calling...")),1),W(A,{variant:"solid",theme:"red",class:"!h-6 !w-6 rounded-full rotate-[135deg] text-ink-white",icon:we,onClick:je(C,["stop"])})])):(F(),q("div",Fs,[W(A,{variant:"solid",theme:"green",class:"pulse relative !h-6 !w-6 rounded-full animate-pulse text-ink-white",tooltip:k.__("Accept call"),icon:we,onClick:je(E,["stop"])},null,8,["tooltip"]),W(A,{variant:"solid",theme:"red",class:"!h-6 !w-6 rounded-full rotate-[135deg] text-ink-white",tooltip:k.__("Reject call"),icon:we,onClick:je(f,["stop"])},null,8,["tooltip"])]))],16),[[ft,N(c)]]),W(sr,{modelValue:_.value,"onUpdate:modelValue":x[1]||(x[1]=Z=>_.value=Z),note:d.value,doctype:"CRM Call Log",onAfter:u},null,8,["modelValue","note"])],64)}}},$s=Te(Vs,[["__scopeId","data-v-ebf3a169"]]);const Bs={class:"h-[294px] text-base"},Hs={class:"flex flex-col gap-2"},Ws={class:"flex gap-2"},qs={class:"cursor-pointer text-ink-gray-9"},Gs={__name:"TaskPanel",props:{task:{type:Object,default:()=>({title:"",description:"",assigned_to:"",due_date:"",status:"Backlog",priority:"Low"})}},setup(t){const n=t,{users:e,getUser:i}=ze();function r(c){n.task.status=c}function o(c){n.task.priority=c}return(c,y)=>{var D,v;const P=ue("FormControl"),I=ue("Button");return F(),q("div",Bs,[W(P,{type:"text",variant:"ghost",class:"mb-2 title",modelValue:t.task.title,"onUpdate:modelValue":y[0]||(y[0]=p=>t.task.title=p),placeholder:c.__("Schedule a task...")},null,8,["modelValue","placeholder"]),W(N(Zn),{variant:"ghost",ref:"content","editor-class":"prose-sm h-[150px] text-ink-white overflow-auto",bubbleMenu:!0,content:t.task.description,onChange:y[1]||(y[1]=p=>t.task.description=p),placeholder:c.__("Add description...")},null,8,["content","placeholder"]),O("div",Hs,[O("div",Ws,[W(N(jt),{options:N(Zi)(r)},{default:ne(()=>[W(I,{label:t.task.status,class:"bg-surface-gray-6 text-ink-white hover:bg-surface-gray-5"},{prefix:ne(()=>[W(Xi,{status:t.task.status},null,8,["status"])]),_:1},8,["label"])]),_:1},8,["options"]),W(N(jt),{options:N(er)(o)},{default:ne(()=>[W(I,{label:t.task.priority,class:"bg-surface-gray-6 text-ink-white hover:bg-surface-gray-5"},{prefix:ne(()=>[W(Yi,{priority:t.task.priority},null,8,["priority"])]),_:1},8,["label"])]),_:1},8,["options"])]),W(ur,{class:"user",value:N(i)(t.task.assigned_to).full_name,doctype:"User",onChange:y[2]||(y[2]=p=>t.task.assigned_to=p),placeholder:c.__("John Doe"),filters:{name:["in",(v=(D=N(e).data)==null?void 0:D.crmUsers)==null?void 0:v.map(p=>p.name)]},hideMe:!0},{prefix:ne(()=>[W(yn,{class:"mr-2 !h-4 !w-4",user:t.task.assigned_to},null,8,["user"])]),"item-prefix":ne(({option:p})=>[W(yn,{class:"mr-2",user:p.value,size:"sm"},null,8,["user"])]),"item-label":ne(({option:p})=>[W(N(Lt),{text:p.value},{default:ne(()=>[O("div",qs,J(N(i)(p.value).full_name),1)]),_:2},1032,["text"])]),_:1},8,["value","placeholder","filters"]),W(N(or),{class:"datepicker w-36",modelValue:t.task.due_date,"onUpdate:modelValue":y[3]||(y[3]=p=>t.task.due_date=p),placeholder:c.__("01/04/2024 11:30 PM"),formatter:p=>N(tr)(p,"",!0,!0),"input-class":"border-none"},null,8,["modelValue","placeholder","formatter"])])])}}},zs=Te(Gs,[["__scopeId","data-v-27045562"]]);const Js={class:"flex justify-center items-center size-5 rounded-full bg-surface-gray-6 shrink-0 mr-1"},Qs={key:0},Ks={key:0},Xs={key:2},Zs={class:"flex gap-2 items-center truncate"},Ys={key:0,class:"flex items-center gap-3 truncate"},ec={key:1,class:"flex justify-center items-center size-7 rounded-full bg-surface-gray-6 shrink-0"},tc={class:"flex flex-col gap-1 text-base leading-4 overflow-hidden"},nc={class:"font-medium truncate"},ic={class:"text-ink-gray-6"},rc={key:0},oc={key:0},ac={key:2},sc={key:1},cc={key:0},lc={key:0},uc={key:2},dc={class:"flex"},fc={class:"body flex-1"},pc={key:0},hc={key:2,class:"flex items-center gap-3"},vc={key:1,class:"flex justify-center items-center size-8 rounded-full bg-surface-gray-6"},_c={key:2,class:"flex flex-col gap-1"},mc={class:"text-lg font-medium leading-5"},gc={class:"text-base text-ink-gray-6 leading-4"},yc={key:3,class:"text-lg font-medium leading-5"},bc={class:"footer flex justify-between gap-2"},wc={class:"flex gap-2"},Sc={__name:"ExotelCallUI",setup(t,{expose:n}){const{$socket:e}=Wt(),i=G(null),r=G(!1);let o=G(!1);function c(){r.value=!r.value,o.value==null?o=!o:o.value=!o.value}const{width:y,height:P}=Gn();let{style:I}=zn(i,{initialValue:{x:y.value-350,y:P.value-250},preventDefault:!0});const D=G(""),v=G(""),p=G(null),m=G(null),s=G({full_name:"",image:"",mobile_no:""}),g=pe({url:"crm.integrations.api.get_contact_by_phone_number",makeParams(){return{phone_number:v.value}},onSuccess(x){s.value=x}});ke(v,x=>{x&&g.fetch()},{immediate:!0});const _=G(!1),d=G({name:"",content:""}),u=G(!1);function R(){u.value=!u.value,w.value||$(u.value),u.value&&(w.value=!1)}function b(){pe({url:"crm.integrations.api.add_note_to_call_log",params:{call_sid:p.value.CallSid,note:d.value},auto:!0,onSuccess(x){d.value.name=x.name,Ae(()=>{_.value=!1})}})}const h=G({name:"",title:"",description:"",assigned_to:"",due_date:"",status:"Backlog",priority:"Low"}),w=G(!1);function L(){w.value=!w.value,u.value||$(w.value),w.value&&(u.value=!1)}function l(){pe({url:"crm.integrations.api.add_task_to_call_log",params:{call_sid:p.value.CallSid,task:h.value},auto:!0,onSuccess(x){h.value.name=x.name,Ae(()=>{_.value=!1})}})}ke([d,h],()=>_.value=!0,{deep:!0});function $(x){let A=i.value.parentElement,M=parseInt(A.style.top),B=0;B=x?M-224:M+224,B<0&&(B=10),A.style.top=B+"px"}function T(x){v.value=x,pe({url:"crm.integrations.exotel.handler.make_a_call",params:{to_number:v.value},auto:!0,onSuccess(A){p.value=A,console.log(A),D.value="Calling...",r.value=!0,o.value=!1},onError(A){Bt.error(A.messages[0])}})}function E(){e.on("exotel_call",x=>{p.value=x,console.log(x),D.value=k(x);const{user:A}=Hn();!r.value&&!o.value&&(x.AgentEmail&&x.AgentEmail==(A||A.value)?(v.value=x.CallFrom||x.From,r.value=!0):v.value=x.To)})}zi(()=>{e.off("exotel_call")});const f=Wn();function S(){s.value.deal?f.push({name:"Deal",params:{dealId:s.value.deal}}):s.value.lead&&f.push({name:"Lead",params:{leadId:s.value.lead}})}function a(){r.value=!1,o.value=!1,d.value={name:"",content:""},h.value={name:"",title:"",description:"",assigned_to:"",due_date:"",status:"Backlog",priority:"Low"}}function j(){d.value.content&&b(),h.value.title&&l()}function C(){d.value.content&&b(),h.value.title&&l()}const V=G("00:00");function k(x){if(x.EventType=="answered"&&x.Direction=="outbound-api"&&x.Status=="in-progress"&&x["Legs[0][Status]"]=="in-progress"&&x["Legs[1][Status]"]=="")return"Ringing...";if(x.EventType=="answered"&&x.Direction=="outbound-api"&&x.Status=="in-progress"&&x["Legs[1][Status]"]=="in-progress")return m.value.start(),"In progress";if(x.EventType=="terminal"&&x.Direction=="outbound-api"&&(x.Status=="no-answer"||x.Status=="busy")&&(x["Legs[1][Status]"]=="no-answer"||x["Legs[0][Status]"]=="no-answer"||x["Legs[1][Status]"]=="busy"||x["Legs[0][Status]"]=="busy"))return m.value.stop(),"No answer";if(x.EventType=="terminal"&&x.Direction=="outbound-api"&&x.Status=="completed")return m.value.stop(),V.value=m.value.getTime(parseInt(x["Legs[0][OnCallDuration]"])||parseInt(x.DialCallDuration)),"Call ended";if(x.EventType=="Dial"&&x.Direction=="incoming"&&x.Status=="busy")return v.value=x.From||x.CallFrom,"Incoming call";if(x.Direction=="incoming"&&x.CallType=="incomplete"&&x.DialCallStatus=="no-answer")return"No answer";if(x.Direction=="incoming"&&(x.CallType=="completed"||x.CallType=="client-hangup")&&(x.DialCallStatus=="completed"||x.DialCallStatus=="canceled"))return V.value=m.value.getTime(parseInt(x["Legs[0][OnCallDuration]"])||parseInt(x.DialCallDuration)),"Call ended"}return n({makeOutgoingCall:T,setup:E}),(x,A)=>{var M,B,U,Q,K,X,Z,ae,fe,hn,vn,_n,mn;return F(),q("div",null,[dt(O("div",{class:"ml-2 flex cursor-pointer select-none items-center justify-between gap-1 rounded-full bg-surface-gray-7 px-2 py-[7px] text-base text-ink-gray-2",onClick:c},[O("div",Js,[(M=s.value)!=null&&M.image?(F(),Y(N(He),{key:0,image:s.value.image,label:s.value.full_name,class:"!size-5"},null,8,["image","label"])):(F(),Y(At,{key:1,class:"size-3"}))]),O("span",null,J(((B=s.value)==null?void 0:B.full_name)??((U=s.value)==null?void 0:U.mobile_no)),1),A[3]||(A[3]=O("span",null,"·",-1)),D.value=="In progress"?(F(),q("div",Qs,J((Q=m.value)==null?void 0:Q.updatedTime),1)):D.value=="Call ended"||D.value=="No answer"?(F(),q("div",{key:1,class:he(["blink",{"text-red-700":D.value=="Call ended"||D.value=="No answer"}])},[O("span",null,J(x.__(D.value)),1),D.value=="Call ended"?(F(),q("span",Ks,[A[2]||(A[2]=O("span",null," · ",-1)),O("span",null,J(V.value),1)])):ie("",!0)],2)):(F(),q("div",Xs,J(x.__(D.value)),1))],512),[[ft,N(o)]]),dt(O("div",{class:"fixed z-20 w-[280px] min-h-44 flex gap-2 flex-col rounded-lg bg-surface-gray-7 p-4 pt-2.5 text-ink-gray-2 shadow-2xl",style:Jn(N(I)),onClick:A[1]||(A[1]=je(()=>{},["stop"]))},[O("div",{ref_key:"callPopupHeader",ref:i,class:"header flex items-center justify-between gap-1 text-base cursor-move select-none"},[O("div",Zs,[u.value||w.value?(F(),q("div",Ys,[(K=s.value)!=null&&K.image?(F(),Y(N(He),{key:0,image:s.value.image,label:s.value.full_name,class:"!size-7 shrink-0"},null,8,["image","label"])):(F(),q("div",ec,[W(At,{class:"size-3"})])),O("div",tc,[O("div",nc,J(((X=s.value)==null?void 0:X.full_name)??((Z=s.value)==null?void 0:Z.mobile_no)),1),O("div",ic,[D.value=="In progress"?(F(),q("div",rc,[O("span",null,J((ae=s.value)==null?void 0:ae.mobile_no),1),A[4]||(A[4]=O("span",null," · ",-1)),O("span",null,J((fe=m.value)==null?void 0:fe.updatedTime),1)])):D.value=="Call ended"||D.value=="No answer"?(F(),q("div",{key:1,class:he(["blink",{"text-red-700":D.value=="Call ended"||D.value=="No answer"}])},[O("span",null,J(x.__(D.value)),1),D.value=="Call ended"?(F(),q("span",oc,[A[5]||(A[5]=O("span",null," · ",-1)),O("span",null,J(V.value),1)])):ie("",!0)],2)):(F(),q("div",ac,J(x.__(D.value)),1))])])])):(F(),q("div",sc,[D.value=="In progress"?(F(),q("div",cc,J((hn=m.value)==null?void 0:hn.updatedTime),1)):D.value=="Call ended"||D.value=="No answer"?(F(),q("div",{key:1,class:he(["blink",{"text-red-700":D.value=="Call ended"||D.value=="No answer"}])},[O("span",null,J(x.__(D.value)),1),D.value=="Call ended"?(F(),q("span",lc,[A[6]||(A[6]=O("span",null," · ",-1)),O("span",null,J(V.value),1)])):ie("",!0)],2)):(F(),q("div",uc,J(x.__(D.value)),1))]))]),O("div",dc,[W(N(Ie),{onClick:c,class:"bg-surface-gray-7 text-ink-white hover:bg-surface-gray-6 shrink-0 cursor-pointer",tooltip:x.__("Minimize"),icon:oi,size:"md"},null,8,["tooltip"]),D.value=="Call ended"||D.value=="No answer"?(F(),Y(N(Ie),{key:0,onClick:a,class:"bg-surface-gray-7 text-ink-white hover:bg-surface-gray-6 shrink-0",icon:"x",size:"md"})):ie("",!0)])],512),O("div",fc,[u.value?(F(),q("div",pc,[W(N(Zn),{variant:"ghost",ref:"content","editor-class":"prose-sm h-[290px] text-ink-white overflow-auto mt-1",bubbleMenu:!0,content:d.value.content,onChange:A[0]||(A[0]=Fi=>d.value.content=Fi),placeholder:x.__("Take a note...")},null,8,["content","placeholder"])])):w.value?(F(),Y(zs,{key:1,ref:"taskRef",task:h.value},null,8,["task"])):(F(),q("div",hc,[(vn=s.value)!=null&&vn.image?(F(),Y(N(He),{key:0,image:s.value.image,label:s.value.full_name,class:"!size-8"},null,8,["image","label"])):(F(),q("div",vc,[W(At,{class:"size-4"})])),(_n=s.value)!=null&&_n.full_name?(F(),q("div",_c,[O("div",mc,J(s.value.full_name),1),O("div",gc,J(s.value.mobile_no),1)])):(F(),q("div",yc,J(s.value.mobile_no),1))]))]),O("div",bc,[O("div",wc,[W(N(Ie),{class:"bg-surface-gray-6 text-ink-white hover:bg-surface-gray-5",tooltip:x.__("Add a note"),size:"md",icon:ti,onClick:R},null,8,["tooltip"]),W(N(Ie),{class:"bg-surface-gray-6 text-ink-white hover:bg-surface-gray-5",size:"md",tooltip:x.__("Add a task"),icon:lr,onClick:L},null,8,["tooltip"]),s.value.deal||s.value.lead?(F(),Y(N(Ie),{key:0,class:"bg-surface-gray-6 text-ink-white hover:bg-surface-gray-5",size:"md",iconRight:cr,label:s.value.deal?x.__("Deal"):x.__("Lead"),onClick:S},null,8,["label"])):ie("",!0)]),(d.value.name||h.value.name)&&_.value?(F(),Y(N(Ie),{key:0,onClick:C,class:"bg-surface-white !text-ink-gray-9 hover:!bg-surface-gray-3",variant:"solid",label:x.__("Update"),size:"md"},null,8,["label"])):((mn=d.value)!=null&&mn.content&&d.value.content!="<p></p>"||h.value.title)&&!d.value.name&&!h.value.name?(F(),Y(N(Ie),{key:1,onClick:j,class:"bg-surface-white !text-ink-gray-9 hover:!bg-surface-gray-3",variant:"solid",label:x.__("Save"),size:"md"},null,8,["label"])):ie("",!0)])],4),[[ft,r.value]]),W(ai,{ref_key:"counterUp",ref:m},null,512)])}}},Cc=Te(Sc,[["__scopeId","data-v-eba80d27"]]),kc={class:"flex flex-col gap-4"},Tc={class:"flex flex-col gap-1"},Ec={key:0,class:"text-sm text-ink-gray-4"},Bl={__name:"CallUI",setup(t){const{setMakeCall:n}=Wt(),e=G(null),i=G(null),r=G("Twilio"),o=G(!1),c=G(!1),y=G("");function P(v){if(xt.value&&bn.value&&!Xe.value){y.value=v,c.value=!0;return}r.value=xt.value?"Twilio":"Exotel",Xe.value&&(r.value=Xe.value),y.value=v,I()}function I(){o.value&&r.value&&D(),r.value==="Twilio"&&e.value.makeOutgoingCall(y.value),r.value==="Exotel"&&i.value.makeOutgoingCall(y.value),c.value=!1}async function D(){await Ne("crm.integrations.api.set_default_calling_medium",{medium:r.value}),Xe.value=r.value,Bt.success(__("Default calling medium set successfully to {0}",[r.value]))}return ke([xt,bn],([v,p])=>Ae(()=>{v&&(e.value.setup(),r.value="Twilio"),p&&(i.value.setup(),r.value="Exotel"),(v||p)&&(r.value="Twilio",n(P))}),{immediate:!0}),(v,p)=>{const m=ue("Dialog");return F(),q(Re,null,[W($s,{ref_key:"twilio",ref:e},null,512),W(Cc,{ref_key:"exotel",ref:i},null,512),W(m,{modelValue:c.value,"onUpdate:modelValue":p[3]||(p[3]=s=>c.value=s),options:{title:v.__("Make call"),actions:[{label:v.__("Call using {0}",[r.value]),variant:"solid",onClick:I}]}},{"body-content":ne(()=>[O("div",kc,[W(N(Pt),{type:"text",modelValue:y.value,"onUpdate:modelValue":p[0]||(p[0]=s=>y.value=s),label:v.__("Mobile Number")},null,8,["modelValue","label"]),W(N(Pt),{type:"select",modelValue:r.value,"onUpdate:modelValue":p[1]||(p[1]=s=>r.value=s),label:v.__("Calling Medium"),options:["Twilio","Exotel"]},null,8,["modelValue","label"]),O("div",Tc,[W(N(Pt),{type:"checkbox",modelValue:o.value,"onUpdate:modelValue":p[2]||(p[2]=s=>o.value=s),label:v.__("Make {0} as default calling medium",[r.value])},null,8,["modelValue","label"]),o.value?(F(),q("div",Ec,J(v.__("You can change the default calling medium from the settings")),1)):ie("",!0)])])]),_:1},8,["modelValue","options"])],64)}}},Ic={class:"lucide lucide-lock-keyhole",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"};function Pc(t,n){return F(),q("svg",Ic,[...n[0]||(n[0]=[O("circle",{cx:"12",cy:"16",r:"1"},null,-1),O("rect",{x:"3",y:"10",width:"18",height:"12",rx:"2"},null,-1),O("path",{d:"M7 10V7a5 5 0 0 1 10 0v3"},null,-1)])])}const Bn=Ce({name:"lucide-lock-keyhole",render:Pc}),xc={class:"flex flex-col gap-4"},Ac={key:0,class:"text-sm text-ink-gray-5 mt-2"},Rc={class:"flex justify-between items-center"},Dc={__name:"ChangePasswordModal",props:{modelValue:{},modelModifiers:{}},emits:["update:modelValue"],setup(t){const n=$e(t,"modelValue"),{getUser:e}=ze(),{updateOnboardingStep:i}=dr("frappecrm"),r=G(""),o=G(""),c=G(""),y=G(""),P=G(""),I=pe({url:"frappe.client.set_value",makeParams(){return{doctype:"User",name:e().name,fieldname:"new_password",value:r.value}},onSuccess:()=>{i("setup_your_password"),Bt.success(__("Password updated successfully")),n.value=!1,r.value="",o.value="",P.value=""},onError:v=>{P.value=v.messages[0]||__("Failed to update password")}});function D(v){return/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/.test(v)}return ke([r,o],()=>{y.value="",c.value="",r.value.length<8?c.value="Password must be at least 8 characters":D(r.value)||(c.value="Password must contain uppercase, lowercase, number, and symbol"),o.value.length&&r.value!==o.value?y.value="Passwords do not match":r.value===o.value&&r.value.length&&o.value.length&&(y.value="Passwords match")}),(v,p)=>{const m=ue("ErrorMessage"),s=ue("Button");return F(),Y(N(Qn),{modelValue:n.value,"onUpdate:modelValue":p[3]||(p[3]=g=>n.value=g),options:{title:v.__("Change Password")}},{"body-content":ne(()=>[O("div",xc,[O("div",null,[W(wn,{modelValue:r.value,"onUpdate:modelValue":p[0]||(p[0]=g=>r.value=g),placeholder:v.__("New Password")},{prefix:ne(()=>[W(N(Bn),{class:"size-4 text-ink-gray-4"})]),_:1},8,["modelValue","placeholder"]),c.value?(F(),q("p",Ac,J(c.value),1)):ie("",!0)]),O("div",null,[W(wn,{modelValue:o.value,"onUpdate:modelValue":p[1]||(p[1]=g=>o.value=g),placeholder:v.__("Confirm Password")},{prefix:ne(()=>[W(N(Bn),{class:"size-4 text-ink-gray-4"})]),_:1},8,["modelValue","placeholder"]),y.value?(F(),q("p",{key:0,class:he(["text-sm text-ink-gray-5 mt-2",y.value==="Passwords match"?"text-ink-green-3":"text-ink-red-3"])},J(y.value),3)):ie("",!0)])])]),actions:ne(()=>[O("div",Rc,[O("div",null,[W(m,{message:P.value},null,8,["message"])]),W(s,{variant:"solid",label:v.__("Update"),disabled:!r.value||!o.value||r.value!==o.value,loading:N(I).loading,onClick:p[2]||(p[2]=g=>N(I).submit())},null,8,["label","disabled","loading"])])]),_:1},8,["modelValue","options"])}}},Mc={class:"bg-surface-modal px-4 pb-6 pt-5 sm:px-6"},Oc={class:"mb-5 flex items-center justify-between"},Lc={class:"text-2xl font-semibold leading-6 text-ink-gray-9"},jc={class:"flex items-center gap-1"},Uc={key:0},Nc={class:"px-4 pb-7 pt-4 sm:px-6"},Fc={class:"space-y-2"},Vc={__name:"CreateDocumentModal",props:pt({doctype:{type:String,required:!0},data:{type:Object,default:()=>({})}},{modelValue:{},modelModifiers:{}}),emits:pt(["callback"],["update:modelValue"]),setup(t,{emit:n}){const e=t,i=n,{isManager:r}=ze(),o=$e(t,"modelValue"),c=G(!1),y=G(null),{document:P,triggerOnBeforeCreate:I}=ei(e.doctype),D=qe(()=>{let s=e.doctype;(s.startsWith("CRM ")||s.startsWith("FCRM "))&&(s=s.replace(/^(CRM |FCRM )/,""));let g=__("New {0}",[s]),_="xl",d=[{label:__("Create"),variant:"solid",onClick:()=>p()}];return{title:g,size:_,actions:d}}),v=pe({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_fields_layout",cache:["QuickEntry",e.doctype],params:{doctype:e.doctype,type:"Quick Entry"},auto:!0});async function p(){c.value=!0,y.value=null,await(I==null?void 0:I());let s=await Ne("frappe.client.insert",{doc:{doctype:e.doctype,...P.doc}},{onError:g=>{var _;c.value=!1,g.error&&(y.value=(_=g.error.messages)==null?void 0:_[0])}});c.value=!1,o.value=!1,i("callback",s)}ke(()=>o.value,s=>{s&&Ae(()=>{P.doc={...e.data}})});function m(){Ue.value=!0,Ht.value={doctype:e.doctype},Ae(()=>o.value=!1)}return(s,g)=>{const _=ue("Button"),d=ue("Dialog");return F(),Y(d,{modelValue:o.value,"onUpdate:modelValue":g[1]||(g[1]=u=>o.value=u),options:D.value},{body:ne(()=>[O("div",Mc,[O("div",Oc,[O("div",null,[O("h3",Lc,J(s.__(D.value.title)||s.__("Untitled")),1)]),O("div",jc,[N(r)()&&!N(Ge)?(F(),Y(_,{key:0,variant:"ghost",class:"w-7",tooltip:s.__("Edit fields layout"),icon:Yn,onClick:m},null,8,["tooltip"])):ie("",!0),W(_,{variant:"ghost",class:"w-7",icon:"x",onClick:g[0]||(g[0]=u=>o.value=!1)})])]),N(v).data?(F(),q("div",Uc,[W(qt,{tabs:N(v).data,data:N(P).doc,doctype:t.doctype},null,8,["tabs","data","doctype"]),W(N(Kn),{class:"mt-2",message:y.value},null,8,["message"])])):ie("",!0)]),O("div",Nc,[O("div",Fc,[(F(!0),q(Re,null,mt(D.value.actions,u=>(F(),Y(_,Ve({class:"w-full",key:u.label},{ref_for:!0},u,{label:s.__(u.label),loading:c.value}),null,16,["label","loading"]))),128))])])]),_:1},8,["modelValue","options"])}}},$c={class:"flex items-center gap-2 text-2xl font-semibold leading-6 text-ink-gray-9"},Bc={class:"flex flex-col gap-3"},Hc={class:"flex justify-between gap-2"},Wc={class:"flex flex-row-reverse gap-2"},qc={key:0},Gc={__name:"QuickEntryModal",props:pt({doctype:{type:String,default:"CRM Lead"},onlyRequired:{type:Boolean,default:!1}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(t){const n=t,e=$e(t,"modelValue"),i=G(n.doctype),r=G(!1),o=G(!1),c=G(!1);function y(){let v=n.onlyRequired?"Required Fields":"Quick Entry";return{doctype:i.value,type:v}}const P=pe({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_fields_layout",cache:["QuickEntryModal",i.value,n.onlyRequired],params:y(),onSuccess(v){P.originalData=JSON.parse(JSON.stringify(v))}});ke(()=>P==null?void 0:P.data,()=>{o.value=JSON.stringify(P==null?void 0:P.data)!==JSON.stringify(P==null?void 0:P.originalData)},{deep:!0}),Xn(()=>Ji(I,100)());function I(){Ae(()=>{P.params=y(),P.reload()})}function D(){let v=JSON.parse(JSON.stringify(P.data));v.forEach(m=>{m.sections&&m.sections.forEach(s=>{s.columns.forEach(g=>{g.fields&&(g.fields=g.fields.map(_=>_.fieldname))})})}),r.value=!0;let p=n.onlyRequired?"Required Fields":"Quick Entry";Ne("crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.save_fields_layout",{doctype:i.value,type:p,layout:JSON.stringify(v)}).then(()=>{r.value=!1,e.value=!1,$t("quick_entry_layout_builder",{doctype:i.value})})}return(v,p)=>{const m=ue("Button");return F(),Y(N(Qn),{modelValue:e.value,"onUpdate:modelValue":p[1]||(p[1]=s=>e.value=s),options:{size:"4xl"}},{"body-title":ne(()=>[O("h3",$c,[O("div",null,J(v.__("Edit Quick Entry Layout")),1),o.value?(F(),Y(N(Qi),{key:0,label:v.__("Not Saved"),variant:"subtle",theme:"orange"},null,8,["label"])):ie("",!0)])]),"body-content":ne(()=>{var s;return[O("div",Bc,[O("div",Hc,[W(m,{label:c.value?v.__("Hide preview"):v.__("Show preview"),onClick:p[0]||(p[0]=g=>c.value=!c.value)},null,8,["label"]),O("div",Wc,[W(m,{loading:r.value,label:v.__("Save"),variant:"solid",onClick:D},null,8,["loading","label"]),W(m,{label:v.__("Reset"),onClick:I},null,8,["label"])])]),(s=N(P))!=null&&s.data?(F(),q("div",qc,[c.value?(F(),Y(qt,{key:1,tabs:N(P).data,data:{},preview:!0},null,8,["tabs"])):(F(),Y(fr,{key:0,tabs:N(P).data,doctype:i.value,onlyRequired:t.onlyRequired},null,8,["tabs","doctype","onlyRequired"]))])):ie("",!0)])]}),_:1},8,["modelValue"])}}},zc={class:"bg-surface-modal px-4 pb-6 pt-5 sm:px-6"},Jc={class:"mb-5 flex items-center justify-between"},Qc={class:"text-2xl font-semibold leading-6 text-ink-gray-9"},Kc={class:"flex items-center gap-1"},Xc={key:0},Zc={class:"px-4 pb-7 pt-4 sm:px-6"},Yc={class:"space-y-2"},el={__name:"AddressModal",props:pt({address:{type:String,default:""},options:{type:Object,default:{afterInsert:()=>{}}}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(t){const n=t,{isManager:e}=ze(),i=$e(t,"modelValue"),r=G(!1),o=G(null);G(null);const c=G(!1),{document:y,triggerOnBeforeCreate:P}=ei("Address",n.address||""),I=qe(()=>{var b;let d=c.value?__((b=y.doc)==null?void 0:b.address_title):__("New Address"),u="xl",R=[{label:c.value?__("Save"):__("Create"),variant:"solid",onClick:()=>c.value?p():m()}];return{title:d,size:u,actions:R}}),D=pe({url:"crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_fields_layout",cache:["QuickEntry","Address"],params:{doctype:"Address",type:"Quick Entry"},auto:!0}),v={onSuccess:d=>{r.value=!1,g(d)},onError:d=>{if(r.value=!1,d.exc_type=="MandatoryError"){const u=d.messages.map(R=>{let b=R.split(": ");return b[b.length-1].trim()}).join(", ");o.value=__("These fields are required: {0}",[u]);return}o.value=d}};async function p(){r.value=!0,await y.save.submit(null,v)}async function m(){r.value=!0,o.value=null,await(P==null?void 0:P()),await s.submit({doc:{doctype:"Address",...y.doc}})}const s=pe({url:"frappe.client.insert",onSuccess(d){r.value=!1,d.name&&($t("address_created"),g(d))},onError(d){r.value=!1,o.value=d}});function g(d){i.value=!1,n.options.afterInsert&&n.options.afterInsert(d)}Xn(()=>{c.value=!!n.address,n.address||(y.doc={address_type:"Billing"})});function _(){Ue.value=!0,Ht.value={doctype:"Address"},Ae(()=>{i.value=!1})}return(d,u)=>{const R=ue("Button"),b=ue("Dialog");return F(),Y(b,{modelValue:i.value,"onUpdate:modelValue":u[1]||(u[1]=h=>i.value=h),options:I.value},{body:ne(()=>[O("div",zc,[O("div",Jc,[O("div",null,[O("h3",Qc,J(d.__(I.value.title)||d.__("Untitled")),1)]),O("div",Kc,[N(e)()&&!N(Ge)?(F(),Y(R,{key:0,tooltip:d.__("Edit fields layout"),variant:"ghost",icon:Yn,class:"w-7",onClick:_},null,8,["tooltip"])):ie("",!0),W(R,{icon:"x",variant:"ghost",class:"w-7",onClick:u[0]||(u[0]=h=>i.value=!1)})])]),N(D).data&&N(y).doc?(F(),q("div",Xc,[W(qt,{tabs:N(D).data,data:N(y).doc,doctype:"Address"},null,8,["tabs","data"]),W(N(Kn),{class:"mt-2",message:o.value},null,8,["message"])])):ie("",!0)]),O("div",Zc,[O("div",Yc,[(F(!0),q(Re,null,mt(I.value.actions,h=>(F(),Y(R,Ve({class:"w-full",key:h.label},{ref_for:!0},h,{label:d.__(h.label),loading:r.value}),null,16,["label","loading"]))),128))])])]),_:1},8,["modelValue","options"])}}},tl={class:"lucide lucide-globe",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"};function nl(t,n){return F(),q("svg",tl,[...n[0]||(n[0]=[O("circle",{cx:"12",cy:"12",r:"10"},null,-1),O("path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"},null,-1),O("path",{d:"M2 12h20"},null,-1)])])}const il=Ce({name:"lucide-globe",render:nl}),rl={class:"lucide lucide-github",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"};function ol(t,n){return F(),q("svg",rl,[...n[0]||(n[0]=[O("path",{d:"M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"},null,-1),O("path",{d:"M9 18c-4.51 2-5-2-7-2"},null,-1)])])}const al=Ce({name:"lucide-github",render:ol}),sl={class:"lucide lucide-headset",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"};function cl(t,n){return F(),q("svg",sl,[...n[0]||(n[0]=[O("path",{d:"M3 11h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5Zm0 0a9 9 0 1 1 18 0m0 0v5a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3Z"},null,-1),O("path",{d:"M21 16v2a4 4 0 0 1-4 4h-5"},null,-1)])])}const ll=Ce({name:"lucide-headset",render:cl}),ul={class:"lucide lucide-bug",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"};function dl(t,n){return F(),q("svg",ul,[...n[0]||(n[0]=[Ki('<path d="m8 2 1.88 1.88"></path><path d="M14.12 3.88 16 2"></path><path d="M9 7.13v-1a3.003 3.003 0 1 1 6 0v1"></path><path d="M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6"></path><path d="M12 20v-9"></path><path d="M6.53 9C4.6 8.8 3 7.1 3 5"></path><path d="M6 13H2"></path><path d="M3 21c0-2.1 1.7-3.9 3.8-4"></path><path d="M20.97 5c0 2.1-1.6 3.8-3.5 4"></path><path d="M22 13h-4"></path><path d="M17.2 17c2.1.1 3.8 1.9 3.8 4"></path>',11)])])}const fl=Ce({name:"lucide-bug",render:dl}),pl={class:"lucide lucide-book-open",xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"};function hl(t,n){return F(),q("svg",pl,[...n[0]||(n[0]=[O("path",{d:"M12 7v14"},null,-1),O("path",{d:"M3 18a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h5a4 4 0 0 1 4 4 4 4 0 0 1 4-4h5a1 1 0 0 1 1 1v13a1 1 0 0 1-1 1h-6a3 3 0 0 0-3 3 3 3 0 0 0-3-3z"},null,-1)])])}const vl=Ce({name:"lucide-book-open",render:hl}),_l={},ml={viewBox:"0 0 64 64",xmlns:"http://www.w3.org/2000/svg","stroke-width":"3",stroke:"currentColor",fill:"none"};function gl(t,n){return F(),q("svg",ml,[...n[0]||(n[0]=[O("g",{id:"SVGRepo_tracerCarrier","stroke-linecap":"round","stroke-linejoin":"round"},null,-1),O("g",{id:"SVGRepo_iconCarrier"},[O("path",{d:"M26.67,38.57l-.82,11.54A2.88,2.88,0,0,0,28.14,49l5.5-5.26,11.42,8.35c2.08,1.17,3.55.56,4.12-1.92l7.49-35.12h0c.66-3.09-1.08-4.33-3.16-3.55l-44,16.85C6.47,29.55,6.54,31.23,9,32l11.26,3.5L45.59,20.71c1.23-.83,2.36-.37,1.44.44Z","stroke-linecap":"round"})],-1)])])}const yl=Te(_l,[["render",gl]]),bl={class:"p-4 pt-5"},wl={class:"flex justify-center"},Sl={class:"flex flex-col items-center"},Cl=["href"],kl={class:"text-base text-ink-gray-8"},Tl={__name:"AboutModal",props:{modelValue:{},modelModifiers:{}},emits:["update:modelValue"],setup(t){let n=$e(t,"modelValue"),e=[{label:__("Website"),url:"https://frappe.io/crm",icon:il},{label:__("GitHub Repository"),url:"https://github.com/frappe/crm",icon:al},{label:__("Documentation"),url:"https://docs.frappe.io/crm",icon:vl},{label:__("Telegram Channel"),url:"https://t.me/frappecrm",icon:yl},{label:__("Report an Issue"),url:"https://github.com/frappe/crm/issues",icon:fl},{label:__("Contact Support"),url:"https://support.frappe.io",icon:ll}];return(i,r)=>{const o=ue("Dialog");return F(),Y(o,{modelValue:N(n),"onUpdate:modelValue":r[0]||(r[0]=c=>Pe(n)?n.value=c:n=c),options:{size:"sm"}},{body:ne(()=>[O("div",bl,[O("div",wl,[O("div",Sl,[W(ni,{class:"mb-3 size-12"}),r[1]||(r[1]=O("h3",{class:"font-semibold text-xl text-ink-gray-9"},"Frappe CRM",-1))])]),r[2]||(r[2]=O("hr",{class:"border-t my-3 mx-2"},null,-1)),O("div",null,[(F(!0),q(Re,null,mt(N(e),c=>(F(),q("a",{key:c.label,class:"flex py-2 px-2 hover:bg-surface-gray-1 rounded cursor-pointer",target:"_blank",href:c.url},[c.icon?(F(),Y(qn(c.icon),{key:0,class:"size-4 mr-2 text-ink-gray-7"})):ie("",!0),O("span",kl,J(c.label),1)],8,Cl))),128))]),r[3]||(r[3]=O("hr",{class:"border-t my-3 mx-2"},null,-1)),r[4]||(r[4]=O("p",{class:"text-sm text-ink-gray-6 px-2 mt-2"}," © Frappe Technologies Pvt. Ltd. and contributors ",-1))])]),_:1},8,["modelValue"])}}},Hl={__name:"GlobalModals",setup(t){return(n,e)=>(F(),q(Re,null,[N(et)?(F(),Y(Vc,{key:0,modelValue:N(et),"onUpdate:modelValue":e[0]||(e[0]=i=>Pe(et)?et.value=i:null),doctype:N(pr),data:N(hr),onCallback:e[1]||(e[1]=i=>N(vr)(i))},null,8,["modelValue","doctype","data"])):ie("",!0),N(Ue)?(F(),Y(Gc,Ve({key:1,modelValue:N(Ue),"onUpdate:modelValue":e[2]||(e[2]=i=>Pe(Ue)?Ue.value=i:null)},N(Ht)),null,16,["modelValue"])):ie("",!0),N(Ze)?(F(),Y(el,Ve({key:2,modelValue:N(Ze),"onUpdate:modelValue":e[3]||(e[3]=i=>Pe(Ze)?Ze.value=i:null)},N(ar)),null,16,["modelValue"])):ie("",!0),N(Ye)?(F(),Y(Dc,{key:3,modelValue:N(Ye),"onUpdate:modelValue":e[4]||(e[4]=i=>Pe(Ye)?Ye.value=i:null)},null,8,["modelValue"])):ie("",!0),W(Tl,{modelValue:N(at),"onUpdate:modelValue":e[5]||(e[5]=i=>Pe(at)?at.value=i:null)},null,8,["modelValue"])],64))}};export{ni as C,Vl as _,$l as a,Bl as b,Hl as c,Dc as d};
//# sourceMappingURL=GlobalModals-27983ae7.js.map
